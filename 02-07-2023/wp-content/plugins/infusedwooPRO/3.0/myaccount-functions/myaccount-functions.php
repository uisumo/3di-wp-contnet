<?php  if(!is_admin())add_action('init','iw_enable_inf_cc_control',10,1);add_action('wp_ajax_iw_userdelete_cc','iw_userdelete_cc');add_action('wp_ajax_nopriv_iw_userdelete_cc','iw_userdelete_cc');add_action('wp_ajax_iw_changesub_cc','iw_changesub_cc');add_action('wp_ajax_nopriv_iw_changesub_cc','iw_changesub_cc');add_action('wp_ajax_iw_cancelsub','iw_cancelsub');add_action('wp_ajax_nopriv_iw_cancelsub','iw_cancelsub');add_action('wp_head','iw_my_account_enqueue');add_filter('woocommerce_account_menu_items','iw_my_account_menu');add_filter('woocommerce_account_iw-subscriptions_endpoint','iw_account_subscriptions_endpoint');add_filter('woocommerce_get_query_vars','iw_account_subscriptions_query_vars',0);add_action('after_switch_theme','iw_custom_flush_rewrite_rules');function iw_account_subscriptions_query_vars($vars){$vars['iw-subscriptions']='iw-subscriptions';return $vars;}function iw_custom_flush_rewrite_rules(){flush_rewrite_rules();}function iw_enable_inf_cc_control($iwpro){$gateways=WC()->payment_gateways->get_available_payment_gateways();$enabled=false;if($gateways)foreach($gateways as $gateway){if($gateway->id =='infusionsoft_cc'){$enabled=$gateway->enabled =='yes';}}if($enabled){add_filter('woocommerce_saved_payment_methods_list','iw_display_infusionsoft_cards',10,2);}}function iw_display_infusionsoft_cards($payment_methods,$user_id){global $iwpro;$displayed_cc=isset($payment_methods['cc'])?$payment_methods['cc']:array();$wp_user=get_user_by('id',$user_id);$user_email=$wp_user->user_email;if($ccs=$iwpro->ia_get_creditcards($user_email)){foreach($ccs as $cc){$displayed_cc[]=array('method' =>array('gateway' =>'infusionsoft_cc','last4' =>$cc['Last4'],'brand' =>$cc['CardType'],),'expires' =>$cc['ExpirationMonth'].'/'.substr($cc['ExpirationYear'],-2),'actions' =>array(array('url' =>admin_url('admin-ajax.php?action=iw_userdelete_cc&id='.$cc['Id']),'name' =>__('Delete','woocommerce'))),);}}$payment_methods['cc']=$displayed_cc;return $payment_methods;}function iw_userdelete_cc(){if(is_user_logged_in()){global $iwpro;$ccs=$iwpro->ia_get_creditcards();foreach($ccs as $cc){if($cc['Id']==$_GET['id']){$iwpro->app->deactivateCreditCard($cc['Id']);$user_id=get_current_user_id();do_action('iw_userdelete_cc',$cc['Id'],$user_id);wc_add_notice(__("Successfully removed {$cc['CardType']} ending in {$cc['Last4']}",'woocommerce'));break;}}}header('Location: '.$_SERVER['HTTP_REFERER']);exit();}function iw_changesub_cc(){if(is_user_logged_in()){global $iwpro;$user_id=get_current_user_id();$wp_user=get_user_by('id',$user_id);$user_email=$wp_user->user_email;$ccs=$iwpro->ia_get_creditcards($user_email);$subs=$iwpro->ia_get_recurring_orders($user_email);$changed=false;foreach($subs as $s){if($s['Id']==$_GET['sid']){foreach($ccs as $cc){if($cc['Id']==$_GET['cc1']){$iwpro->app->dsUpdate('RecurringOrder',(int) $_GET['sid'],array('CC1' =>(int) $cc['Id']));wc_add_notice(__("Successfully updated the subscription's billing method.",'woocommerce'));$changed=true;break;}if($cc['Id']==$_GET['cc2']){$iwpro->app->dsUpdate('RecurringOrder',(int) $_GET['sid'],array('CC2' =>(int) $cc['Id']));wc_add_notice(__("Successfully updated the subscription's backup payment method.",'woocommerce'));do_action('infusedwoo_user_sub_changed_card',(int) $_GET['sid'],(int) $cc['Id']);$changed=true;break;}}}}}header('Location: '.get_permalink(wc_get_page_id('myaccount'))."/iw-subscriptions/?sid=".$_GET['sid']);exit();}function iw_cancelsub(){if(is_user_logged_in()){global $iwpro;$user_id=get_current_user_id();$wp_user=get_user_by('id',$user_id);$user_email=$wp_user->user_email;$subs=$iwpro->ia_get_recurring_orders($user_email);$changed=false;$iwpro->ia_app_connect();foreach($subs as $s){if($s['Id']==$_GET['sid']){$iwpro->app->dsUpdate('RecurringOrder',(int) $_GET['sid'],array('Status' =>'Inactive'));wc_add_notice(__("Successfully cancelled subscription",'woocommerce'));do_action('infusedwoo_user_cancelled_sub',(int) $_GET['sid']);}}}header('Location: '.get_permalink(wc_get_page_id('myaccount'))."/iw-subscriptions/?sid=".$_GET['sid']);exit();}function iw_my_account_menu($menuOrder){$iw_subs_settings=get_option('iw_sub_settings',array());if(!isset($iw_subs_settings['myacct_show'])||!$iw_subs_settings['myacct_show'])return $menuOrder;$new_menu=array();foreach($menuOrder as $m =>$v){$new_menu[$m]=$v;if($m =='orders')$new_menu['iw-subscriptions']=__('Subscriptions','woocommerce');}return $new_menu;}function iw_my_account_enqueue(){if(function_exists('is_account_page')&&is_account_page()): ?> <style type="text/css"> .woocommerce-MyAccount-navigation ul li.woocommerce-MyAccount-navigation-link--iw-subscriptions a:before { content: '\f01e'; } </style>	<?php endif;}function iw_account_subscriptions_endpoint(){global $iwpro;$iw_subs_settings=get_option('iw_sub_settings',array());if(!isset($iw_subs_settings['myacct_show'])||!$iw_subs_settings['myacct_show'])return false;$user_id=get_current_user_id();$wp_user=get_user_by('id',$user_id);$user_email=$wp_user->user_email;$subs=$iwpro->ia_get_recurring_orders($user_email);$subs_filtered=array();foreach($subs as $s){if(!$iw_subs_settings['inactive_show']&&$s['Status']!='Active')continue;if($iw_subs_settings['show_to_some']){if(!in_array($s['SubscriptionPlanId'],explode(",",$iw_subs_settings['show_to'])))continue;}$subs_filtered[$s['Id']]=$s;}if(isset($_GET['sid'])){if(isset($_GET['cancel'])){$msg=apply_filters("iw_sub_cancel_confirm_message","Are you sure you want to cancel this subscription?");echo $msg; ?> <br><br> <a href="<?php echo admin_url('admin-ajax.php?action=iw_cancelsub&sid='.$_GET['sid']); ?>" class="button 0 alert">Cancel Subscription</a> <br><br> <hr /> <?php }if(!isset($subs_filtered[$_GET['sid']]))return false;$s=$subs_filtered[$_GET['sid']]; ?> <section class="woocommerce-order-details"> <h2 class="woocommerce-order-details__title"><?php _e('Subscription','woocommerce') ?> #<?php echo $_GET['sid']; ?></h2> <table class="woocommerce-table woocommerce-table--order-details shop_table order_details"> <thead> <tr> <th class="woocommerce-table__product-name product-name"></th> <th class="woocommerce-table__product-table product-total"></th> </tr> </thead> <tbody> <tr class="woocommerce-table__line-item order_item"> <td class="woocommerce-table__product-name product-name"> <?php  $product=$iwpro->app->dsLoad('Product',(int) $s['ProductId'],array('ProductName'));echo isset($product['ProductName'])?$product['ProductName']:""; ?> </td> <td class="woocommerce-table__product-total product-total"> <?php if(!$iw_subs_settings['prices_show']): ?> <?php  $stringCycle='';switch($s['BillingCycle']){case  1:$stringCycle='year';break;case  2:$stringCycle='month';break;case  3:$stringCycle='week';break;case  6:$stringCycle='day';break;}$addS='';if($s['Frequency']>1)$addS='s';$stringCycle=__("{$stringCycle}{$addS}",'woocommerce');if($s['Frequency']==1)$freq='';else $freq="{$s['Frequency']} ";$nsub=$iwpro->app->dsLoad('SubscriptionPlan',$s['SubscriptionPlanId'],array('NumberOfCycles'));$ncycles=isset($nsub['NumberOfCycles'])?$nsub['NumberOfCycles']:0;$ncycle_str="";if($ncycles>0){$naddS=$ncycles>1?'s':'';$ncycle_str=" for $ncycles {$stringCycle}";}echo wc_price($s['BillingAmt'])." / {$freq}{$stringCycle}{$ncycle_str}"; ?> <?php endif; ?> </td> </tr> <tr> <th scope="row"><?php _e('Status','woocommerce') ?>:</th> <td><b><?php echo $s['Status'] ?></b></td> </tr> <tr> <th scope="row"><?php _e('Subscription Start Date','woocommerce') ?>:</th> <td><?php echo date("F j, Y",strtotime($s['StartDate'])); ?></td> </tr> <tr> <th scope="row"><?php _e('Next Bill Date','woocommerce') ?>:</th> <td><?php echo date("F j, Y",strtotime($s['NextBillDate'])); ?></td> </tr> <?php if(isset($s['EndDate'])&&$s['EndDate']): ?> <tr> <th scope="row"><?php _e('Subscription End Date','woocommerce') ?>:</th> <td><?php echo date("F j, Y",strtotime($s['EndDate'])); ?></td> </tr> <?php endif; ?> </tbody> <tr> <td scope="row">&nbsp;</td> <td> &nbsp; </td> </tr> <tfoot> <?php  $ccs=$iwpro->ia_get_creditcards($user_email); ?> <tr> <th scope="row"><?php _e('Billing Method','woocommerce') ?>:</th> <td> <select name="main_cc" onchange="change_cc1(this, '<?php echo $s['Id']; ?>')"> <option disabled selected value>-- Select a Credit Card --</option> <?php foreach($ccs as $cc): ?> <option <?php if($cc['Id']==$s['CC1'])echo "selected"  ?> value="<?php echo $cc['Id']; ?>"><?php echo $cc['CardType']." ending in ".$cc['Last4']; ?></option> <?php endforeach; ?> <option value="addnew"><?php _e('Add a new Credit Card...','woocommerce') ?></option> </select> </td> </tr> <!--<tr> <th scope="row"><?php _e('Backup Billing Method','woocommerce') ?>:</th> <td> <select name="backup_cc" onchange="change_cc2(this, '<?php echo $s['Id']; ?>')"> <option disabled selected value>-- <?php _e('Select a Credit Card','woocommerce') ?> --</option> <?php foreach($ccs as $cc):if($cc['Id']!=$s['CC1']): ?> <option <?php if($cc['Id']==$s['CC2'])echo "selected"  ?> value="<?php echo $cc['Id']; ?>"><?php echo $cc['CardType']." ending in ".$cc['Last4']; ?></option> <?php endif;endforeach; ?> <option value="addnew"><?php _e('Add a new Credit Card...','woocommerce') ?></option> </select> </td> </tr>--> <?php if(isset($iw_subs_settings['cancel_show'])&&$iw_subs_settings['cancel_show']&&$s['Status']=='Active'): ?> <tr> <th scope="row"><?php _e('Cancel Subscription','woocommerce') ?>:</th> <td> <a href="?sid=<?php echo $s['Id'] ?>&cancel=1"><?php _e('Click here to cancel the subscription','woocommerce') ?></a> </td> </tr> <?php endif; ?> </tfoot> </table> <script> function change_cc1(cardselected, sub) { if(cardselected.value == 'addnew') location.href = "<?php echo get_permalink(wc_get_page_id('myaccount')) ?>/add-payment-method?cc1sid=" + sub; else { location.href = '<?php echo admin_url('admin-ajax.php') ?>?action=iw_changesub_cc&sid=' + sub + '&cc1=' + cardselected.value; } } function change_cc2(cardselected, sub) { if(cardselected.value == 'addnew') location.href = "<?php echo get_permalink(wc_get_page_id('myaccount')) ?>/add-payment-method?cc2sid=" + sub; else { location.href = '<?php echo admin_url('admin-ajax.php') ?>?action=iw_changesub_cc&sid=' + sub + '&cc2=' + cardselected.value; } } </script> <?php  return true;} ?>	<table class="woocommerce-orders-table woocommerce-MyAccount-orders shop_table shop_table_responsive my_account_orders account-orders-table"> <thead> <tr> <th class="woocommerce-orders-table__header woocommerce-orders-table__header-order-number"><span class="nobr">ID</span></th> <th class="woocommerce-orders-table__header woocommerce-orders-table__header-order-status"><span class="nobr"><?php _e('Subscription','woocommerce') ?></span></th> <th class="woocommerce-orders-table__header woocommerce-orders-table__header-order-date"><span class="nobr"><?php _e('Status','woocommerce') ?></span></th> <?php if(!$iw_subs_settings['prices_show']): ?> <th class="woocommerce-orders-table__header woocommerce-orders-table__header-order-total"><span class="nobr"><?php _e('Recurring Amount','woocommerce') ?></span></th> <?php endif; ?> <th class="woocommerce-orders-table__header woocommerce-orders-table__header-order-actions"><span class="nobr"><?php _e('Actions','woocommerce') ?></span></th> </tr> </thead> <tbody> <?php foreach($subs_filtered as $s): ?> <tr class="woocommerce-orders-table__row woocommerce-orders-table__row--status-processing order"> <td class="woocommerce-orders-table__cell woocommerce-orders-table__cell-order-number" data-title="Order"> <a href="?sid=<?php echo $s['Id'] ?>"> #<?php echo $s['Id'] ?> </a> </td> <td class="woocommerce-orders-table__cell woocommerce-orders-table__cell-order-date" data-title="Date"> <?php  $product=$iwpro->app->dsLoad('Product',(int) $s['ProductId'],array('ProductName'));echo isset($product['ProductName'])?$product['ProductName']:""; ?> </td> <td class="woocommerce-orders-table__cell woocommerce-orders-table__cell-order-status" data-title="Status"> <?php echo $s['Status'] ?> </td> <?php if(!$iw_subs_settings['prices_show']): ?> <td class="woocommerce-orders-table__cell woocommerce-orders-table__cell-order-total" data-title="Total"> <?php  $stringCycle='';switch($s['BillingCycle']){case  1:$stringCycle='year';break;case  2:$stringCycle='month';break;case  3:$stringCycle='week';break;case  6:$stringCycle='day';break;}$addS='';if($s['Frequency']>1)$addS='s';$stringCycle=__("{$stringCycle}{$addS}",'woocommerce');if($s['Frequency']==1)$freq='';else $freq="{$s['Frequency']} ";$nsub=$iwpro->app->dsLoad('SubscriptionPlan',$s['SubscriptionPlanId'],array('NumberOfCycles'));$ncycles=isset($nsub['NumberOfCycles'])?$nsub['NumberOfCycles']:0;$ncycle_str="";if($ncycles>0){$naddS=$ncycles>1?'s':'';$ncycle_str=" for $ncycles {$stringCycle}";}echo wc_price($s['BillingAmt'])." / {$freq}{$stringCycle}{$ncycle_str}"; ?> </td> <?php endif; ?> <td class="woocommerce-orders-table__cell woocommerce-orders-table__cell-order-actions" data-title="Actions"> <a href="?sid=<?php echo $s['Id'] ?>" class="woocommerce-button button view"><?php _e('View','woocommerce'); ?></a>  </td> </tr> <?php endforeach; ?> </tbody>	</table>	<?php }