(()=>{const e=window.ko;!function(o){window.GPNestedForms=function(t){var r=this;for(const e in t)t.hasOwnProperty(e)&&(r[e]=t[e]);r.init=function(){if(r.initSession(),void 0!==window["GPNestedForms_{0}_{1}".format(r.formId,r.fieldId)]){var i=window["GPNestedForms_{0}_{1}".format(r.formId,r.fieldId)];r.entries=i.entries,gform.removeFilter("gform_calculation_formula",10,"gpnf_{0}_{1}".format(r.formId,r.fieldId)),r.viewModel=i.viewModel}r.parentFormContainer=o("#gform_wrapper_"+r.formId),r.fieldContainer=o("#field_"+r.formId+"_"+r.fieldId),r.modalElem=o(".gpnf-nested-form-"+r.formId+"-"+r.fieldId),r.editDialogElem=o(".gpnf-edit-form-"+r.formId+"-"+r.fieldId),r.formHtml=r.getFormHtml(),r.entriesInput=o("#input_"+r.formId+"_"+r.fieldId),r.scrollY=0,r.modalArgs=gform.applyFilters("gpnf_modal_args",{autoOpen:!1,modal:!0,width:r.modalWidth<o(document).width()?r.modalWidth:o(document).width()-40,height:r.modalHeight,title:r.modalTitle,closeText:"Close",buttons:{},position:r.getPosition(),dialogClass:r.modalClass,draggable:!1,resizable:!1,close:function(e,n){r.modalDialog.html(""),r.editDialog.html(""),o(".ui-widget-overlay").removeClass(r.modalClass),window.scroll(0,r.scrollY)},open:function(){r.modalHeaderColor&&(r.modalDialog.siblings(".ui-dialog-titlebar").css("background-color",r.modalHeaderColor),r.editDialog.siblings(".ui-dialog-titlebar").css("background-color",r.modalHeaderColor)),o(".ui-widget-overlay").addClass(r.modalClass),r.hasConditionalLogic?o(document).on("gform_post_conditional_logic",(function(e,o){r.nestedFormId==o&&r.repositionModals()})):r.repositionModals()}},r.formId,r.fieldId,r),o.fn.button.noConflict&&(o.fn.bootstrapBtn=o.fn.button.noConflict()),r.modalDialog=r.modalElem.dialog(r.modalArgs),r.editDialog=r.editDialogElem.dialog(o.extend({},r.modalArgs,{title:r.editModalTitle})),r.isBound(r.fieldContainer[0])||(r.viewModel=new n(r.prepareEntriesForKnockout(r.entries),r),e.applyBindings(r.viewModel,r.fieldContainer[0])),o(document).on("click","#field_"+r.formId+"_"+r.fieldId+" .gpnf-add-entry",(function(e){e.preventDefault(),r.scrollY=window.scrollY?window.scrollY:window.pageYOffset,r.modalElem.html(r.formHtml),r.modalDialog.dialog("open"),r.initFormScripts(),r.modalElem.find('input[name="gpnf_nested_form_field_id"]').val(r.fieldId)})),o(document).bind("gpnf_post_render",(function(e,n,i){var t=o("#gform_wrapper_"+n);n==r.nestedFormId&&t.length>0&&o(document).trigger("gform_post_render",[r.nestedFormId,i]),r.handleParentMergeTag(),r.repositionModals()})),o(window).resize((function(){r.repositionModals()})),gform.addFilter("gform_calculation_formula",r.parseCalcs,10,"gpnf_{0}_{1}".format(r.formId,r.fieldId)),r.runCalc(r.formId),r.parentFormContainer.data("GPNestedForms_"+r.fieldId,r),window["GPNestedForms_{0}_{1}".format(r.formId,r.fieldId)]=r},r.initSession=function(){o.post(r.ajaxUrl,r.sessionData,(function(e){}))},r.repositionModals=function(){var e=r.getPosition(r.modalDialog);e.dnr||r.modalDialog.dialog("option","position",e),(e=r.getPosition(r.editDialog)).dnr||r.editDialog.dialog("option","position",e)},r.getPosition=function(e){if(!e)return{my:"center",at:"center",of:window};var n=o(window).height(),i=e.parents(".ui-dialog").height(),t="center",r=window,d=!1;return i>=n?(t="center top",r=window,e.data("do-not-reposition")?d=!0:e.data("do-not-reposition",!0)):e.data("do-not-reposition",!1),{my:t,at:t,of:r,dnr:d}},r.isBound=function(o){return!!e.dataFor(o)},r.prepareEntriesForKnockout=function(e){for(var o=0;o<e.length;o++)e[o]=r.prepareEntryForKnockout(e[o]);return e},r.prepareEntryForKnockout=function(e){var n=o.extend({},e);for(var i in n)if(e.hasOwnProperty(i)){var t=e[i];!1===t.label&&(t.label=""),e["f"+i]=t}return e},r.refreshMarkup=function(){o.post(r.ajaxUrl,{action:"gpnf_refresh_markup",nonce:GPNFData.nonces.refreshMarkup,gpnf_parent_form_id:r.formId,gpnf_nested_form_field_id:r.fieldId},(function(e){r.formHtml=e}))},r.editEntry=function(e,n){var t=new i(n,r.spinnerUrl,"");n.css({visibility:"hidden"}),o.post(r.ajaxUrl,{action:"gpnf_edit_entry",nonce:GPNFData.nonces.editEntry,gpnf_entry_id:e,gpnf_parent_form_id:r.formId,gpnf_nested_form_field_id:r.fieldId},(function(e){t.destroy(),n.css({visibility:"visible"}),r.scrollY=window.scrollY?window.scrollY:window.pageYOffset,r.editDialog.html(e).dialog("open"),r.initFormScripts()}))},r.deleteEntry=function(e,n){var t=new i(n,r.spinnerUrl,"");n.css({visibility:"hidden"}),o.post(r.ajaxUrl,{action:"gpnf_delete_entry",nonce:GPNFData.nonces.deleteEntry,gpnf_entry_id:e.id},(function(o){t.destroy(),n.css({visibility:"visible"}),o?o.success?(r.viewModel.entries.remove(e),r.refreshMarkup()):console.log("Error:"+o.data):console.log("Error: no response.")}))},r.getFormHtml=function(){var e=r.modalElem.data("formHtml");return e||(e=r.modalElem.html()),r.modalElem.data("formHtml",e),r.modalElem.html(""),e},r.handleParentMergeTag=function(){r.modalElem.find(":input").each((function(){var e=o(this),n=e.data("gpnf-value");if(e.data("gpnf-changed"))return!0;if(!n)return!0;var i=/{Parent:(\d+(\.\d+)?)}/gi.exec(n);if(!i)return!0;var t=i[1];if(isNaN(t))return!0;var d=r.parentFormContainer.find("#input_"+r.formId+"_"+t.split(".").join("_"));d.hasClass("gfield_radio")&&(d=d.find("input:checked"));var a=o(this).val(),l=gform.applyFilters("gpnf_parent_merge_tag_value",d.val(),t,r.formId,r);a!=l&&o(this).val(l).change(),o(this).on("change",(function(){o(this).data("gpnf-changed",!0)}))}))},r.initFormScripts=function(e){window.gform.doAction("gpnf_init_nested_form",r.nestedFormId),o(document).trigger("gform_post_render",[r.nestedFormId,1]),window.gformInitDatepicker&&gformInitDatepicker(),r.handleParentMergeTag()},r.runCalc=function(){o(document).trigger("gform_post_conditional_logic",[r.formId,[],!1])},r.parseCalcs=function(e,n,i,t){var d=getMatchGroups(e,/{[^{]*?:([0-9]+):(sum|total|count)=?([0-9]*)}/i);return o.each(d,(function(o,n){var i=n[0],t=n[1],d=n[2],a=n[3],l=0;if(t==r.fieldId){switch(d){case"sum":var s=0;r.viewModel.entries().forEach((function(e){var o=0;void 0!==e[a]&&(o=e[a].value?e[a].value:0),s+=parseFloat(o)})),l=s;break;case"total":s=0,r.viewModel.entries().forEach((function(e){s+=parseFloat(e.total)})),l=s;break;case"count":l=r.viewModel.entries().length}e=e.replace(i,l)}})),e},GPNestedForms.loadEntry=function(e){var n=o("#gform_wrapper_"+e.formId).data("GPNestedForms_"+e.fieldId);const i=n.prepareEntryForKnockout(e.fieldValues);if(i.id=e.entryId,"edit"==e.mode){var t=o('table.gpnf-nested-entries [data-entryid="'+i.id+'"]').index();n.viewModel.entries.remove((function(e){return e.id==i.id})),n.viewModel.entries.splice(t,0,i),n.editDialog.dialog("close")}else n.modalDialog.dialog("close"),n.viewModel.entries.push(i),n.refreshMarkup()},r.init()};var n=function(n,i){var t=this;t.entries=e.observableArray(n),t.entries.subscribe((function(){i.parentFormContainer.children("form").trigger("change")})),t.isMaxed=e.computed((function(){var e=gform.applyFilters("gpnf_entry_limit_max",i.entryLimitMax,i.formId,i.fieldId,i);return""!==e&&t.entries().length>=e})),t.entryIds=e.computed((function(){var e=[];return o.each(t.entries(),(function(o,n){e.push(n.id)})),e}),t),t.runCalc=e.computed((function(){return i.runCalc(),t.entries().length}),t),t.editEntry=function(e,n){i.editEntry(e.id,o(n.target))},t.deleteEntry=function(e,n){i.deleteEntry(e,o(n.target))}};function i(e,o,n){return o=void 0!==o&&o?o:gf_global.base_url+"/images/spinner.gif",n=void 0!==n?n:"",this.elem=e,this.image='<img class="gfspinner" src="'+o+'" style="'+n+'" />',this.init=function(){return this.spinner=jQuery(this.image),jQuery(this.elem).after(this.spinner),this},this.destroy=function(){jQuery(this.spinner).remove()},this.init()}window.gpnfEventHandler=function(e,n,i){if(void 0===window.gpnfEvents&&(window.gpnfEvents=[]),0==window.gpnfEvents.length){var t=o._data(document).events.gform_post_render;o.each(t,(function(e,o){"gpnf"==o.namespace&&window.gpnfEvents.push(o.handler)})),o(document).off("gform_post_render.gpnf")}o.each(window.gpnfEvents,(function(e,o){o(o,n,i)}))}}(jQuery)})();
//# sourceMappingURL=gp-nested-forms-jquery-ui.js.map