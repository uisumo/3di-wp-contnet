<?php
/**
 * Copyright (c) 2018-2022 David J Bullock
 * Web Power and Light
 */

 class_exists('m4is_emz57o') || die(); m4is__q5cn::m4is_gopgz(); final 
class m4is__q5cn { static private $m4is_bxv7u; static private $m4is_q7m2; static private $m4is_gwtb03; static private $m4is_ovadpi = false; static 
function m4is_gopgz() { self::$m4is_bxv7u = memberium_app(); self::$m4is_q7m2 = self::$m4is_bxv7u->m4is_re5x( 'appname' ); self::$m4is_gwtb03 = self::$m4is_bxv7u->m4is_wnlbj_(); }  static 
function m4is_t8hw() { return self::$m4is_ovadpi === false ? self::$m4is_ovadpi = self::$m4is_bxv7u->m4is_mmdrl( 'settings', 'max_affiliate_age', 0 ) : self::$m4is_ovadpi; } static 
function m4is_zvzq( int $m4is_sfxdru ) { self::$m4is_ovadpi = $m4is_sfxdru; } static 
function m4is_kski() { static $m4is_rprd_t; if ( ! isset( $m4is_rprd_t ) ) { $m4is_rprd_t = self::$m4is_bxv7u->m4is_wnlbj_()->dsGetSetting( 'Affiliate', 'chooseaffiliate' ); } return $m4is_rprd_t; }  static 
function m4is_t_rp7() : int { global $wpdb; $m4is_u13x = MEMBERIUM_DB_AFFILIATES; $m4is_ioxk = "SELECT COUNT(*) FROM `{$m4is_u13x}` WHERE `appname` = %s AND `fieldname` = 'Status' AND `value` = 1;"; $m4is_ioxk = $wpdb->prepare( $m4is_ioxk, self::$m4is_q7m2 ); return (int) $wpdb->get_var( $m4is_ioxk ); }  static 
function m4is_cimah( int $m4is_ltqb = 0, int $m4is_zvxijt = 0, string $m4is_rr90 = '' ) { global $wpdb; $m4is_u13x = MEMBERIUM_DB_AFFILIATES; $m4is_ioxk = "SELECT distinct `id` FROM `{$m4is_u13x}` WHERE `appname` = %s AND `fieldname` = 'Status' "; $m4is_ioxk = $wpdb->prepare( $m4is_ioxk, self::$m4is_q7m2 ); if ( ! empty( $m4is_rr90 ) ) { $m4is_ioxk .= " AND `value` = {$m4is_rr90} "; } $m4is_ioxk .= "ORDER BY `id` ASC "; if ( $m4is_ltqb > 0 ) { $m4is_ioxk .= " LIMIT {$m4is_ltqb} OFFSET " . ($m4is_zvxijt * $m4is_ltqb); } $m4is_h9ti6y = $wpdb->get_col( $m4is_ioxk, 0 ); return $m4is_h9ti6y; }  static 
function m4is_ckn1m( int $m4is_fdmw5 ) { global $wpdb; $m4is_ap3_ = 'memberium/sync/running_totals/updated'; $m4is_du9f = time() - (int) get_transient( $m4is_ap3_ ); if ( $m4is_du9f > 43200 ) { self::m4is_d9t0o(); } $m4is_u13x = MEMBERIUM_DB_AFFILIATES_TOTALS; $m4is_fdmw5 = (int) $m4is_fdmw5; $m4is_ioxk = "SELECT `amount_earned`, `payments`, `clawbacks`, `running_balance`, `time` FROM `{$m4is_u13x}` WHERE `id` = {$m4is_fdmw5} AND `appname` = %s"; $m4is_ioxk = $wpdb->prepare( $m4is_ioxk, self::$m4is_q7m2 ); $m4is_n_bp6 = $wpdb->get_results($m4is_ioxk, ARRAY_A); $m4is_n_bp6 = is_array( $m4is_n_bp6[0] ) ? $m4is_n_bp6[0] : []; $m4is_il8u4 = empty( $m4is_n_bp6['time'] ) ? 0 : strtotime( $m4is_n_bp6['time'] ); return $m4is_n_bp6; }  static 
function m4is_d9t0o() { global $wpdb; $m4is_ap3_ = 'memberium/sync/running_totals/updated'; $m4is_ajx_hi = (int) get_transient( $m4is_ap3_ ); if ( (time() - $m4is_ajx_hi) < 7200 ) { return; } $m4is_u13x = MEMBERIUM_DB_AFFILIATES_TOTALS; $m4is_q7m2 = self::$m4is_q7m2; $m4is_ltqb = 500; $m4is_zvxijt = 0; do { $m4is_vq27 = self::m4is_cimah( $m4is_ltqb, $m4is_zvxijt, 1 ); if ( ! empty( $m4is_vq27 ) ) { $m4is_nbj_ = self::$m4is_gwtb03->affRunningTotals($m4is_vq27); if (! empty($m4is_nbj_) && is_array($m4is_nbj_)) { foreach($m4is_nbj_ as $m4is_w17mn) { if (is_array($m4is_w17mn)) { $m4is_ioxk = "INSERT INTO `{$m4is_u13x}` (`id`, `appname`, `amount_earned`, `payments`, `clawbacks`, `running_balance`) "; $m4is_ioxk .= "VALUES (%f, %s, %f, %f, %f, %f) "; $m4is_ioxk .= "ON DUPLICATE KEY UPDATE `id` = %f, `appname` = %s, `amount_earned` = %f, `payments` = %f, `clawbacks` = %f, `running_balance` = %f;"; $m4is_ioxk = $wpdb->prepare( $m4is_ioxk, $m4is_w17mn['AffiliateId'], self::$m4is_q7m2, $m4is_w17mn['AmountEarned'], $m4is_w17mn['Payments'], $m4is_w17mn['Clawbacks'], $m4is_w17mn['RunningBalance'], $m4is_w17mn['AffiliateId'], self::$m4is_q7m2, $m4is_w17mn['AmountEarned'], $m4is_w17mn['Payments'], $m4is_w17mn['Clawbacks'], $m4is_w17mn['RunningBalance'] ); $wpdb->query($m4is_ioxk); } } } $m4is_zvxijt++; } } while ( count( $m4is_vq27 ) == $m4is_ltqb ); set_transient( $m4is_ap3_, time(), 14400 ); }  static 
function m4is_yfyu2( array $m4is_zc6h5, array $m4is__yluqx = [] ) { global $wpdb; $m4is_u13x = 'Affiliate'; $m4is_w6mt = MEMBERIUM_DB_AFFILIATES; $m4is_bxv7u = memberium_app(); $m4is_zc6h5 = self::$m4is_bxv7u->m4is_l5kr8_( $m4is_zc6h5 ); $m4is_fdmw5 = (int) $m4is_zc6h5['Id']; $m4is_zc6h5['!LastUpdated'] = time(); $m4is__yluqx = empty( $m4is__yluqx ) ? self::m4is_cihq( $m4is_fdmw5 ) : $m4is__yluqx; $m4is_fb9cn0 = self::$m4is_bxv7u->m4is_ab02( $m4is__yluqx, $m4is_zc6h5 ); $m4is_d_uw5 = self::$m4is_bxv7u->m4is_rdm7ak( $m4is__yluqx, $m4is_zc6h5 ); $m4is_m5h3df = self::$m4is_bxv7u->m4is_nk208x( $m4is__yluqx, $m4is_zc6h5 ); $m4is_i1i5 = self::$m4is_bxv7u->m4is_h6_9( $m4is_fb9cn0, $m4is_m5h3df );  self::m4is_wyjznm( $m4is_fdmw5, $m4is_m5h3df );  if (! empty( $m4is_fb9cn0 ) ) { foreach ( $m4is_fb9cn0 as $m4is_ap3_ => $m4is_rhfd ) { $m4is_ioxk = "UPDATE `{$m4is_w6mt}` SET `value` = %s WHERE `id` = {$m4is_fdmw5}  AND `fieldname` = %s AND `appname` = %s"; $m4is_ioxk = $wpdb->prepare( $m4is_ioxk, $m4is_rhfd, $m4is_ap3_, self::$m4is_q7m2 ); $wpdb->query( $m4is_ioxk ); } }  if ( ! empty( $m4is_d_uw5 ) ) { $m4is_o1af2 = []; foreach ( $m4is_d_uw5 as $m4is_ap3_ => $m4is_rhfd ) { $m4is_o1af2[] = $wpdb->prepare( ' (%d, %s, %s, %s) ', $m4is_fdmw5, self::$m4is_q7m2, $m4is_ap3_, $m4is_rhfd ); } if ( ! empty( $m4is_o1af2 ) ) { $m4is_ioxk = "INSERT INTO `{$m4is_w6mt}` (`id`, `appname`, `fieldname`, `value`) VALUES " . implode( ',', $m4is_o1af2 ); $wpdb->query( $m4is_ioxk ); } }  return $m4is_zc6h5; }  static 
function m4is_fc47() { global $wpdb; $m4is_qqzo = 1000; $m4is_w6mt = MEMBERIUM_DB_AFFILIATES; $m4is_u13x = 'Affiliate'; $m4is_hkp7s = m4is_f84s3h::m4is_cm6nr($m4is_u13x, true); $m4is_h79rv = 'memberium/batchsync/affiliates/page'; $m4is_jbu6y = 'memberium/batchsync/affiliates/timestamp'; $m4is_q7m2 = self::$m4is_q7m2; $m4is_kc1q = ['Id' => '%']; $m4is_gwtb03 = self::$m4is_bxv7u->m4is_wnlbj_(); $m4is_zvxijt = 0; $m4is_dhrs = []; do { $m4is_nz9s = $m4is_gwtb03->dsQueryOrderBy($m4is_u13x, $m4is_qqzo, $m4is_zvxijt, $m4is_kc1q, $m4is_hkp7s, 'Id', true); $m4is_ejfox = count($m4is_nz9s); if (is_array($m4is_nz9s) ) { foreach($m4is_nz9s as $m4is_i2t3ps) { $m4is_xpasr0[$m4is_i2t3ps['Id']] = $m4is_i2t3ps; } unset($m4is_nz9s); $m4is_vq27 = []; foreach($m4is_xpasr0 as $m4is_zc6h5) { $m4is_vq27[] = $m4is_zc6h5['Id']; } $m4is_m91tr = implode(',', $m4is_vq27); $m4is_ioxk = "SELECT `id`, `fieldname`, `value` FROM `{$m4is_w6mt}` WHERE `appname` = '{$m4is_q7m2}' AND `id` IN ({$m4is_m91tr}) AND `fieldname` <> '!LastUpdated';"; $m4is_nz9s = $wpdb->get_results($m4is_ioxk, ARRAY_A); $m4is_lbky = []; if (is_array($m4is_nz9s)) { foreach($m4is_nz9s as $m4is_ap3_ => $m4is_i2t3ps) { $m4is_lbky[$m4is_i2t3ps['id']][$m4is_i2t3ps['fieldname']] = $m4is_i2t3ps['value']; } } unset($m4is_nz9s);  foreach( $m4is_xpasr0 as $m4is_b40e_m => $m4is_zc6h5 ) { if ( ! array_key_exists( $m4is_b40e_m, $m4is_lbky ) ) { self::m4is_yfyu2( $m4is_zc6h5 ); unset( $m4is_xpasr0[$m4is_b40e_m] ); } }  $m4is_n3zp = []; $m4is_o1af2 = []; $m4is_h9ti6y = []; $m4is_il8u4 = time(); foreach($m4is_xpasr0 as $m4is_b40e_m => $m4is_zc6h5) { $m4is_gacr = array_diff($m4is_zc6h5, $m4is_lbky[$m4is_b40e_m]); if (! empty($m4is_gacr)) { $m4is_n3zp[$m4is_b40e_m] = $m4is_gacr; $m4is_h9ti6y[] = $m4is_b40e_m; } } foreach($m4is_n3zp as $m4is_b40e_m => $m4is_wo7c93) { $m4is_sv3h = key($m4is_wo7c93); $m4is_rhfd = $m4is_wo7c93[$m4is_sv3h]; $m4is_o1af2[] = $wpdb->prepare('(%d, %s, %s, %s)', $m4is_b40e_m, $m4is_q7m2, $m4is_sv3h, $m4is_rhfd); } foreach($m4is_h9ti6y as $m4is_b40e_m) { $m4is_o1af2[] = $wpdb->prepare('(%d, %s, %s, %s)', $m4is_b40e_m, $m4is_q7m2, '!LastUpdated', $m4is_il8u4); } if (! empty($m4is_o1af2)) { $m4is_ioxk = "INSERT INTO `{$m4is_w6mt}` (`id`, `appname`, `fieldname`, `value`) VALUES " . implode(',', $m4is_o1af2) . " ON DUPLICATE KEY UPDATE `id`=VALUES(`id`), `appname`=VALUES(`appname`), `fieldname`=VALUES(`fieldname`), `value`=VALUES(`value`);"; $wpdb->query($m4is_ioxk); } $m4is_zvxijt++; } usleep( 250000 ); } while ($m4is_ejfox == $m4is_qqzo); }  static 
function m4is_l6i94s( int $m4is_b40e_m ) : array { global $wpdb; $m4is_q7m2 = self::$m4is_q7m2; $m4is_yz1j = MEMBERIUM_DB_AFFILIATES; $m4is_dn09xt = []; $m4is_ioxk = "SELECT `fieldname`, `value` FROM `{$m4is_yz1j}` WHERE `appname` = %s AND `id` = %d "; $m4is_ioxk = $wpdb->prepare( $m4is_ioxk, $m4is_q7m2, $m4is_b40e_m ); $m4is_xpasr0 = $wpdb->get_results( $m4is_ioxk, ARRAY_A ); if ( empty( $m4is_xpasr0 ) ) { $m4is_zc6h5 = self::m4is_gax2( $m4is_b40e_m ); $m4is_zc6h5['!source'] = 'Remote'; } else { $m4is_zc6h5 = []; foreach ( $m4is_xpasr0 as $m4is_wo7c93 ) { $m4is_zc6h5[$m4is_wo7c93['fieldname']] = $m4is_wo7c93['value']; } $m4is_zc6h5['!source'] = 'Local'; } return $m4is_zc6h5; }  static 
function m4is_cihq( int $m4is_fdmw5 ) { global $wpdb; $m4is_w6mt = MEMBERIUM_DB_AFFILIATES; $m4is_q7m2 = self::$m4is_bxv7u->m4is_re5x( 'appname' ); $m4is_ioxk = "SELECT `fieldname`, `value` FROM `{$m4is_w6mt}` WHERE `appname` = %s AND `id` = %d "; $m4is_ioxk = $wpdb->prepare( $m4is_ioxk, $m4is_q7m2, $m4is_fdmw5 ); $m4is_xpasr0 = (array) $wpdb->get_results( $m4is_ioxk, ARRAY_A ); if ( ! empty( $m4is_xpasr0 ) ) { $m4is_xpasr0 = self::$m4is_bxv7u->m4is_ndf59( $m4is_xpasr0, 'fieldname', 'value' ); $m4is_xpasr0['!source'] = 'Local'; } return $m4is_xpasr0; }  static 
function m4is_rq37wf( int $m4is_aicfp ) { global $wpdb; $m4is_w6mt = MEMBERIUM_DB_AFFILIATES; $m4is_q7m2 = self::$m4is_q7m2; $m4is_ioxk = "
			SELECT
			`{$m4is_w6mt}_2`.`fieldname`,
			`{$m4is_w6mt}_2`.`value`
			FROM
			`{$m4is_w6mt}`,
			`{$m4is_w6mt}` AS `{$m4is_w6mt}_2`
			WHERE	`{$m4is_w6mt}`.`appname`  = '{$m4is_q7m2}'
			AND 	`{$m4is_w6mt}`.`fieldname` = 'ContactId'
			AND		`{$m4is_w6mt}`.`value`     = %d
			AND		`{$m4is_w6mt}_2`.`id`      = {$m4is_w6mt}.id
			AND		`{$m4is_w6mt}_2`.`appname` = '{$m4is_q7m2}'; "; $m4is_ioxk = $wpdb->prepare( $m4is_ioxk, $m4is_aicfp ); $m4is_zc6h5 = $wpdb->get_results( $m4is_ioxk, ARRAY_N ); $m4is_zc6h5 = self::$m4is_bxv7u->m4is_ndf59( $m4is_zc6h5, 0, 1 ); $m4is_zc6h5 = apply_filters('memberium/affiliate/load', $m4is_zc6h5 ); return $m4is_zc6h5; }  static 
function m4is__21k( int $m4is_aicfp ) : array { $m4is_qqzo = 1; $m4is_u13x = 'Affiliate'; $m4is_zvxijt = 0; $m4is_kc1q = [ 'ContactId' => $m4is_aicfp ]; $m4is_hkp7s = m4is_f84s3h::m4is_cm6nr( $m4is_u13x, true ); $m4is_zc6h5 = m4is_f84s3h::m4is_l2n5pg( $m4is_u13x, $m4is_qqzo, $m4is_zvxijt, $m4is_kc1q, $m4is_hkp7s, 'Id', true ); if (! is_array( $m4is_zc6h5 ) ) {  } $m4is_zc6h5 = isset( $m4is_zc6h5[0] ) ? $m4is_zc6h5[0] : []; $m4is_zc6h5 = is_array( $m4is_zc6h5 ) ? self::$m4is_bxv7u->m4is_l5kr8_( $m4is_zc6h5 ) : $m4is_zc6h5; return $m4is_zc6h5; }  static 
function m4is_ix35( int $m4is_fdmw5 ) { $m4is_zc6h5 = m4is_f84s3h::m4is__5wbje( 'Affiliate', $m4is_fdmw5 ); return $m4is_zc6h5; }  static 
function m4is_nvjoa8( int $m4is_fdmw5 ) { global $wpdb; $m4is_q7m2 = self::$m4is_q7m2; $m4is_w6mt = MEMBERIUM_DB_AFFILIATES; $m4is_ioxk = "DELETE FROM `{$m4is_w6mt}` WHERE `id` = %d AND `appname` = %s "; $m4is_ioxk = $wpdb->prepare( $m4is_ioxk, $m4is_fdmw5, $m4is_q7m2 );  $wpdb->query( $m4is_ioxk ); } private static 
function m4is_wyjznm( int $m4is_fdmw5, array $m4is_kbu63_) { if ( count( $m4is_kbu63_ ) ) { global $wpdb; $m4is_q7m2 = self::$m4is_q7m2; $m4is_w6mt = MEMBERIUM_DB_AFFILIATES; $m4is_pepk8h = implode( "','", $m4is_kbu63_ ); $m4is_ioxk = "DELETE FROM `{$m4is_w6mt}` WHERE `id` = %d AND `appname` = %s AND `fieldname` IN ( '{$m4is_pepk8h}' )"; $m4is_ioxk = $wpdb->prepare( $m4is_ioxk, $m4is_fdmw5, $m4is_q7m2 ); $wpdb->query( $m4is_ioxk ); } }  static 
function m4is_gax2( int $m4is_fdmw5 ) : array { $m4is_u13x = 'Affiliate'; $m4is_zc6h5 = m4is_f84s3h::m4is__5wbje( $m4is_u13x, $m4is_fdmw5 ); if ( is_array( $m4is_zc6h5 ) && ! empty( $m4is_zc6h5 ) ) { m4is__q5cn::m4is_yfyu2( $m4is_zc6h5 ); return $m4is_zc6h5; } elseif ( m4is_f84s3h::m4is_pcm12z( $m4is_zc6h5 ) ) { m4is__q5cn::m4is_nvjoa8( $m4is_fdmw5 ); } else { error_log('Memberium Error:  Affiliate #' . $m4is_fdmw5 . ' - ' . $m4is_zc6h5); } return []; }  static 
function elv_sync_affiliate_by_cid( int $m4is_aicfp ) : array { $m4is_zc6h5 = self::m4is__21k( $m4is_aicfp ); if ( is_array( $m4is_zc6h5 ) && ! empty( $m4is_zc6h5 ) ) { m4is__q5cn::m4is_yfyu2( $m4is_zc6h5 ); return $m4is_zc6h5; } elseif ( m4is_f84s3h::m4is_pcm12z( $m4is_zc6h5 ) ) {  error_log('Memberium Error:  Affiliate #' . $m4is_fdmw5 . ' - ' . $m4is_zc6h5 . ' deleted.' ); } else { error_log('Memberium Error:  Affiliate #' . $m4is_fdmw5 . ' - ' . $m4is_zc6h5); } return []; }  static 
function m4is_vi04( int $m4is_fdmw5, int $m4is_sfxdru = -1 ) : bool { global $wpdb; $m4is_sfxdru = $m4is_sfxdru < 0 ? self::m4is_t8hw() : 0; $m4is_ea5_12 = true; $m4is_w6mt = MEMBERIUM_DB_AFFILIATES; $m4is_q7m2 = self::$m4is_q7m2; $m4is_ioxk = "SELECT `value` as `age` FROM `{$m4is_w6mt}` WHERE `appname` = %s AND `id` = %d AND `fieldname` = '!LastUpdated' "; $m4is_du9f = (int) $wpdb->get_var( $m4is_ioxk ); return ( $m4is_du9f + $m4is_sfxdru ) > time(); }  static 
function m4is_ma1q8( int $m4is_aicfp ) : int { global $wpdb; static $m4is_czi50; if ( isset( $m4is_czi50[$m4is_aicfp] ) ) { return $m4is_czi50[$m4is_aicfp]; } if ( isset( $_SESSION['keap']['contact']['id'] ) && $_SESSION['keap']['contact']['id'] == $m4is_aicfp && ! empty( isset( $_SESSION['keap']['affiliate']['id'] ) ) ) { $m4is_czi50[$m4is_aicfp] = $_SESSION['keap']['affiliate']['id']; return $_SESSION['keap']['affiliate']['id']; } $m4is_q7m2 = self::$m4is_q7m2; $m4is_w6mt = MEMBERIUM_DB_AFFILIATES; $m4is_ioxk = "SELECT `id` FROM `{$m4is_w6mt}` WHERE `appname` = '{$m4is_q7m2}' AND `fieldname` = 'ContactId' AND `value` = '%d'"; $m4is_ioxk = $wpdb->prepare( $m4is_ioxk, $m4is_aicfp ); $m4is_n_bp6 = (int) $wpdb->get_var( $m4is_ioxk ); if (! empty( $m4is_n_bp6 ) ) { $m4is_czi50[$m4is_aicfp] = $m4is_n_bp6; } return $m4is_n_bp6; } }
