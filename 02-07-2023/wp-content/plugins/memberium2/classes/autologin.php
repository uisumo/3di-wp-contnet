<?php
/**
 * Copyright (c) 2018-2022 David J Bullock
 * Web Power and Light, LLC
 * https://webpowerandlight.com
 * support@webpowerandlight.com
 *
 */

 class_exists('m4is_emz57o') || die(); final 
class m4is_xtc867 { static private $m4is_bxv7u, $m4is_cpwjsn, $m4is_cfb5tj = false, $m4is_aaz9 = 0, $m4is_pdzpv = 0;    static 
function m4is_vwkr7() { if ( ! m4is_o5aoir::m4is_du5icq() ) { return; } self::$m4is_bxv7u = memberium_app(); self::$m4is_cpwjsn = m4is_pcys::m4is_a6x52r(); global $wpdb, $wp_rewrite; self::$m4is_cfb5tj = ! empty( $_GET['debug'] ); self::$m4is_pdzpv = microtime( true ); if ( empty($wp_rewrite) ) { $wp_rewrite = new WP_Rewrite(); } m4is_d8yr0_::m4is_okts(); $m4is_rz4ur = self::$m4is_bxv7u->m4is_mmdrl( 'settings', 'username_field' ); $m4is_jyx_t = self::$m4is_bxv7u->m4is_mmdrl( 'settings', 'password_field' ); $m4is_qy0cg = self::$m4is_bxv7u->m4is_mmdrl( 'settings', 'local_auth_only', false ); $m4is_n8wbaf = self::$m4is_bxv7u->m4is_mmdrl( 'settings', 'site_ban_tag' ); $m4is_kf18s = empty( $_GET['auth_key'] ) ? '' : trim( $_GET['auth_key'] ); $m4is_aicfp = empty( $_GET['Id'] ) ? 0 : (int) $_GET['Id']; $m4is_aicfp = empty( $_GET['contactId'] ) ? $m4is_aicfp : (int) trim( $_GET['contactId'] ); $m4is_cmat = empty( $_GET['orderId'] ) ? 0 : (int) $_GET['orderId']; $m4is_xpfcq = empty( $_GET[$m4is_rz4ur] ) ? '' : $_GET[$m4is_rz4ur]; $m4is_xpfcq = empty( $_GET['Contact0Email'] ) ? $m4is_xpfcq : $_GET['Contact0Email']; $m4is_xpfcq = empty( $_GET['inf_field_Email'] ) ? $m4is_xpfcq : $_GET['inf_field_Email']; $m4is_xpfcq = strtolower( trim( strtr( $m4is_xpfcq, ' ', '+' ) ) ); $m4is_o3mwus = empty( $_GET['tag_ids']) ? '' : trim( $_GET['tag_ids'] ); $m4is_nzrv1 = false; $m4is_gb7pr = false; $m4is_smbn86 = ! empty($_GET['inf_field_BrowserLanguage']); $m4is_sto9n = false; $m4is_admy3 = self::m4is_vc4dz($_GET); self::m4is_b3oikx( 'Starting Request at ' . self::$m4is_pdzpv );  if (! empty( $m4is_admy3 ) ) { self::$m4is_cpwjsn->m4is_syn0_4( $m4is_admy3 ); }  self::m4is_b3oikx( 'Starting Order Check at ' . microtime( true ) . ' / ' . ( microtime( true ) - self::$m4is_pdzpv ) ); if ( empty( $m4is_aicfp ) && ! empty( $m4is_cmat ) ) { $m4is_aicfp = self::m4is_exdbj( $m4is_cmat ); } self::m4is_b3oikx( 'Completing Order Check at ' . microtime( true ) . ' / ' . ( microtime( true ) - self::$m4is_pdzpv ) ); self::$m4is_aaz9 = m4is_q1amx::m4is_u4dk( $m4is_aicfp, 'autologin', 'Autologin' ); $m4is_dn09xt = empty( $_SERVER['REQUEST_URI'] ) ? serialize( $_GET ) : $_SERVER['REQUEST_URI']; m4is_q1amx::m4is_rf68r( self::$m4is_aaz9, 'Parameters ' . $m4is_dn09xt ); self::m4is_b3oikx(__LINE__ . ' - NOTICE:  Email = ' . $m4is_xpfcq); self::m4is_b3oikx(__LINE__ . ' - NOTICE:  Contact ID = ' . $m4is_aicfp); self::m4is_b3oikx(__LINE__ . ' - NOTICE:  Order ID = ' . $m4is_cmat); self::m4is_b3oikx(__LINE__ . ' - NOTICE:  Redirect URL set to ' . $m4is_admy3); self::m4is_x8nw0( $m4is_kf18s ); self::m4is_j9msfh( $m4is_aicfp ); self::m4is_bko21( $m4is_xpfcq ); $m4is_nq7s = self::m4is_ud_3( $m4is_aicfp ); self::m4is_ij0n4( $m4is_nq7s ); $m4is_nq7s = self::m4is_vzn2( $m4is_aicfp, $m4is_xpfcq, $m4is_nq7s ); self::elv_verify_autologin_against_crm($m4is_aicfp, $m4is_xpfcq, $m4is_nq7s); $m4is_nzrv1 = get_user_by('email', $m4is_xpfcq); self::m4is_vxcq($m4is_nzrv1); self::m4is_b3oikx('Starting WP User Update at ' . microtime( true ) . ' / ' . ( microtime( true ) - self::$m4is_pdzpv) ); self::$m4is_bxv7u->m4is_jrjget( $m4is_aicfp ); $m4is_nzrv1 = get_user_by( 'email', $m4is_xpfcq ); self::m4is_b3oikx( 'Completing WP User Update at ' . microtime( true ) . ' / ' . ( microtime( true ) - self::$m4is_pdzpv ) ); self::m4is_yujwk( $m4is_nzrv1 ); self::m4is_ezswrb( $m4is_nzrv1 ); self::m4is_u52lx( $m4is_aicfp, $m4is_admy3 ); self::m4is_b3oikx( 'Starting Login at ' . microtime( true ) . ' / ' . ( microtime( true ) - self::$m4is_pdzpv ) ); self::m4is_shbpa( $m4is_o3mwus, $m4is_aicfp ); $m4is_q4c_xa = $m4is_nzrv1->ID; $_POST['pwd'] = $m4is_nq7s[$m4is_jyx_t]; $_SESSION = empty($_SESSION['memb_user']) ? self::$m4is_bxv7u->m4is_q4nu($m4is_q4c_xa) : $_SESSION; $m4is_nzrv1 = m4is_pewcid::m4is_mlnq($m4is_nzrv1); if ( is_a( $m4is_nzrv1, 'WP_User' ) ) { m4is_pewcid::m4is_e87ze( $m4is_xpfcq ); wp_set_current_user($m4is_q4c_xa); $m4is_nzrv1 = apply_filters('wp_authenticate_user', $m4is_nzrv1, ''); self::$m4is_bxv7u->m4is_v64c('do_autologin'); } self::m4is_b3oikx('Completing Login at ' . microtime( true ) . ' / ' . ( microtime( true ) - self::$m4is_pdzpv ) ); self::m4is_l7ba($m4is_nzrv1); $_SESSION['memb_user']['autologin'] = 1; wp_set_auth_cookie($m4is_q4c_xa); self::$m4is_cpwjsn->m4is_z1x9($m4is_nq7s, $m4is_q4c_xa); $m4is_admy3 = self::m4is_n0w1($m4is_admy3, $m4is_nzrv1); if (self::$m4is_cfb5tj) { echo 'Completing Successful Login at ', microtime( true ), ' / ', microtime( true ) - self::$m4is_pdzpv ,'<br />'; echo '<pre>', print_r($_SESSION, true), '</pre>'; die(); } do_action('wp_login', $m4is_xpfcq, $m4is_nzrv1); session_write_close(); wp_redirect($m4is_admy3, 302, 'Memberium Autologin'); exit; } static private 
function m4is_b3oikx($m4is_fgxy) { if (self::$m4is_cfb5tj) { echo $m4is_fgxy, '<br>'; } } static private 
function m4is_exdbj($m4is_cmat = 0) { $m4is_aicfp = 0; $m4is_kbu63_ = ['ContactId']; $m4is_da5x = m4is_f84s3h::m4is__5wbje('Job', $m4is_cmat, $m4is_kbu63_); if (is_array($m4is_da5x) ) { $m4is_aicfp = (int) $m4is_da5x['ContactId']; } else { sleep(1); $m4is_da5x = m4is_f84s3h::m4is__5wbje('Job', $m4is_cmat, $m4is_kbu63_); if (is_array($m4is_da5x) ) { $m4is_aicfp = (int) $m4is_da5x['ContactId']; } } return $m4is_aicfp; } static private 
function m4is_o1nf($m4is_nzrv1) {  $m4is_vu50 = false; if (is_a($m4is_nzrv1, 'WP_User')) { $m4is_axvl = [ 'manage_options', 'edit_plugins', 'edit_themes', 'edit_users', 'create_users', 'delete_users', 'delete_others_pages', 'delete_others_posts', 'edit_others_pages', 'edit_others_posts', ]; foreach($m4is_axvl as $m4is_jzk7tr) { if (user_can($m4is_nzrv1, $m4is_jzk7tr) ) { $m4is_vu50 = true; m4is_q1amx::m4is_rf68r(self::$m4is_aaz9, 'User is a non-subscriber:  ' . $m4is_jzk7tr); if (self::$m4is_cfb5tj) echo __LINE__, ' - Blocked Capability:  ' . $m4is_jzk7tr . '<br />'; break; } } } return $m4is_vu50; }  static private 
function m4is_vc4dz( $m4is_ssdxa6 ) { $m4is_admy3 = empty( $m4is_ssdxa6['redir'] ) ? '' : $m4is_ssdxa6['redir']; $m4is_rxc9n1 = self::m4is_qo3ks1( $m4is_ssdxa6 ); $m4is_xy2s51 = apply_filters('memberium/autologin/redirect/parameters', $m4is_rxc9n1, $m4is_ssdxa6); foreach($m4is_xy2s51 as $m4is_ap3_ => $m4is_rhfd) { $m4is_xy2s51[$m4is_ap3_] = rawurlencode($m4is_rhfd); } return add_query_arg($m4is_xy2s51, $m4is_admy3); }  static private 
function m4is_qo3ks1($m4is_ssdxa6 = []) { $m4is_dhrs = [ 'affiliate', 'utm_campaign', 'utm_content', 'utm_medium', 'utm_source', 'utm_term', ]; $m4is_dhrs = apply_filters('memberium/autologin/redirect/whitelised_params', $m4is_dhrs); $m4is_rxc9n1 = []; foreach( $m4is_dhrs as $m4is_ap3_ ) { if ( isset($m4is_ssdxa6[$m4is_ap3_] ) ) { $m4is_rxc9n1[$m4is_ap3_] = $m4is_ssdxa6[$m4is_ap3_]; } } return $m4is_rxc9n1; }  static private 
function m4is_x8nw0($m4is_kf18s = '') { $m4is_aq86s = array_filter( explode( ',', memberium_app()->m4is_mmdrl( 'settings', 'autologin_authkeys' ) ) ); if (empty($m4is_kf18s) || ! in_array($m4is_kf18s, $m4is_aq86s) ) { m4is_q1amx::m4is_rf68r(self::$m4is_aaz9, 'Failure - Auth Key Mismatch'); self::m4is_b3oikx(__LINE__ . ' - FAILURE:  Auth Key mismatch'); if (! self::$m4is_cfb5tj) { wp_redirect(get_bloginfo('wpurl'), 302, 'Memberium Autologin Failure'); } exit; } } static private 
function m4is_j9msfh($m4is_aicfp = 0) { if (! $m4is_aicfp) { m4is_q1amx::m4is_rf68r(self::$m4is_aaz9, 'Failure - No Contact Id'); self::m4is_b3oikx(__LINE__ . ' - FAILURE:  Invalid Contact ID'); if (! self::$m4is_cfb5tj) { wp_redirect(get_bloginfo('wpurl'), 302, 'Memberium Autologin Failure'); } exit; } } static private 
function m4is_bko21($m4is_xpfcq) { if (empty($m4is_xpfcq) ) { m4is_q1amx::m4is_rf68r(self::$m4is_aaz9, 'Failure - Email address not populated'); self::m4is_b3oikx(__LINE__ . ' - FAILURE:  Email address not populated'); if (! self::$m4is_cfb5tj) { wp_redirect(get_bloginfo('wpurl'), 302, 'Memberium Autologin Failure'); } exit; } } static private 
function m4is_ij0n4($m4is_nq7s) { if (empty($m4is_nq7s) ) { m4is_q1amx::m4is_rf68r(self::$m4is_aaz9, 'Failure - No contact data found'); self::m4is_b3oikx(__LINE__ . ' - FAILURE:  Empty Contact Record'); if (! self::$m4is_cfb5tj) { wp_redirect(get_bloginfo('wpurl'), 302, 'Memberium Autologin Failure'); } exit; } }  static private 
function m4is_yujwk($m4is_nzrv1) { if (! $m4is_nzrv1) { m4is_q1amx::m4is_rf68r(self::$m4is_aaz9, 'Failure - User not found'); self::m4is_b3oikx(__LINE__ . ' - FAILURE:  User not found'); if (! self::$m4is_cfb5tj) { wp_redirect(get_bloginfo('wpurl'), 302, 'Memberium Autologin Failure'); } exit; } }  static private 
function m4is_ezswrb($m4is_nzrv1) { $m4is_vu50 = self::m4is_o1nf($m4is_nzrv1); if ($m4is_vu50) { $m4is_a6g9qj = 'FAILURE:  Auto-Login attempt by non-subscriber'; self::m4is_b3oikx($m4is_a6g9qj); m4is_q1amx::m4is_rf68r(self::$m4is_aaz9, $m4is_a6g9qj);  wp_redirect(get_bloginfo('wpurl'), 302, 'Memberium Autologin Failure'); exit; } self::m4is_b3oikx('Role Check Complete'); }  static private 
function m4is_ud_3(int $m4is_aicfp) { $m4is_uu0bf = memberium_app()->m4is_mmdrl( 'settings', 'max_contact_age', 0 ); $m4is_nq7s = m4is_zbyh::m4is_w1bfmt( $m4is_aicfp ); $m4is_sto9n = empty( $m4is_nq7s ); $m4is_sto9n = $m4is_sto9n || empty( $m4is_nq7s['!LastUpdated'] ); $m4is_sto9n = $m4is_sto9n || ( time() - $m4is_nq7s['!LastUpdated'] > $m4is_uu0bf ); if ( $m4is_sto9n ) { self::m4is_b3oikx( 'Starting Contact Sync at ' . microtime( true ) . ' / ' . ( microtime( true ) - self::$m4is_pdzpv ) ); memberium_app()->m4is_qjrxkl( $m4is_aicfp ); $m4is_nq7s = m4is_zbyh::m4is_w1bfmt( $m4is_aicfp ); self::m4is_b3oikx( 'Completing Contact Sync at ' . microtime( true ) . ' / ' . ( microtime( true ) - self::$m4is_pdzpv ) ); } return $m4is_nq7s; }  static private 
function elv_verify_autologin_against_crm( $m4is_aicfp, $m4is_xpfcq, $m4is_nq7s ) { $m4is_tlo7q = empty($m4is_nq7s['Id']) ? 0 : (int) $m4is_nq7s['Id']; $m4is_x8qc = empty($m4is_nq7s['Email']) ? 0 : strtolower(trim($m4is_nq7s['Email']) ); if ($m4is_tlo7q <> $m4is_aicfp || $m4is_xpfcq <> $m4is_x8qc) { m4is_q1amx::m4is_rf68r(self::$m4is_aaz9, 'Failure - Autologin does not match CRM'); self::m4is_b3oikx('Autologin contact does not match CRM contact'); if (! self::$m4is_cfb5tj) { wp_redirect(get_bloginfo('wpurl'), 302, 'Memberium Autologin Failure'); } exit; } }  static private 
function m4is_vzn2($m4is_aicfp, $m4is_xpfcq, $m4is_nq7s) { $m4is_wfr0jg = empty($_GET['forcelogin']) ? '' : $_GET['forcelogin']; if ($m4is_wfr0jg) { $m4is_nzrv1 = get_user_by('email', $m4is_xpfcq); $m4is_jyx_t = memberium_app()->m4is_mmdrl('settings', 'password_field'); if (empty($m4is_nq7s[$m4is_jyx_t]) ) { $m4is_ohey = memberium_app()->m4is_v8mw2u(); $m4is_nq7s[$m4is_jyx_t] = $m4is_ohey; memberium_app()->m4is_dizjd($m4is_aicfp, [$m4is_jyx_t => $m4is_ohey], true); memberium_app()->m4is_ba7dk($m4is_nq7s); } if (! $m4is_nzrv1) { memberium_app()->m4is_jrjget($m4is_aicfp); } self::m4is_b3oikx('Force Login at ' . microtime( true ) . ' / ' . ( microtime( true ) - self::$m4is_pdzpv) ); } return $m4is_nq7s; }  static private 
function m4is_vxcq($m4is_nzrv1) { $m4is_avugd = memberium_app()->m4is_mmdrl('settings', 'known_logins_only', false); if ($m4is_avugd) { if (! $m4is_nzrv1) { self::m4is_b3oikx(__LINE__ . ' - FAILURE:  No matching WP User, known logins only'); m4is_q1amx::m4is_rf68r(self::$m4is_aaz9, 'Known Login Check Failed.'); if (! self::$m4is_cfb5tj) { wp_redirect(get_bloginfo('wpurl'), 302, 'Memberium Autologin Failure'); } exit; } } }  static private 
function m4is_l7ba($m4is_nzrv1) { if (! is_a($m4is_nzrv1, 'WP_User')) { $m4is_a6g9qj = is_a($m4is_nzrv1, 'WP_Error') ? strip_tags($m4is_nzrv1->get_error_message() ) : 'Authentication / Login Error'; wp_set_current_user(0); self::m4is_b3oikx('FAILURE:  ' . $m4is_a6g9qj); m4is_q1amx::m4is_rf68r(self::$m4is_aaz9, $m4is_a6g9qj); if (! self::$m4is_cfb5tj) { wp_redirect(get_bloginfo('wpurl'), 302, 'Memberium Autologin Failure'); } exit; } }  static private 
function m4is_u52lx($m4is_aicfp, $m4is_admy3) { if (is_user_logged_in() ) { $m4is_a6g9qj = 'Login Session Exists, Logging Out'; m4is_q1amx::m4is_rf68r(self::$m4is_aaz9, 'Already Logged In, Redirecting'); self::m4is_b3oikx($m4is_a6g9qj); if (m4is_lpl4d::m4is_a_2z() == $m4is_aicfp) { if (empty($m4is_admy3) ) { if (! empty($_SESSION['memb_user']['login_page']) ) { $m4is_admy3 = get_permalink($_SESSION['memb_user']['login_page']); } } if (empty($m4is_admy3) ) { $m4is_admy3 = get_site_url(); } wp_redirect($m4is_admy3, 302, 'Memberium Autologin - User Logged In'); exit; } m4is_q1amx::m4is_rf68r(self::$m4is_aaz9, $m4is_a6g9qj); wp_destroy_current_session(); wp_clear_auth_cookie(); memberium_app()->m4is_ej5_0(); } }  static private 
function m4is_n0w1($m4is_admy3, $m4is_nzrv1) { $m4is__4mu = memberium_app()->m4is_mmdrl('settings', 'first_login_page'); $m4is_q4c_xa = $m4is_nzrv1->ID; if (empty($m4is_admy3) ) { if ($m4is__4mu) { if (get_user_meta($m4is_q4c_xa, 'login_count', true) == 0) { $m4is_admy3 = get_permalink($m4is__4mu); } } } if (empty($m4is_admy3) ) { $m4is_admy3 = empty($_SESSION['memb_user']['login_page']) ? get_home_url() : get_permalink($_SESSION['memb_user']['login_page']); } return $m4is_admy3; }  static private 
function m4is_shbpa( $m4is_o3mwus, $m4is_aicfp ) { if ( ! empty( $m4is_o3mwus ) ) { self::m4is_b3oikx( 'Starting Adding Tags at ' . microtime( true ) . ' / ' . ( microtime( true ) - self::$m4is_pdzpv) ); self::m4is_b3oikx( 'Setting Tags: ' . $m4is_o3mwus); m4is_q1amx::m4is_rf68r( self::$m4is_aaz9, 'Setting Tags', $m4is_o3mwus ); self::$m4is_bxv7u->m4is__mkz( $m4is_o3mwus, $m4is_aicfp ); self::m4is_b3oikx( 'Completing Adding Tags at ' . microtime( true ) . ' / ' . ( microtime( true ) - self::$m4is_pdzpv ) ); } } }
