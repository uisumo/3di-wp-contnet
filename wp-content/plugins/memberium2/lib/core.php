<?php
/**
* Copyright (c) 2012-2020 David J Bullock
* Web Power and Light, LLC
* https://webpowerandlight.com
* support@webpowerandlight.com
*
*/

 if (! defined('ABSPATH') ) { die(); } final class wplj_l2t {    function wplnm1h() { return MEMBERIUM_VERSION; } function wplznigw() { return MEMBERIUM_NESTING_LEVELS; } function wple73mp() { return 'https://licenseserver.webpowerandlight.com/memberium-is/current-version.php'; } function wply9rhd4() { return $this->doing_http_post; } function wplbluoxq($vwplsfdb_t) { $this->doing_http_post = (bool) $vwplsfdb_t; } function wplubo6() { if (isset($_SESSION['memb_user']['crm_id'])) { return $_SESSION['memb_user']['crm_id']; } return $this->contact_id; } function wplwxbl($vwplvtmqd) { $this->contact_id = $vwplvtmqd; } function wpldti9() { return wplsbzgvp::wplfhxj9(); } function wpljmvd7($vwplwxa_5 = true) { $this->sso_mode = (boolean) $vwplwxa_5; } function wpllpld() { return (bool) $this->sso_mode; }       function wpl_sw4($vwplwcre) { if (is_array($vwplwcre) && ! empty($vwplwcre) ) { global $wpdb; $vwplu3se = implode(',', $vwplwcre); $vwplx1ap5_ = "SELECT user_id FROM {$wpdb->usermeta} WHERE user_id IN (" . $vwplu3se . ") AND `meta_key` = 'memberium_optout' AND `meta_value` = 1; "; $vwpls_pf = $wpdb->get_col($vwplx1ap5_); $vwplwcre = array_diff($vwplwcre, $vwpls_pf); } return $vwplwcre; }    function wplr5ah($vwplpz60x) { $vwplpz60x['3min'] = array( 'interval' => 3 * 60, 'display' => __('Every 3 minutes') ); $vwplpz60x['5min'] = array( 'interval' => 5 * 60, 'display' => __('Every 5 minutes') ); $vwplpz60x['20min'] = array( 'interval' =>20 * 60, 'display' => __('Every 20 minutes') ); $vwplpz60x['30min'] = array( 'interval' => 30 * 60, 'display' => __('Every 30 minutes') ); return $vwplpz60x; }    function wpld0z1($vwplfkojlf, $vwpltancmh, $vwplgi9c) { $vwplzw_4 = wplz8bid::wplvf1d('settings', 'login_url'); if ($vwplzw_4 < 1) { if (! empty($vwpltancmh) ) { $vwplfkojlf = add_query_arg('redirect_to', $vwpltancmh, $vwplfkojlf); } } else { $vwpli6w5ap = get_permalink($vwplzw_4); if (! empty($vwpli6w5ap) ) { if (! empty($vwpltancmh) ) { $vwplfkojlf = add_query_arg('redirect_to', $vwpltancmh, $vwpli6w5ap); } } } return $vwplfkojlf; } function wplaxba98($null, $vwpllzly5b, $vwplqf5x, $vwplgzj6fs, $vwpln4ikd) { if ($vwplgzj6fs == $vwpln4ikd) { return null; } if ( ! wplz8bid::wplvf1d('settings', 'sync_meta_updates') ) { return null; } $vwplrz25u7 = wplj_l2t::wplm_vec(); $vwplrz25u7 = apply_filters('memberium_user_meta_map', $vwplrz25u7); if (empty($vwplrz25u7[$vwplqf5x]) ) { return null; } $vwplvtmqd = wpllbej::wplbmo_1($vwpllzly5b); if (! $vwplvtmqd) { return null; } global $wpdb; $vwplb_fgxk = get_user_meta($vwpllzly5b, $vwplqf5x, true); if ($vwplb_fgxk == $vwplgzj6fs) { return null; } $vwple2yn = $vwplrz25u7[$vwplqf5x]; $this->wplox2qcd($vwple2yn, $vwplgzj6fs, $vwplvtmqd);  return null;  }    function wplmhgwq($vwplq9d7i2, $vwpl_vziw, $vwplqf5x, $vwplgzj6fs, $vwpll3l9pc = '') { global $wpdb; if ($vwpll3l9pc == $vwplgzj6fs) { return; } if ($this->doing_user_update) { return; } if (substr($vwplqf5x, 0, 5) <> 'memb_') { return; } $vwplvtmqd = (int) wpllbej::wplbmo_1($vwpl_vziw); if ($vwplvtmqd < 1) { return; }  $vwplt9mos2 = array( 'CreatedBy', 'DateCreated', 'Groups', 'Id', 'LastUpdated', 'LastUpdatedBy', 'Validated', ); foreach($vwplt9mos2 as $vwple2yn) { if ($vwplqf5x == ('memb_' . $vwple2yn) ) { return; } } $vwple2yn = substr($vwplqf5x, 5); $vwpluflc1 = strtolower($vwple2yn); $vwplgzj6fs = trim($vwplgzj6fs); if ( get_current_user_id() == $vwpl_vziw) { if (wplsbzgvp::wplc4na($vwpluflc1) == $vwplgzj6fs) { return; } $vwplcqlhk = true; } else { $vwplcqlhk = false; }  if ($vwplcqlhk) { wplsbzgvp::wplx9wl8g($vwpluflc1, $vwplgzj6fs); if ($vwplqf5x == 'memb_' . wplz8bid::wplvf1d('settings', 'password_field') ) { $this->wplr2rtyo($vwplgzj6fs); } $this->dirty_contacts[$vwplvtmqd][$vwple2yn] = $vwplgzj6fs; }  $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplx1ap5_ = 'INSERT INTO `' . MEMBERIUM_DB_CONTACTS . '` (`id`, `appname`, `fieldname`, `value`) VALUES (%d, %s, %s, %s) ON DUPLICATE KEY UPDATE `value` = %s;'; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplvtmqd, $vwplw5rgd3, $vwple2yn, $vwplgzj6fs, $vwplgzj6fs); $wpdb->query($vwplx1ap5_); } function wpljwg6($vwplgogvie, $vwple50v = '') { if (! wplz8bid::wplvf1d('settings', 'local_auth_only') ) { return; } if (empty($vwple50v) ) { $vwple50v = (isset($_POST['password_1']) && isset($_POST['password_2']) ) ? $_POST['password_1'] : ''; }  $vwplvtmqd = (int) $this->wplckwp7($vwplgogvie->user_email); if ($vwplvtmqd > 0) {  $vwplup7mi = wplz8bid::wplvf1d('settings', 'password_field'); $vwplrp9u24 = array( $vwplup7mi => $vwple50v ); $this->isdk->updateCon($vwplvtmqd, $vwplrp9u24);   $this->wplj9ye($vwplvtmqd); } } function wplf5yc6() { if (! is_user_logged_in() ) { unset($_SESSION['memb_db_fields'], $_SESSION['memb_user']); }  if ( ( $this->wplubo6() > 0 ) && empty($_SESSION['memb_db_fields']) ) { $this->wplyte2(); } if ($this->license_status) { $this->wplmq6xl0(); add_post_type_support('sfwd-courses', 'excerpt'); add_post_type_support('sfwd-lessons', 'excerpt'); add_post_type_support('sfwd-topic', 'excerpt'); } } function wplk1zp_v() { if (! $this->admin_class) { $this->admin_class = new wpliebn; } return $this->admin_class; } function wplbg3oj() { if (! $this->frontend_class) { $this->frontend_class = new wpls3of8; } return $this->frontend_class; } function wplbdsm() { if (! $this->shortcodes) { $this->shortcodes = new wplnmq3bv; } return $this->frontend_class; } function wplwr8umh() { if ( (defined('DOING_AJAX') && DOING_AJAX) || (! is_admin() ) ) { $this->wplbg3oj(); $this->wplbdsm();   } if (! $this->license_status) {  }  include_once MEMBERIUM_LIB . '/vendor/wpal/blocks/init.php'; $vwplgitq = array( 'debug' => 0, 'debuglog' => 'error_log:', 'prefix' => 'is4wp', 'settings_title' => __('Memberium', 'memberium'), 'access_level_name' => __('Membership Level', 'memberium'), 'key_name' => __('Tag ID(s)', 'memberium'), 'keys_removed_text' => __('Notice : The following Tag ID(s) have been removed', 'memberium'), 'disabled_settings' => array('asset_id' => 0, 'invert_results' => 0), ); wplxnbwa($vwplgitq); if (class_exists('AppPresser')) { include_once MEMBERIUM_LIB . '/vendor/wpal/apppresser/apppresser.php'; } if (class_exists('BadgeOS') ) { include_once MEMBERIUM_LIB . '/ext/badgeos/badgeos.php'; } if (function_exists('bp_is_active') ) { include_once MEMBERIUM_LIB . '/ext/buddypress/buddypress.php'; } if (false) { if (defined('WPEP_VERSION') && version_compare(WPEP_VERSION, 1, '>=') ) { include_once MEMBERIUM_LIB . '/ext/elearncommerce/elearncommerce.php'; } } if (class_exists('GamiPress') ) { include_once MEMBERIUM_LIB . '/ext/gamipress/gamipress.php'; }  if (function_exists('buddypress') ) { add_action('xprofile_updated_profile', array('wplakxv', 'wplwnh7u'), 0, 5); } if (class_exists('SFWD_LMS') && defined('LEARNDASH_VERSION') && version_compare(LEARNDASH_VERSION, 3, '>=') ) { include_once MEMBERIUM_LIB . '/ext/learndash/learndash.php'; } if (defined('CT_VERSION')) { include_once MEMBERIUM_LIB_DIR . '/ext/oxygen/oxygen.php'; } if (class_exists('PeepSoGroupsPlugin') ) { include_once MEMBERIUM_LIB . '/ext/peepso-groups/peepso.php'; }  if (defined('LLMS_VERSION') ) { include_once MEMBERIUM_LIB . '/ext/lifterlms/lifterlms.php'; } if (class_exists('LearnPress') ) { include_once MEMBERIUM_LIB . '/ext/learnpress/learnpress.php'; }  if (function_exists('sensei') ) { include_once MEMBERIUM_LIB . '/ext/sensei/sensei.php'; }  if (defined('PROFILE_BUILDER_VERSION') ) { include_once MEMBERIUM_LIB . '/ext/profile-builder/index.php'; }  if (class_exists('GFCommon') ) { include_once MEMBERIUM_LIB . '/ext/gravity-forms/gravity-forms.php';  add_action('gform_editor_js', array($this, 'wplk3_076') ); add_action('gform_field_advanced_settings', array($this, 'wplrghfe'), 10, 2); add_action('gform_post_payment', array($this, 'wplc0vje'), 10, 2); add_filter('gform_form_settings', array($this, 'wplqr36g'), 10, 2); add_filter('gform_pre_form_settings_save', array($this, 'wplu5du6j'), 10, 2); }  if (class_exists('woocommerce') ) { new wplg6_7; }  } function wplei1pk() { $vwplj93jgm = get_registered_nav_menus(); $vwplgxrbm = wplz8bid::wplvf1d('memberships'); if (is_array($vwplj93jgm) ) {  foreach($vwplj93jgm as $vwply17edn => $vwplph268z) { unregister_nav_menu($vwply17edn); } foreach($vwplj93jgm as $vwply17edn => $vwplph268z) { register_nav_menu($vwply17edn, $vwplph268z); register_nav_menu('memberium|' . $vwply17edn . '|loggedin', '&nbsp;&nbsp;Logged In ' . $vwplph268z); foreach($vwplgxrbm as $tag_id => $vwplbquy) { if (empty($vwplbquy['dynamic_menus']) ) { register_nav_menu('memberium|' . $vwply17edn . '|' . $tag_id, '&nbsp;&nbsp;' . $vwplbquy['name'] . ' ' . $vwplph268z); } } } } } function wplkly4q($vwply4j8x, $vwplvtu6 = false) { global $wpdb; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwploosaj4 = array(); $vwply6dr = array(); $vwpllnqcf2 = array(); if (is_array($vwplvtu6) ) { foreach($vwplvtu6 as $k => $v) { $vwplvtu6[$k] = '_' . $v; } } if (is_array($vwply4j8x) ) { foreach($vwply4j8x as $vwplheakg) { if ($vwplheakg['FormId'] == -1) { $vwple2yn = '_' . $vwplheakg['Name']; $vwploosaj4[] = $vwple2yn; if ($vwplvtu6 !== false) { if (! in_array($vwple2yn, $vwplvtu6) ) { $vwpllnqcf2[] = $vwple2yn; } } } if ($vwplheakg['FormId'] == -3) { $vwply6dr[] = '_' . $vwplheakg['Name']; } } } if (! empty($vwploosaj4) ) { $vwplnzlj0t = MEMBERIUM_DB_CONTACTS; $vwplx1ap5_ = "DELETE FROM `{$vwplnzlj0t}` WHERE `appname` = '{$vwplw5rgd3}' AND `fieldname` LIKE '\_%' AND fieldname NOT IN ('" . trim(implode("', '", $vwploosaj4), ',') . "') "; $wpdb->query($vwplx1ap5_); } if (! empty($vwply6dr) ) { $vwplnzlj0t = MEMBERIUM_DB_AFFILIATES; $vwplx1ap5_ = "DELETE FROM `{$vwplnzlj0t}` WHERE `appname` = '{$vwplw5rgd3}' AND `fieldname` LIKE '\_%' AND fieldname NOT IN ('" . trim(implode("', '", $vwply6dr), ',') . "') "; $wpdb->query($vwplx1ap5_); } $vwplov_i = wplz8bid::wplvf1d('settings', 'ignore_contact_fields') . ',' . implode(',', $vwpllnqcf2); $vwplov_i = implode(',', array_unique(explode(',', $vwplov_i) ) ); wplz8bid::wpln095z($vwplov_i, 'ignore_contact_fields', 'settings');  } function wplspf_zg($vwpllzly5b) { if (empty($this->options['settings']['sync_new_wp_users']) ) { return; } if ($this->wply9rhd4() ) { return; } if (isset($_POST['createaccount']) && empty($_POST['createaccount']) ) { return; } global $wpdb; $vwplgogvie = get_userdata($vwpllzly5b); $vwplrp9u24 = array(); $vwplnwot = 0; $vwplup7mi = $this->options['settings']['password_field']; $vwplct26 = get_user_meta($vwpllzly5b); $vwpluufj = isset($_POST['action']) && $_POST['action'] == 'createuser' && isset($_POST['createuser']);  $vwplrp9u24['FirstName'] = ''; $vwplrp9u24['LastName'] = '';  if (isset($_POST['wp-submit']) && $_POST['wp-submit'] == 'Register') { $vwplrp9u24['FirstName'] = isset($_POST['firstname']) ? trim($_POST['firstname']) : $vwplrp9u24['FirstName']; $vwplrp9u24['LastName'] = isset($_POST['lastname']) ? trim($_POST['lastname']) : $vwplrp9u24['LastName']; } if ($vwpluufj) { $vwplrp9u24['FirstName'] = isset($_POST['first_name']) ? trim($_POST['first_name']) : $vwplrp9u24['FirstName']; $vwplrp9u24['LastName'] = isset($_POST['last_name']) ? trim($_POST['last_name']) : $vwplrp9u24['LastName']; } $vwplwu7y = trim($vwplrp9u24['FirstName'] . ' ' . $vwplrp9u24['LastName']); $vwplmsz8 = wplj_l2t::wplm_vec(); $vwplmsz8 = apply_filters('memberium_registration_field_map', $vwplmsz8); foreach($fields as $vwplyutg => $vwplcy_75) { if (isset($vwplct26[$vwplyutg][0]) ) { $vwplrp9u24[$vwplcy_75] = trim($vwplct26[$vwplyutg][0]); } }  foreach($vwplmsz8 as $vwplpcvt6r => $vwpljvqf) { if (isset($_POST[$vwplpcvt6r]) ) { $vwplrp9u24[$vwpljvqf] = $_POST[$vwplpcvt6r]; } } $vwplrp9u24['Email'] = $vwplgogvie->user_email;  if (empty($this->options['settings']['local_auth_only']) ) { $this->wpllq6u($vwplgogvie->user_email, 30); $vwplsfk1bd = MEMBERIUM_DB_CONTACTS; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwpl_2cd9 = $this->options['settings']['username_field']; $vwplup7mi = $this->options['settings']['password_field']; $vwplx1ap5_ = "
			SELECT
			COUNT(`{$vwplsfk1bd}`.`id`)
			FROM
			`{$vwplsfk1bd}`,
			`{$vwplsfk1bd}` as `{$vwplsfk1bd}_1`
			WHERE	`{$vwplsfk1bd}`.`appname`     = '{$vwplw5rgd3}'
			AND 	`{$vwplsfk1bd}`.`fieldname`   = '{$vwpl_2cd9}'
			AND		`{$vwplsfk1bd}`.`value`       = %s
			AND		`{$vwplsfk1bd}_1`.`id`        = `{$vwplsfk1bd}`.`id`
			AND		`{$vwplsfk1bd}_1`.`fieldname` = '{$vwplup7mi}'
			AND		`{$vwplsfk1bd}_1`.`value`     > ''
			ORDER BY `{$vwplsfk1bd}_1`.`id` ASC LIMIT 1"; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplgogvie->user_email); $vwpl_w3hc2 = (int) $wpdb->get_var($vwplx1ap5_); if ($vwpl_w3hc2 == 0) {  $vwplrp9u24[$vwplup7mi] = 'PASSWORD_PLACEHOLDER'; if (isset($_POST['pass1']) && ! empty($_POST['pass1']) ) { $vwplrp9u24[$vwplup7mi] = $_POST['pass1']; }  if (! empty($_POST['woocommerce-register-nonce']) ) { if (isset($_POST['password']) && ! empty($_POST['password']) ) { $vwplrp9u24[$vwplup7mi] = $_POST['password']; } } } } if (! empty($vwplnwot) ) { $vwplrp9u24['LeadSourceId'] = $vwplnwot; }  update_user_meta($vwpllzly5b, 'first_name', $vwplrp9u24['FirstName']); update_user_meta($vwpllzly5b, 'last_name', $vwplrp9u24['LastName']); $vwplgitq = array( 'user_id' => $vwpllzly5b, 'contact' => $_POST ); $vwplg9unv = $this->wplc4zac($vwplgitq) ; update_user_meta($vwpllzly5b, 'display_name', $vwplg9unv); update_user_meta($vwpllzly5b, 'nickname', $vwplg9unv); update_user_meta($vwpllzly5b, 'user_nicename', sanitize_title($vwplg9unv) ); add_filter('send_password_change_email', array($this, 'wplj4_rn8'), 999999, 3); $vwplgitq = array( 'ID' => $vwpllzly5b, 'display_name' => $vwplg9unv, 'nickname' => $vwplg9unv, 'user_nicename' => sanitize_title($vwplg9unv) ); wp_update_user($vwplgitq); remove_filter('send_password_change_email', array($this, 'wplj4_rn8'), 999999);  if (get_user_meta($vwpllzly5b, '_fb_is_sync', true) != 1) { $vwplvtmqd = (int) $this->isdk->addWithDupCheck($vwplrp9u24, 'Email'); $this->isdk->OptIn($vwplrp9u24['Email'], 'Membership Site Registration'); if ( (int) $this->options['settings']['new_user_registration_tag'] > 0) { $this->wplt263_(array($this->options['settings']['new_user_registration_tag']), $vwplvtmqd); } delete_user_meta($vwpllzly5b, '_fb_is_sync'); add_user_meta($vwpllzly5b, '_fb_is_sync', 1); } if ($vwplvtmqd) { $this->wplj9ye($vwplvtmqd); $this->wplaig81($vwplvtmqd, $vwpllzly5b); } } function wpluw8f7() { $vwpln_lstx = wplz8bid::wplvf1d('settings', 'makepass_scan_tag', 0); $vwplf748qb = wplz8bid::wplvf1d('settings', 'makepass_success_tag', 0); $vwplih1ow = wplz8bid::wplvf1d('settings', 'makepass_success_actionset', 0); if (! $vwpln_lstx || (! $vwplf748qb && ! $vwplih1ow) ) { return; } $vwplkjx4fs = wplycjh::wplwlamwg(0, 'cron', 'Start scanMakePass'); $vwplz81x75 = wplz8bid::wplvf1d('settings', 'makepass_scan_size', 5); $vwpl_2cd9 = wplz8bid::wplvf1d('settings', 'username_field', 5); $vwplup7mi = wplz8bid::wplvf1d('settings', 'password_field', 5); $vwplc0g3p = wpllbej::wplntnyv('Contact', true); $vwplv80sz = array( 'Groups' => $vwpln_lstx, ); $vwpl_w3hc2 = $this->isdk->dsQueryOrderBy('Contact', $vwplz81x75, 0, $vwplv80sz, $vwplc0g3p, 'LastUpdated', false); if (is_array($vwpl_w3hc2) ) { foreach($vwpl_w3hc2 as $vwplrp9u24) { $vwplvtmqd = isset($vwplrp9u24['Id']) ? (int) $vwplrp9u24['Id'] : 0; $vwplp25z = isset($vwplrp9u24[$vwpl_2cd9]) ? strtolower(trim($vwplrp9u24[$vwpl_2cd9]) ) : ''; $vwpljfjl = isset($vwplrp9u24[$vwplup7mi]) ? $vwplrp9u24[$vwplup7mi] : ''; $vwpllpv3k = $vwplrp9u24['Groups']; $vwpll5uo = false; $vwplbk4y2 = false; wplycjh::wplxc5ht_($vwplkjx4fs, "Contact ID = {$vwplvtmqd}, Username = {$vwplp25z}"); if (empty($vwplvtmqd) || empty($vwplp25z) ) { break; } if (empty($vwplrp9u24[$vwpl_2cd9]) ) { break; }  if (username_exists($vwplc_uoh4) || email_exists($vwplc_uoh4) ) { $this->wplt263_("-{$vwpln_lstx}", $vwplvtmqd); usleep(500000); $this->wplt263_($vwplf748qb, $vwplvtmqd); usleep(500000); break; } if (empty($vwplrp9u24[$vwplup7mi]) ) { $vwplrp9u24[$vwplup7mi] = $this->wpleh1zcw(); $vwplv09c = array( $vwplup7mi => $vwplrp9u24[$vwplup7mi], ); $vwplyio4f = $this->isdk->updateCon($vwplvtmqd, $vwplv09c);  } $this->wplto2h4($vwplrp9u24);  $vwpldj4of = array(); $vwpldj4of['user_login'] = $vwplrp9u24[$vwpl_2cd9]; $vwpldj4of['user_pass'] = $vwplrp9u24[$vwplup7mi]; $vwpldj4of['first_name'] = isset($vwplrp9u24['FirstName']) ? trim($vwplrp9u24['FirstName']) : ''; $vwpldj4of['last_name'] = isset($vwplrp9u24['LastName']) ? trim($vwplrp9u24['LastName']) : ''; $vwpldj4of['user_url'] = isset($vwplrp9u24['Website']) ? trim($vwplrp9u24['Website']) : ''; $vwpldj4of['user_email'] = isset($vwplrp9u24['Email']) ? strtolower(trim($vwplrp9u24['Email']) ) : ''; $vwplgitq = array('contact' => $vwplrp9u24); $_POST['pass1'] = $vwplrp9u24[$vwplup7mi]; $vwpldj4of['display_name'] = apply_filters('memberium/wpuser/display_name', $this->wplc4zac($vwplgitq), $vwplrp9u24); $vwpldj4of['nickname'] = apply_filters('memberium/wpuser/nickname', $vwpldj4of['display_name'], $vwplrp9u24); $vwpldj4of['user_nicename'] = apply_filters('memberium/wpuser/nicename', sanitize_title($vwpldj4of['nickname'], $vwpldj4of['display_name']), $vwplrp9u24); if (true) { $vwpl_ma6z = $this->wplqd_lae($vwplvtmqd); } else { add_filter('send_password_change_email', array($this, 'wplj4_rn8'), PHP_INT_MAX, 3); $vwpl_ma6z = wp_insert_user($vwpldj4of); remove_filter('send_password_change_email', array($this, 'wplj4_rn8'), PHP_INT_MAX); } if (is_int($vwpl_ma6z) && $vwpl_ma6z > 0) { $this->wplaig81($vwplvtmqd, $vwpl_ma6z); do_action('user_register', $vwpl_ma6z); if (is_multisite() && ! is_user_member_of_blog($vwpl_ma6z) ) { $vwpltycqk9 = get_current_blog_id(); $vwplwpqkj8 = get_blog_option($vwpltycqk9, 'default_role', 'subscriber'); add_user_to_blog($vwpltycqk9, $vwpl_ma6z, $vwplwpqkj8); } $rss_user_id = wplutf3y::wplr4pur($vwpl_ma6z); if (function_exists('WPCW_actions_users_newUserCreated') ) { WPCW_actions_users_newUserCreated($vwpl_ma6z); } } if (! empty($vwpln_lstx) ) { $this->wplt263_("-{$vwpln_lstx}", $vwplvtmqd); usleep(500000); } if (! empty($vwplf748qb) ) { $this->wplt263_($vwplf748qb, $vwplvtmqd); usleep(500000); } if (! empty($vwplih1ow) ) { $this->wplmupt($vwplih1ow, $vwplvtmqd); usleep(500000); } if (MEMBERIUM_ERRORLOG) error_log('scanMakePass Contact Id: ' . $vwplrp9u24['Id'], 0);  } } } function wplftqail() { $vwpllzly5b = get_current_user_id(); if (empty($vwpllzly5b) || is_super_admin() ) { $this->wplwxbl(0); if (isset($_SESSION) ) { unset($_SESSION['memb_db_fields']); } return; } $session_user_id = isset($_SESSION['memb_user']['Id']) ? $_SESSION['memb_user']['Id'] : 0; $regenerate_session = ! ($session_user_id == $vwpllzly5b); if (! $regenerate_session) { global $wpdb; $session_contact_id = wplsbzgvp::wplfhxj9(); $session_last_updated = wplsbzgvp::wplc4na('!lastupdated', 0); $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $table = MEMBERIUM_DB_CONTACTS; $vwplx1ap5_ = "SELECT `value` FROM `{$table}` WHERE `id` = %d AND `appname` = %s AND fieldname = '!LastUpdated' "; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $session_contact_id, $vwplw5rgd3); $db_timestamp = $wpdb->get_var($vwplx1ap5_); $regenerate_session = ($db_timestamp <> $session_last_updated); } if ($regenerate_session) { $_SESSION = $this->wplyte2($vwpllzly5b); } $this->wplwxbl( wplsbzgvp::wplfhxj9() ); } function wplqr1_k() { $this->wplklnfb(); $this->wplgtes(); }    function wplgyias() {  return wpllbej::wplgyias(); } function wpltsrka() { return (defined('REST_REQUEST ') && REST_REQUEST); } function wplmk6pf() { if (! headers_sent() ) { header('X-Powered-By: Memberium ' . $this->wplnm1h(), false); } } function wplvmehf6($vwplq9d7i2, $vwpllzly5b, $vwplqf5x, $vwplgzj6fs) { if ($this->doing_user_update) { return; } $vwplvtmqd = wpllbej::wplbmo_1($vwpllzly5b); if (! $vwplvtmqd) { return; } $vwplrz25u7 = wplj_l2t::wplm_vec(); if (isset($vwplrz25u7[$vwplqf5x]) ) { $vwple2yn = $vwplrz25u7[$vwplqf5x]; $this->wplox2qcd($vwple2yn, $meta_value, $vwplvtmqd); } }  function wplmq6xl0() { global $pagenow; if ('wp-login.php' == $pagenow) { if (class_exists('NextendSocialLogin') && ! empty($_GET['loginSocial'])) { return; } $vwplc9d4l = array( ); foreach($vwplc9d4l as $vwplkl_cw) { if (! empty($_GET[$vwplkl_cw]) ) { return; } } $vwploia7_d = empty($_GET['action']) ? '' : strtolower(trim($_GET['action']) ); $vwplkl_cw = array( 'override', 'resetpass', 'rp', 'switch_to_olduser', 'switch_to_user', ); if (in_array($vwploia7_d, $vwplkl_cw) ) { return; } $vwplbcu8 = apply_filters('memberium_wplogin_redirect', true); if (! $vwplbcu8) { return; } $vwplu32sji = wplz8bid::wplvf1d('settings', 'login_url', 0); if ($vwplu32sji < 1) { return; } if ($_SERVER['REQUEST_METHOD'] == 'GET') { $vwplnownk5 = empty($_GET['rp']) ? '' : $_GET['rp']; if (! empty($vwplnownk5) ) { return; } if (! empty($vwploia7_d) ) { if ($vwploia7_d == 'logout') { return; } if ($vwploia7_d == 'register') { return; } if ($vwploia7_d == 'lostpassword') { return; } } } if ($_SERVER['REQUEST_METHOD'] == 'POST') { if ($vwploia7_d == 'resetpass') { return; } if (isset($_POST['log']) && isset($_POST['pwd']) && empty($_POST['log']) && empty($_POST['pwd']) ) { } else { return; } } $vwplfkojlf = get_permalink(wplz8bid::wplvf1d('settings', 'login_url') ); $vwplmzn25 = empty($_SERVER['QUERY_STRING']) ? '' : '?' . $_SERVER['QUERY_STRING']; $vwplfkojlf = $vwplfkojlf . $vwplmzn25; wp_redirect($vwplfkojlf); die(); } }    static function wplm_vec() { $vwplmcop = array( 'account_first_name' => 'FirstName', 'account_last_name' => 'LastName', 'first_name' => 'FirstName', 'last_name' => 'LastName', 'billing_address_1' => 'StreetAddress1', 'billing_address_2' => 'StreetAddress2', 'billing_city' => 'City', 'billing_company' => 'Company', 'billing_country' => 'Country', 'billing_email' => 'Email', 'billing_phone' => 'Phone1', 'billing_postcode' => 'PostalCode', 'billing_state' => 'State', 'shipping_address_1' => 'Address2Street1', 'shipping_address_2' => 'Address2Street2', 'shipping_city' => 'City2', 'shipping_country' => 'Country2', 'shipping_email' => 'Email2', 'shipping_phone' => 'Phone2', 'shipping_postcode' => 'PostalCode2', 'shipping_state' => 'State2', ); return $vwplmcop; }    function wpllxp79n($vwpllzly5b) { static $vwplgq03 = false; if ($vwplgq03 === false) { $vwplgq03 = get_current_user_id(); } return ($vwpllzly5b == $vwplduxjo); } function wplj73cwb($vwplvtmqd) { static $vwplgon0p = false; if ($vwplgon0p === false) { $vwplgon0p = empty($_SESSION['memb_db_fields']['id']) ? 0 : $_SESSION['memb_db_fields']['id']; } return ($vwplgon0p == $vwplvtmqd); } function wplf_82is() {  if ($this->license_status) { if (empty($this->options['settings']['autoupdate']) ) { return; } } if (! is_writable(MEMBERIUM_HOME) ) { error_log('MEMBERIUM:  Autoupdate failed due to write permissions.'); return; } if (! function_exists('get_plugin_data') ) { require_once ABSPATH . 'wp-admin/includes/plugin.php'; } $vwplornd = wp_remote_get( $this->wple73mp() ); $vwplornd = is_array($vwplornd) ? $vwplornd = unserialize($vwplornd['body']) : array(); $vwpltalx = false; $vwpldu04m = get_plugin_data(MEMBERIUM_HOME, false, false); $vwplqa4r_ = (is_object($vwplornd) && property_exists($vwplornd, 'version') ) ? $vwplornd->version : ''; $vwpldxwy9n = $this->wplnm1h(); $vwplp5feya = version_compare($vwplqa4r_, $vwpldxwy9n, 'gt'); if ($vwplp5feya) {  ignore_user_abort();  require_once ABSPATH .'/wp-admin/includes/file.php';  require_once ABSPATH .'/wp-admin/includes/class-wp-filesystem-base.php'; $vwplwfqz = WP_PLUGIN_DIR; $vwplunjt8q = download_url($vwplornd->download_link, 300);  if (file_exists($vwplunjt8q) ) {   file_put_contents(ABSPATH . '.maintenance', '<?php $upgrading = time();'); WP_Filesystem(); require_once ABSPATH .'/wp-admin/includes/class-wp-filesystem-direct.php'; $vwplt49lo = new wp_filesystem_direct(null); $vwpltalx = $vwplt49lo->delete(MEMBERIUM_HOME_DIR, true); unzip_file($vwplunjt8q, $vwplwfqz); unlink($vwplunjt8q); $vwpltalx = true; } } if (file_exists(ABSPATH . '.maintenance') ) { unlink(ABSPATH . '.maintenance'); } return $vwpltalx; }    function wplwjd3g($vwplvtmqd, $vwplso1pw, $vwplph268z) { $this->dirty_contacts[$vwplvtmqd][$vwplso1pw] = $vwplph268z; } function wplklnfb() { if (empty($this->dirty_contacts) ) { return; } if (is_array($this->dirty_contacts) ) { foreach($this->dirty_contacts as $vwplvtmqd => $vwplmu62n) { if ($vwplvtmqd) { $this->i2sdk->isdk->updateCon( (int) $vwplvtmqd, $vwplmu62n); } } $vwplvtmqd = wplsbzgvp::wplfhxj9(); if ($vwplvtmqd) { if (! empty($this->dirty_contacts[$vwplvtmqd]) ) { foreach($this->dirty_contacts[$vwplvtmqd] as $vwplyq9i7o => $vwplcjpa) { $vwplyq9i7o = strtolower($vwplyq9i7o); wplsbzgvp::wplx9wl8g($vwplyq9i7o, $vwplcjpa); } } } $this->dirty_contacts = array(); } } function wplj4_rn8($vwplg2r_o, $vwplgogvie, $vwpldiz8) { return false; } function wplhx9wun($vwplc_uoh4, $vwplza3tq = false) { $vwpl_7b2 = $vwplc_uoh4; $vwplc_uoh4 = wp_strip_all_tags($vwplc_uoh4); $vwplc_uoh4 = remove_accents($vwplc_uoh4); $vwplc_uoh4 = preg_replace('|%([a-fA-F0-9][a-fA-F0-9])(\+)|', '', $vwplc_uoh4);  $vwplc_uoh4 = preg_replace('/&.?;/', '', $vwplc_uoh4);   if ($vwplza3tq) { $vwplc_uoh4 = preg_replace('|[^a-z0-9 _.\-@]|i', '', $vwplc_uoh4); } $vwplc_uoh4 = trim($vwplc_uoh4);  $vwplc_uoh4 = preg_replace('|\s+|', ' ', $vwplc_uoh4); return $vwplc_uoh4;  } function wpln6xe($vwplvtmqd = 0) { $vwplvtmqd = empty($vwplvtmqd) ? wplsbzgvp::wplfhxj9() : $vwplvtmqd; if (! $vwplvtmqd) { return false; } if ($vwplvtmqd > 0) { wp_cache_flush(); wp_cache_set('namespace_key', 1, 'memberium::user::' . $vwplvtmqd, 0); } }    function wplzjrmd($vwplvtmqd = 0) { $vwplvtmqd = empty($vwplvtmqd) ? wplsbzgvp::wplfhxj9() : $vwplvtmqd; if (! $vwplvtmqd) { return false; } if ($vwplvtmqd > 0) { $vwpl_cdy = wp_cache_get('namespace_key', 'memberium::user::' . $vwplvtmqd);  if ($vwpl_cdy === FALSE) { $vwpl_cdy = microtime(TRUE); wp_cache_set('namespace_key', $vwpl_cdy, 'memberium::user::' . $vwplvtmqd, 0); } } return $vwpl_cdy; } function wpld2pb() { global $wpdb; $vwplpmgra = get_option('memberium_updatecontact_scan_time', 0); $vwply4j8x = array(); $vwple7lbh = 0; $vwplf4d7ma = isset($this->options['settings']['updatecontact_scan_tag']) ? (int) $this->options['settings']['updatecontact_scan_tag'] : 0; $vwplzicr5 = ''; $vwplinof7 = 0; $vwplnzlj0t = 'Contact'; $vwplanieul = 1000; $vwplho_n = 0; $vwplc0g3p = wpllbej::wplntnyv('Contact', true);  $vwplv80sz = array( 'GroupName' => $vwplf4d7ma, 'LastUpdated' => date('YmdTH:i:s', $vwplpmgra), );  $vwpla54ov0 = MEMBERIUM_DB_CONTACTS; $vwplox9_3 = 0; do { set_time_limit(30); $vwpl_w3hc2 = $this->isdk->dsQueryOrderBy($vwplnzlj0t, $vwplanieul, $vwplho_n, $vwplv80sz, $vwplc0g3p, 'LastUpdated', true); if (is_array($vwpl_w3hc2) ) { $vwpljz9txv = array(); $vwplqzdlu3 = array(); foreach ($vwpl_w3hc2 as $vwplrp9u24) { foreach($vwplrp9u24 as $vwply17edn=>$vwplph268z) { if ($vwply17edn != $this->options['settings']['password_field']) { $vwplph268z = wp_strip_all_tags($vwplph268z); } else { $vwplph268z = ($vwplph268z <> 'null') ? html_entity_decode($vwplph268z) : ''; $vwpljz9txv[] = $wpdb->prepare('(%d, %s, %s, %s)', $id, $vwplw5rgd3, $vwply17edn, $vwplph268z); } } } $vwplx1ap5_ = "INSERT INTO {$vwpla54ov0} (id, appname, fieldname, value) VALUES " . implode(',', $vwpljz9txv) . " ON DUPLICATE KEY UPDATE id=VALUES(id), appname=VALUES(appname), fieldname=VALUES(fieldname), value=VALUES(value);"; unset($vwpljz9txv, $vwplph268z, $vwply17edn); $vwplyio4f = $wpdb->query($vwplx1ap5_); $vwplho_n++; $vwplox9_3 = $vwplox9_3 + count($vwpl_w3hc2); } usleep(500000); set_transient('memberium_updatecontact_scan_time', time() - 300); } while (count($vwpl_w3hc2) == $vwplanieul); } function wplweb_fk() {  $vwplieky = $this->isdk->dsGetSetting('Affiliate', 'chooseaffiliate'); $vwplam26ao = $this->isdk->dsGetSetting('Affiliate', 'use_referral_history'); $vwplg60739 = $this->isdk->dsGetSetting('Affiliate', 'aff_prefix');   } function wplxc63($vwplgitq) { if (is_user_logged_in() ) { if ( ! empty($this->options['settings']['dynamic_menus']) ) { $vwploj5o2 = $vwplgitq['theme_location']; $vwplli_4lr = get_theme_mod('nav_menu_locations'); $vwplcr3c9 = isset($_SESSION['memb_user']['membership_tags']) ? (explode(',', $_SESSION['memb_user']['membership_tags']) ) : array();  $vwply17edn = "memberium|{$vwploj5o2}|loggedin"; if (is_user_logged_in() && ! empty($vwplli_4lr[$vwply17edn]) ) { $vwplgitq['theme_location'] = $vwply17edn; } if (is_super_admin() ) { return $vwplgitq; }  if (is_array($vwplcr3c9) ) { foreach($vwplcr3c9 as $membership_tag) { $vwply17edn = "memberium|{$vwploj5o2}|{$membership_tag}"; if (! empty($vwplli_4lr[$vwply17edn]) ) { $vwplgitq['theme_location'] = $vwply17edn; } } } } } $vwplgitq['theme_location'] = apply_filters('memberium_personal_menus', $vwplgitq['theme_location']); return $vwplgitq; }     function wpln4nyq2($vwplun47e) { return hash_hmac('sha256', $vwplun47e, wp_salt('nonce') . wpll72jhi::wplol_bad() . $this->wplubo6() ); } function wplc3l0b($vwpltmfi, $vwplun47e) { return ($this->wpln4nyq2($vwplun47e) == $vwpltmfi); } function wpli0kwi($vwplwpg_6, $vwplyhcr_j, $vwplgogvie) { if (empty($_REQUEST['redirect_to']) ) { return ''; } return $vwplwpg_6; } function wpllhs2($vwplcltpy) { $vwpll1_x = get_post_status($vwplcltpy); return $vwpll1_x === 'publish'; } function wplu8b93m($vwplfkojlf) { global $wp_rewrite; $vwplfkojlf = apply_filters('wplu8b93m', $vwplfkojlf);  if (preg_match('#[?&](p|page_id|attachment_id)=(\d+)#', $vwplfkojlf, $vwplpe17) ) { $vwplopnf = absint($vwplpe17[2]); if ($vwplopnf) return $vwplopnf; }  $vwpln1dfxy = $wp_rewrite->wp_rewrite_rules();  if (empty($vwpln1dfxy) ) { return 0; }  $vwplamtla6 = explode('#', $vwplfkojlf); $vwplfkojlf = $vwplamtla6[0];  $vwplamtla6 = explode('?', $vwplfkojlf); $vwplfkojlf = $vwplamtla6[0];  if (false !== strpos(site_url(), '://www.') && false === strpos($vwplfkojlf, '://www.') ) { $vwplfkojlf = str_replace('://', '://www.', $vwplfkojlf); }  if (false === strpos(site_url(), '://www.') ) { $vwplfkojlf = str_replace('://www.', '://', $vwplfkojlf); }  if (!$wp_rewrite->using_index_permalinks() ) { $vwplfkojlf = str_replace('index.php/', '', $vwplfkojlf); } if (false !== strpos($vwplfkojlf, site_url() ) ) {  $vwplfkojlf = str_replace(site_url(), '', $vwplfkojlf); } else {  $vwplmji2 = parse_url(site_url() ); $vwplmji2 = isset($vwplmji2['path']) ? $vwplmji2['path'] : '' ; $vwplfkojlf = str_replace($vwplmji2, '', $vwplfkojlf); }  $vwplfkojlf = trim($vwplfkojlf, '/'); $vwplukr7m = $vwplfkojlf;  $vwplh4tlkc = $vwplukr7m; foreach ( (array) $vwpln1dfxy as $match => $vwplv80sz) {   if (!empty($vwplfkojlf) && ($vwplfkojlf != $vwplukr7m) && (strpos($match, $vwplfkojlf) === 0) ) $vwplh4tlkc = $vwplfkojlf . '/' . $vwplukr7m; if (preg_match("!^{$match}!", $vwplh4tlkc, $matches) ) {   $vwplv80sz = preg_replace("!^.+\?!", '', $vwplv80sz);  $vwplv80sz = addslashes(WP_MatchesMapRegex::apply($vwplv80sz, $matches) );  global $wp; parse_str($vwplv80sz, $query_vars); $vwplv80sz = array(); foreach ( (array) $query_vars as $vwply17edn => $vwplph268z) { if (in_array($vwply17edn, $wp->public_query_vars) ) $vwplv80sz[$vwply17edn] = $vwplph268z; } foreach ($GLOBALS['wp_post_types'] as $vwplo43m => $t) { if ($t->query_var) { $vwplx0th[$t->query_var] = $vwplo43m; } } foreach ($wp->public_query_vars as $wpvar) { if (isset($wp->extra_query_vars[$wpvar]) ) { $vwplv80sz[$wpvar] = $wp->extra_query_vars[$wpvar]; } elseif (isset($_POST[$wpvar]) ) { $vwplv80sz[$wpvar] = $_POST[$wpvar]; } elseif (isset($_GET[$wpvar]) ) { $vwplv80sz[$wpvar] = $_GET[$wpvar]; } elseif (isset($query_vars[$wpvar]) ) { $vwplv80sz[$wpvar] = $query_vars[$wpvar]; } if (!empty($vwplv80sz[$wpvar]) ) { if (! is_array($vwplv80sz[$wpvar]) ) { $vwplv80sz[$wpvar] = (string) $vwplv80sz[$wpvar]; } else { foreach ($vwplv80sz[$wpvar] as $vwpldbocw => $vwplcjpa) { if (!is_object($vwplcjpa) ) { $vwplv80sz[$wpvar][$vwpldbocw] = (string) $vwplcjpa; } } } if (isset($vwplx0th[$wpvar]) ) { $vwplv80sz['post_type'] = $vwplx0th[$wpvar]; $vwplv80sz['name'] = $vwplv80sz[$wpvar]; } } }  $vwplv80sz = new WP_Query($vwplv80sz); if (!empty($vwplv80sz->posts) && $vwplv80sz->is_singular) { return $vwplv80sz->post->ID; } else { return 0; } } } return 0; } function wpldt0xqb($vwpllzly5b = false) { } function wplyo16nv() { return self::VERSION; } function wplenfoxj() { $vwplsjdm = $_SERVER; $vwplfcgv = $_SESSION; $vwpll4_wye = $this->options['settings']['default_logout_page']; $vwplgxrbm = $this->options['memberships']; $vwplsjdm['HTTP_REFERER'] = isset($vwplsjdm['HTTP_REFERER']) ? $vwplsjdm['HTTP_REFERER'] : ''; $vwplwlb6m = empty($vwpll4_wye) ? site_url() : get_permalink($vwpll4_wye); $vwplwlb6m = str_replace('{{current.url}}', $vwplsjdm['HTTP_REFERER'], $vwplwlb6m); $vwpls0hwb5 = isset($vwplfcgv['memb_user']['membership_tags']) ? explode(',', $vwplfcgv['memb_user']['membership_tags']) : array(); $membership_level = 0; if (is_array($vwpls0hwb5) ) { foreach ($vwpls0hwb5 as $vwpltmveju) { if (isset($vwplgxrbm[$vwpltmveju]) ) { $vwplgxrbm[$vwpltmveju]['logout_page'] = (int) $vwplgxrbm[$vwpltmveju]['logout_page']; if ($vwplgxrbm[$vwpltmveju]['level'] >= $membership_level && $vwplgxrbm[$vwpltmveju]['logout_page'] > 0) { $membership_level = $vwplgxrbm[$vwpltmveju]['level']; if ($vwplgxrbm[$vwpltmveju]['logout_page'] > 0) { $vwplwlb6m = get_permalink($vwplgxrbm[$vwpltmveju]['logout_page']); } } } } } return $vwplwlb6m; } function wplk1ie7_() {  if ($this->sso_mode) { return true; }  if (isset($_COOKIE['nextend_uniqid']) && $_COOKIE['nextend_uniqid'] > '') { return true; }   return false; }    function wpllfqh_($vwply17edn, $vwplwxd1g = false) { if ($vwplwxd1g === false) { $writeback = true; $vwplwxd1g = (array) get_option('memberium_setup_completed'); } else { $writeback = false; } $vwplwxd1g[] = strtolower(trim($vwply17edn) ); $vwplwxd1g = array_filter(array_unique($vwplwxd1g) ); if ($writeback){ update_option('memberium_setup_completed', array_filter(array_unique($vwplwxd1g) ) ); } return $vwplwxd1g; }         function wplngsu($vwplgitq) { global $wpdb; $vwplsb_pf = array( 'table' => -1, 'type' => 19, ); $vwplgitq = wp_parse_args($vwplgitq, $vwplsb_pf); $vwplgitq['table'] = (int) $vwplgitq['table']; $vwplgitq['type'] = (int) $vwplgitq['type']; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplx1ap5_ = "SELECT concat('_', name) as `name` FROM `" . MEMBERIUM_DB_DATAFORMFIELDS . "` WHERE `appname` =  '{$vwplw5rgd3}' AND formid = " . (int) $vwplgitq['table'] . " AND datatype = " . (int) $vwplgitq['type']; $vwplmu62n = $wpdb->get_col($vwplx1ap5_); return $vwplmu62n; } static function wplr7fh($vwplvgq4) { $vwplw2u5im = function ($vwplm1dqej) { if ( is_array($vwplm1dqej) && ! empty($vwplm1dqej) ) { $vwplm1dqej = array_change_key_case($vwplm1dqej); } return $vwplm1dqej; }; $vwplvgq4 = array_filter(array_map($vwplw2u5im, array_change_key_case($vwplvgq4) ) ); return $vwplvgq4; }    function wplvnitod($vwplz4izhe) { global $wpdb; $vwplgogvie = get_user_by('email', $vwplz4izhe); if (is_object($vwplgogvie) ) { return (int) $vwplgogvie->ID; } return 0; }  function wplqja9w($vwplc3de, $vwplnukw, $vwplgitq) { if (empty($_SESSION['memb_user']['roles']) ) { return $vwplc3de; } $roles = isset($_SESSION['memb_user']['roles']) ? explode(',', trim($_SESSION['memb_user']['roles'], ',') ) : array(); foreach($roles as $role) { if ($role > '') { $vwplc3de[$role] = 1; } } return $vwplc3de; } function wplgei5($vwpllzly5b = 0) { if (! empty($vwpllzly5b) ) { $vwpllzly5b = get_current_user_id(); } if (user_can($vwpllzly5b, 'manage_options') ) { return; } $vwpl_6hq83 = get_user_meta($vwpllzly5b, 'session_tokens', true); if (is_array($vwpl_6hq83) && count($vwpl_6hq83) > 1) { $vwplpg5x = time();  $vwpli4pay = 0; foreach($vwpl_6hq83 as $vwply17edn=>$vwplph268z) { if ($vwplph268z['login'] > $vwpli4pay) { $vwpli4pay = $vwplph268z['login']; } }  foreach($vwpl_6hq83 as $vwply17edn=>$vwplph268z) { if ($vwplph268z['login'] < $vwpli4pay || $vwplph268z['expiration'] < $vwplpg5x) { unset($vwpl_6hq83[$vwply17edn]); } } update_user_meta($vwpllzly5b, 'session_tokens', $vwpl_6hq83); } } function wplky_5pc($vwplvtmqd = 0, $vwplc0nobe = false) { if (! is_array($vwplc0nobe) ) { $vwplc0nobe = array(); $vwplc0nobe['memb_user']['Groups'] = ''; $vwplc0nobe['memb_user']['membership_tags'] = ''; $vwplc0nobe['memb_user']['membership_names'] = ''; $vwplc0nobe['memb_user']['membership_level'] = 0; } if ($vwplvtmqd < 1) { return $vwplc0nobe; } global $wpdb; $vwplrp9u24 = wpllbej::wplrande($vwplvtmqd, false); $this->doing_user_update = true; foreach ($vwplrp9u24 as $vwply17edn=>$vwplph268z) { if (false) {  } $vwplc0nobe['memb_db_fields'][strtolower($vwply17edn)] = $vwplph268z; $this->doing_user_update = false; } if (! empty($vwplc0nobe['memb_db_fields']['groups']) ) { $vwplc0nobe['memb_user']['Groups'] = $vwplc0nobe['memb_db_fields']['groups']; $vwpls0hwb5 = explode(',', $vwplc0nobe['memb_db_fields']['groups']); $vwplmf6b = wplj_l2t::wplaajf(); $vwplmf6b = $vwplmf6b['mc']; $vwplmy5mc = array(); foreach ($vwpls0hwb5 as $vwplopnf => $vwpltmveju) { if (isset($vwplmf6b[$vwpltmveju]) ) { $vwpld4rum[] = $vwplmf6b[$vwpltmveju]; } } if (! empty($vwpld4rum) ) { $vwplc0nobe['memb_user']['GroupNames'] = implode(',', $vwpld4rum); } else { $vwplc0nobe['memb_user']['GroupNames'] = ''; } unset($vwpld4rum);  $vwplh_o09 = array(); $vwplg64r = array(); $vwplc0nobe['memb_user']['membership_level'] = 0; $vwplc0nobe['memb_user']['theme'] = ''; if (! isset($vwplc0nobe['memb_user']['roles']) ) { $vwplc0nobe['memb_user']['roles'] = ''; } $vwplluny3 = array(); if (is_array($this->options['memberships']) ) { foreach ($this->options['memberships'] as $vwplopnf => $vwplbquy) { if (in_array($vwplopnf, $vwpls0hwb5) && ! in_array($vwplbquy['payf_id'], $vwpls0hwb5) && ! in_array($vwplbquy['cancel_id'], $vwpls0hwb5) && ! in_array($vwplbquy['suspend_id'], $vwpls0hwb5) ) { if ($vwplbquy['level'] >= $vwplc0nobe['memb_user']['membership_level']) { $vwplc0nobe['memb_user']['membership_level'] = $vwplbquy['level']; $vwplc0nobe['memb_user']['login_page'] = $vwplbquy['login_page']; $vwplc0nobe['memb_user']['logout_page'] = $vwplbquy['logout_page'];  if (is_array($vwplbquy['roles']) ) { $vwplluny3 = array_merge($vwplluny3, $vwplbquy['roles']); } $vwplc0nobe['memb_user']['theme'] = isset($vwplbquy['theme']) ? $vwplbquy['theme'] : ''; $vwplh_o09[] = $vwplopnf; $vwplg64r[] = $vwplbquy['name']; } } if (count($vwplh_o09) > 0) { $vwplc0nobe['memb_user']['membership_tags'] = implode(',', $vwplh_o09); $vwplc0nobe['memb_user']['membership_names'] = implode(',', $vwplg64r); } } } if (! is_array($vwplluny3) ) { $vwplluny3 = array(); } $vwplc0nobe['memb_user']['roles'] = implode(',', array_unique($vwplluny3) ); unset($vwplluny3); } return $vwplc0nobe; } function wplne7ys2() { unset($_SESSION['memb_user']); unset($_SESSION['memb_db_fields']); } function wply1v_i4($vwplgitq = array() ) { $vwplvtmqd = isset($vwplgitq['contact_id']) ? $vwplgitq['contact_id'] : 0; if (! $vwplvtmqd) { } if (! $vwplvtmqd) { return false; } $vwplqgcvs = wplz8bid::wplvf1d('settings', 'sync_affiliate'); if ($vwplqgcvs) { $this->wplei4rgx($vwplvtmqd); } } function wplyte2($vwpllzly5b = false, $vwplvtmqd = false) { global $wpdb;  if (! wpln9_s::wplio5sck() ) { return isset($_SESSION) ? $_SESSION : array(); } if ($vwpllzly5b == false && $vwplvtmqd !== false) { $vwpllzly5b = wpllbej::wplsgpnk($vwplvtmqd); } if (! $vwpllzly5b) { $vwpllzly5b = get_current_user_id(); } if ($vwpllzly5b < 1) { return isset($_SESSION) ? $_SESSION : array(); } $vwplpuhm4 = (bool) (get_current_user_id() === $vwpllzly5b);  if ($vwplpuhm4) { $vwplc0nobe = isset($_SESSION) ? $_SESSION : array(); $vwplc0nobe['memb_user'] = isset($_SESSION['memb_user']) ? $_SESSION['memb_user'] : array(); $vwplvtmqd = $this->wpldti9(); } else { $vwplc0nobe = array(); unset($vwplc0nobe['memb_user'], $vwplc0nobe['memb_db_fields']); } if ($vwpllzly5b) { $this->doing_user_update = true; delete_option('um_cache_userdata_' . $vwpllzly5b); $this->wplnpey($vwpllzly5b); $vwplgogvie = get_user_by('id', $vwpllzly5b);  if (! empty($vwplgogvie->user_email) ) { $vwpln0fq1 = $vwplgogvie->user_email; } else { $vwpln0fq1 = $vwplgogvie->user_login; }     if (! $vwplvtmqd) { $vwplvtmqd = wpllbej::wplbmo_1($vwplgogvie->ID); if (! $vwplvtmqd) { $vwplvtmqd = (int) $this->wplmgxs3($vwpln0fq1); } } if ($vwplpuhm4) { $this->wplwxbl($vwplvtmqd); } $vwplc0nobe['memb_user']['Id'] = $vwplgogvie->ID; $vwplc0nobe['memb_user']['Email'] = $vwplgogvie->user_email; $vwplc0nobe['memb_user']['FirstName'] = $vwplgogvie->user_firstname; $vwplc0nobe['memb_user']['LastName'] = $vwplgogvie->user_lastname; $vwplc0nobe['memb_user']['DisplayName'] = $vwplgogvie->display_name; $vwplc0nobe['memb_user']['LoginName'] = $vwplgogvie->user_login; $vwplc0nobe['memb_user']['source'] = 'local'; $vwplc0nobe['memb_user']['languages'] = wplixy6zk::wpluuiq(); $vwplc0nobe['memb_user']['session_id'] = session_id(); if (user_can($vwplgogvie, 'manage_options') ) { $vwplc0nobe['memb_user']['source'] = 'local'; if ($vwplpuhm4) { $_SESSION = $vwplc0nobe; } return $vwplc0nobe; } if (! isset($vwplc0nobe['memb_user']['login']) ) { $vwplc0nobe['memb_user']['login'] = time(); } if (! isset($vwplc0nobe['memb_user']['nextupdate']) ) { $vwplc0nobe['memb_user']['nextupdate'] = ''; } if ($vwplvtmqd > 0) { $this->wplaig81($vwplvtmqd, $vwpllzly5b); $this->wpln6xe($vwplvtmqd); $vwpla54ov0 = MEMBERIUM_DB_CONTACTS; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplrp9u24 = wpllbej::wplrande($vwplvtmqd, false); if (is_array($vwplrp9u24) && ! empty($vwplrp9u24) ) { $vwplc0nobe['memb_user']['source'] = 'infusionsoft'; if (! empty($this->options['settings']['sync_meta_updates']) ) { $vwplnzlj0t = $wpdb->usermeta; $vwplhp2c5k = "memb\_%"; $vwplx1ap5_ = "SELECT `meta_key`, `meta_value` FROM {$vwplnzlj0t} WHERE `user_id` = {$vwpllzly5b} AND `meta_key` LIKE '{$vwplhp2c5k}' "; $vwplrflk5 = $wpdb->get_results($vwplx1ap5_, OBJECT_K); } foreach ($vwplrp9u24 as $vwply17edn=>$vwplph268z) { if (! empty($this->options['settings']['sync_meta_updates']) ) { $vwplyutg = "memb_{$vwply17edn}"; if (! isset($vwplrflk5[$vwplyutg]->meta_value) || $vwplrflk5[$vwplyutg]->meta_value <> $vwplph268z) { update_user_meta($vwpllzly5b, $vwplyutg, $vwplph268z); } } $vwplc0nobe['memb_db_fields'][strtolower($vwply17edn)] = $vwplph268z; }  if (function_exists('xprofile_set_field_data') ) { wplakxv::wpln2o0dr($vwplrp9u24, $vwpllzly5b); } $this->doing_user_update = false;  $vwplc0nobe['memb_user']['crm_id'] = $vwplvtmqd; $vwplc0nobe['memb_user']['Groups'] = isset($vwplc0nobe['memb_db_fields']['groups']) ? $vwplc0nobe['memb_db_fields']['groups'] : ''; $vwplc0nobe['memb_user']['payf_homepage'] = isset($vwplc0nobe['memb_user']['payf_homepage']) ? $vwplc0nobe['memb_user']['payf_homepage'] : 0; $vwplc0nobe['memb_user']['susp_homepage'] = isset($vwplc0nobe['memb_user']['susp_homepage']) ? $vwplc0nobe['memb_user']['susp_homepage'] : 0; $vwplc0nobe['memb_user']['canc_homepage'] = isset($vwplc0nobe['memb_user']['canc_homepage']) ? $vwplc0nobe['memb_user']['canc_homepage'] : 0; $vwplc0nobe['memb_user']['membership_tags'] = ''; $vwplc0nobe['memb_user']['membership_names'] = ''; $vwplc0nobe['memb_user']['membership_level'] = 0; if (! empty($vwplc0nobe['memb_db_fields']['groups']) ) { $vwplc0nobe['memb_user']['Groups'] = $vwplc0nobe['memb_db_fields']['groups']; $vwpls0hwb5 = explode(',', $vwplc0nobe['memb_db_fields']['groups']); $vwplmf6b = wplj_l2t::wplaajf(); $vwplmf6b = $vwplmf6b['mc']; $vwplmy5mc = array(); foreach ($vwpls0hwb5 as $vwplopnf=>$tag) { if (isset($vwplmf6b[$tag]) ) { $tag_names[] = $vwplmf6b[$tag]; } } if (! empty($tag_names) ) { $vwplc0nobe['memb_user']['GroupNames'] = implode(MEMBERIUM_DELIMITER, $tag_names); } else { $vwplc0nobe['memb_user']['GroupNames'] = ''; } unset($tag_names);  $vwplh_o09 = array(); $vwplg64r = array(); $vwplc0nobe['memb_user']['membership_level'] = 0; $vwplc0nobe['memb_user']['theme'] = ''; $vwplc0nobe['memb_user']['login_page'] = 0; $vwplluny3 = array(); $redirection_level = -1; if (! isset($vwplc0nobe['memb_user']['roles']) ) { $vwplc0nobe['memb_user']['roles'] = ''; } $redirection_level = -1; if (is_array($this->options['memberships']) ) { foreach ($this->options['memberships'] as $vwplopnf => $vwplbquy) { $vwplbquy['susp_id'] = isset($vwplbquy['susp_id']) ? $vwplbquy['susp_id'] : 0; $vwplbquy['canc_id'] = isset($vwplbquy['canc_id']) ? $vwplbquy['canc_id'] : 0; $vwplbquy['payf_id'] = isset($vwplbquy['payf_id']) ? $vwplbquy['payf_id'] : 0; $vwplbquy['addltag_ids'] = isset($vwplbquy['addltag_ids']) ? $vwplbquy['addltag_ids'] : ''; $has_primary_tag = in_array($vwplopnf, $vwpls0hwb5); $has_alt_tags = (bool) count(array_intersect($vwpls0hwb5, explode(',', $vwplbquy['addltag_ids']) ) ); $has_payf_tag = (bool) in_array($vwplbquy['payf_id'], $vwpls0hwb5); $has_susp_tag = (bool) in_array($vwplbquy['suspend_id'], $vwpls0hwb5); $has_canc_tag = (bool) in_array($vwplbquy['cancel_id'], $vwpls0hwb5);  if ($has_primary_tag || $has_alt_tags) { if ($has_payf_tag || $has_canc_tag || $has_susp_tag) { if (intval($vwplbquy['login_redirect_priority']) >= $redirection_level) { if (empty($vwplc0nobe['memb_user']['login_page']) ) { $vwplc0nobe['memb_user']['login_page'] = $has_payf_tag ? $vwplbquy['payf_homepage'] : $vwplc0nobe['memb_user']['login_page']; $vwplc0nobe['memb_user']['login_page'] = $has_susp_tag ? $vwplbquy['susp_homepage'] : $vwplc0nobe['memb_user']['login_page']; $vwplc0nobe['memb_user']['login_page'] = $has_canc_tag ? $vwplbquy['canc_homepage'] : $vwplc0nobe['memb_user']['login_page']; } $redirection_level = isset($vwplbquy['login_redirect_priority']) ? $vwplbquy['login_redirect_priority'] : 0; } } else { if ($vwplbquy['level'] >= $vwplc0nobe['memb_user']['membership_level']) { if (is_array($vwplbquy['roles']) && ! empty($vwplbquy['roles']) ) { $vwplluny3 = array_merge($vwplluny3, $vwplbquy['roles']); } $vwplc0nobe['memb_user']['theme'] = isset($vwplbquy['theme']) ? $vwplbquy['theme'] : ''; $vwplh_o09[] = $vwplopnf; $vwplg64r[] = $vwplbquy['name']; $vwplc0nobe['memb_user']['membership_level'] = $vwplbquy['level']; } if (intval($vwplbquy['login_redirect_priority']) >= $redirection_level) { $vwplc0nobe['memb_user']['login_page'] = isset($vwplbquy['login_page']) ? $vwplbquy['login_page'] : 0; $vwplc0nobe['memb_user']['first_login_page'] = isset($vwplbquy['first_login_page']) ? $vwplbquy['first_login_page'] : 0; $vwplc0nobe['memb_user']['logout_page'] = isset($vwplbquy['logout_page']) ? $vwplbquy['logout_page'] : 0; $redirection_level = isset($vwplbquy['login_redirect_priority']) ? $vwplbquy['login_redirect_priority'] : 0; } } } } if (count($vwplh_o09) > 0) { $vwplc0nobe['memb_user']['membership_tags'] = implode(',', $vwplh_o09); $vwplc0nobe['memb_user']['membership_names'] = implode(',', $vwplg64r); } unset($memberships, $vwplbquy, $vwplopnf, $redirection_level, $has_primary_tag, $has_alt_tags, $has_payf_tag, $has_susp_tag, $has_canc_tag, $has_list_id); } if (! is_array($vwplluny3) ) { $vwplluny3 = array(); } $vwplc0nobe['memb_user']['roles'] = implode(',', array_unique($vwplluny3) ); unset($vwplluny3); }  $vwplnn16 = wplz8bid::wplvf1d('settings', 'sync_tag_details'); if ($vwplnn16) { $vwplx1ap5_ = 'SELECT COUNT(*) FROM `' . MEMBERIUM_DB_CONTACTTAGS . '` WHERE `contactid` = ' . $vwplvtmqd . ';'; $vwplc0nobe['memb_user']['tag_detail_count'] = (int) $wpdb->get_var($vwplx1ap5_); } else { $vwplc0nobe['memb_user']['tag_detail_count'] = 0; }   $vwplqgcvs = wplz8bid::wplvf1d('settings', 'sync_affiliate'); if ($vwplqgcvs) { if (empty($vwplc0nobe['memb_db_fields']['affiliate.id']) ) {   $vwpla54ov0 = MEMBERIUM_DB_AFFILIATES; $vwplx1ap5_ = "
							SELECT
							`{$vwpla54ov0}_2`.`fieldname`,
							`{$vwpla54ov0}_2`.`value`
							FROM
							`{$vwpla54ov0}`,
							`{$vwpla54ov0}` AS `{$vwpla54ov0}_2`
							WHERE	`{$vwpla54ov0}`.`appname`  = '{$vwplw5rgd3}'
							AND 	`{$vwpla54ov0}`.`fieldname` = 'ContactId'
							AND		`{$vwpla54ov0}`.`value`     = %d
							AND		`{$vwpla54ov0}_2`.`id`      = {$vwpla54ov0}.id
							AND		`{$vwpla54ov0}_2`.`appname` = '{$vwplw5rgd3}'; "; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplvtmqd); $vwpltsywc = $wpdb->get_results($vwplx1ap5_, ARRAY_N); foreach ($vwpltsywc as $vwplheakg) { $vwplc0nobe['memb_db_fields']['affiliate.' . strtolower($vwplheakg[0])] = $vwplheakg[1]; } $vwplc0nobe['memb_db_fields']['affiliate.id'] = (isset($vwplc0nobe['memb_db_fields']['affiliate.id']) ) ? $vwplc0nobe['memb_db_fields']['affiliate.id'] : 0; } } } } } else {  } if (isset($vwplgogvie) && is_a($vwplgogvie, 'WP_User') ) { $this->wplqd_lae($vwplvtmqd); $vwplc0nobe = apply_filters('memberium_session_filter', $vwplc0nobe); $vwplc0nobe = $this->wplinzb($vwpllzly5b, $vwplc0nobe); do_action('memberium_session_regenerated', $vwpllzly5b, $vwplc0nobe);  $this->wplkbsp4($vwpllzly5b, $vwplc0nobe); $this->wpllb06oc($vwpllzly5b, $vwplc0nobe); if (isset($vwplc0nobe['memb_user']['roles']) ) { $this->wplnvgd4k($vwplc0nobe['memb_user']['roles'], $vwpllzly5b); } do_action('memberium_session_created', $vwplc0nobe);  } $this->doing_user_update = false; return $vwplc0nobe; } function wplvxzrh6($vwplidgcy = false) { if ($vwplidgcy) { return $this->options['memberships']; } else { $vwplgxrbm = array(); foreach($this->options['memberships'] as $vwplopnf => $vwplbquy) { $vwplgxrbm[] = $vwplbquy[$vwplso1pw]; } return $vwplgxrbm; } } private function wplinzb($vwpllzly5b = 0, $vwplc0nobe = array() ) {  $vwplurqb3 = get_user_meta($vwpllzly5b, 'memberium_issue_subs', true); $vwplpg5x = time(); if (is_array($vwplurqb3) ) { foreach($vwplurqb3 as $vwplm_r03) { $vwplljlq = $vwplm_r03['channel']; $vwplzoy9a = $vwplm_r03['cat_id']; $vwpliilvm = $vwplm_r03['tagcount']; $vwplgjp7v = $vwplm_r03['start_time']; $vwplo3na = $vwplm_r03['date_format']; while ($vwplgjp7v < $vwplpg5x) { } } }   return $vwplc0nobe; } function wplnpey($vwpllzly5b = 0) { if (is_super_admin() ) { return; } global $wpdb; $vwpllzly5b = (int) $vwpllzly5b; if ($vwpllzly5b == 0){ $vwpllzly5b = isset($_SESSION['memb_user']['Id']) ? $_SESSION['memb_user']['Id'] : get_current_user_id(); } if ($vwpllzly5b > 0) { $vwplgogvie = get_user_by('id', $vwpllzly5b); $vwplcdmh2 = array_filter(explode(',', get_user_meta($vwpllzly5b, 'memberium_roles', true) ) );  foreach($vwplcdmh2 as $vwpl_ecm2) { if (! empty($vwpl_ecm2) ) { $vwplgogvie->remove_role($vwpl_ecm2); } } update_user_meta($vwpllzly5b, 'memberium_roles', ''); } } function wplkbsp4($vwpllzly5b, $vwplc0nobe) { if (! function_exists('Sensei') ) { return; } global $wpdb;  $vwplwc60 = $wpdb->posts; $vwplz39do = $wpdb->postmeta; $vwplx1ap5_ = "SELECT ID, meta_value FROM {$vwplwc60}, {$vwplz39do} WHERE post_status = 'publish' AND post_type = 'course' AND  post_id = ID AND meta_key = '_is4wp_learndash_autoenroll' AND meta_value > '' "; $vwplob9i24 = $wpdb->get_results($vwplx1ap5_, ARRAY_A); if (is_array($vwplob9i24) && ! empty($vwplob9i24) ) {  foreach ($vwplob9i24 as $vwplzzlf5b) { $vwplsig4ju = wplj_l2t::wpl_n2s9($vwplzzlf5b['meta_value'], $vwplc0nobe); if ($vwplsig4ju) { Sensei_Utils::user_start_course($vwpllzly5b, $vwplzzlf5b['ID']);  } else { sensei_utils::sensei_remove_user_from_course($vwplzzlf5b['ID'], $vwpllzly5b);  } } } } function wpllb06oc($vwpllzly5b, $vwplc0nobe) { if (! function_exists('WPCW_courses_syncUserAccess') ) { return; } $vwpll8rap = get_option('memberium_wpcw', array() ); $vwpll8rap = isset($vwpll8rap['courses']['access_tags']) ? $vwpll8rap['courses']['access_tags'] : array(); $vwplyk9mp = WPCW_users_getUserCourseList($vwpllzly5b); $vwplbek2 = array();  foreach($vwplyk9mp as $vwplknsp1) { $vwplvbkdn = $vwplknsp1->course_id; $vwplim53 = isset($vwpll8rap[$vwplvbkdn]) ? $vwpll8rap[$vwplvbkdn] : ''; if ($vwplknsp1->course_opt_user_access == 'default_show') { $vwplbek2[] = $vwplvbkdn; } elseif (! empty($vwplim53) ) { if (wplj_l2t::wpl_n2s9($vwplim53, $vwplc0nobe) ) { $vwplbek2[] = $vwplvbkdn; } } } foreach($vwpll8rap as $vwplvbkdn => $vwplim53) { if (wplj_l2t::wpl_n2s9($vwplim53, $vwplc0nobe) ) { $vwplbek2[] = $vwplvbkdn; } }  $vwplbek2 = array_unique($vwplbek2); WPCW_courses_syncUserAccess($vwpllzly5b, $vwplbek2, 'sync'); } function wplozfya($vwpllzly5b) { global $wpdb; $vwpllzly5b = (int) $vwpllzly5b; if ($vwpllzly5b == 0){ $vwpllzly5b = isset($_SESSION['memb_user']['Id']) ? $_SESSION['memb_user']['Id'] : get_current_user_id(); $vwpleioy0b = true; } else { $vwpleioy0b = false; } } function wplnvgd4k($vwplsdm1vb = array(), $vwpllzly5b = 0) { global $wpdb; if (is_string($vwplsdm1vb) ) { $vwplsdm1vb = array_filter(array_map('trim', explode(',', $vwplsdm1vb) ) ); } if ($vwpllzly5b == 0){ $vwpllzly5b = isset($_SESSION['memb_user']['Id']) ? $_SESSION['memb_user']['Id'] : get_current_user_id(); } if (empty($vwplsdm1vb) && isset($_SESSION['memb_user']['roles']) ) { $vwplsdm1vb = array_filter(explode(',', $_SESSION['memb_user']['roles']) ); } $vwplgogvie = get_user_by('id', $vwpllzly5b); if (method_exists($vwplgogvie, 'add_role') ) { $vwplby_wp = strval(get_user_meta($vwpllzly5b, 'memberium_roles', true) ); if ($vwplby_wp > '') { $vwplby_wp = array_filter(explode(',', $vwplby_wp) ); } else { $vwplby_wp = array(); } $vwplkur4c = $vwplsdm1vb; $vwpldqbt = array();  foreach($vwplby_wp as $vwpl_ecm2) { if (! empty($vwpl_ecm2) ) { $vwplgogvie->remove_role($vwpl_ecm2); } }   if (is_array($vwplkur4c) && ! empty($vwplkur4c) ) { $vwpldkp7 = array_unique($vwplkur4c); $vwplam1tw0 = array(); if (! empty($vwpldkp7) ) { foreach($vwpldkp7 as $vwpl_ecm2) { if (! in_array($vwpl_ecm2, $vwplgogvie->roles) ) { $vwplam1tw0[] = $vwpl_ecm2; $vwplgogvie->add_role($vwpl_ecm2); } } update_user_meta($vwpllzly5b, 'memberium_roles', implode(',', $vwplam1tw0) ); } } }  } function wplae9h0($vwplvtmqd = 0) { if ($vwplvtmqd == 0 || wplsbzgvp::wplfhxj9() == $vwplvtmqd) {  $vwpleioy0b = true; $vwpls0hwb5 = explode(',', wplsbzgvp::wplc4na('groups') ); } else {  $vwpleioy0b = false; $vwplrp9u24 = wpllbej::wplrande($vwplvtmqd, true); $vwpls0hwb5 = explode(',', empty($vwplrp9u24['groups']) ? '' : $vwplrp9u24['groups']); } $vwplyio4f = array(); $vwplh_o09 = array(); $vwplg64r = array(); $vwplcr3c9 = ''; $vwplcfbn6r = 0; $vwplomr_ = ''; $vwplkxvwd = ''; foreach ( (array) $this->options['memberships'] as $vwplopnf => $vwplbquy) { $vwplnjc87 = false;  if (in_array($vwplopnf, $vwpls0hwb5) && ! in_array($vwplbquy['payf_id'], $vwpls0hwb5) && ! in_array($vwplbquy['cancel_id'], $vwpls0hwb5) && ! in_array($vwplbquy['suspend_id'], $vwpls0hwb5) ) { $vwplnjc87 = true; }   if ($vwplnjc87) { $vwplcfbn6r = ($vwplbquy['level'] > $vwplcfbn6r ? $vwplbquy['level'] : $vwplcfbn6r); $vwplh_o09[] = $vwplopnf; $vwplg64r[] = $vwplbquy['name']; $vwplry7kig[] = implode(',', isset($vwplbquy['roles']) ? $vwplbquy['roles'] : array() ); } } if (count($vwplh_o09) > 0) { $vwplcr3c9 = implode(',', $vwplh_o09); $vwplomr_ = implode(',', $vwplg64r); $vwplkxvwd = trim(implode(',', $vwplry7kig), ','); } if ($vwpleioy0b) { $_SESSION['memb_user']['membership_level'] = $vwplcfbn6r; $_SESSION['memb_user']['membership_tags'] = $vwplcr3c9; $_SESSION['memb_user']['membership_names'] = $vwplomr_; } $vwplyio4f['membership_level'] = $vwplcfbn6r; $vwplyio4f['membership_tags'] = $vwplcr3c9; $vwplyio4f['membership_names'] = $vwplomr_; $vwplyio4f['roles'] = $vwplkxvwd; return $vwplyio4f; } function wplc1gh($vwpltidk1 = 20) { global $wpdb; $vwpltidk1 = (int) $vwpltidk1; $vwplx1ap5_ = "SELECT {$wpdb->users}.*, {$wpdb->usermeta}.meta_key FROM {$wpdb->users} LEFT OUTER JOIN {$wpdb->usermeta} ON ({$wpdb->usermeta}.user_id = {$wpdb->users}.ID AND {$wpdb->usermeta}.meta_key = 'infusionsoft_user_id') WHERE {$wpdb->usermeta}.meta_key IS NULL LIMIT {$vwpltidk1};";  $vwplx1ap5_ = "SELECT {$wpdb->users}.* FROM {$wpdb->users} LEFT OUTER JOIN {$wpdb->usermeta} ON ({$wpdb->usermeta}.user_id = {$wpdb->users}.ID AND {$wpdb->usermeta}.meta_key = 'infusionsoft_user_id') WHERE {$wpdb->usermeta}.meta_key IS NULL LIMIT {$vwpltidk1};";  $vwplwcre = $wpdb->get_results($vwplx1ap5_, ARRAY_A); foreach($vwplwcre as $vwplgogvie) {  $vwplrp9u24 = array(); $vwplrp9u24['Email'] = $vwplgogvie['user_email']; $vwplrp9u24['Leadsource'] = 'Memberium User Sync'; if (! empty($vwplgogvie['user_url']) ) { $vwplrp9u24['Website'] = $vwplgogvie['user_url']; } if (! empty($vwplgogvie['user_nicename']) ) { $vwplrp9u24['Nickname'] = $vwplgogvie['user_nicename']; } $vwplx1ap5_ = "SELECT {$wpdb->usermeta}.meta_key, {$wpdb->usermeta}.meta_value FROM {$wpdb->usermeta} WHERE user_id = {$vwplgogvie['ID']};"; $vwplct26 = $wpdb->get_results($vwplx1ap5_, ARRAY_A); $vwplvj7ip = wplj_l2t::wplm_vec(); foreach($vwplct26 as $vwply4fkhi) { foreach ($vwplvj7ip as $vwplnjbvm5=>$vwplyeb8d) { if ($vwply4fkhi['meta_key'] == $vwplnjbvm5 && ! empty($vwply4fkhi['meta_value']) ) { $vwplrp9u24[$vwplyeb8d] = $vwply4fkhi['meta_value']; } } } if (isset($vwplrp9u24['Country']) ) { $vwplrp9u24['Country'] = wplr6om::wpljeuy93($vwplrp9u24['Country']); } if (isset($vwplrp9u24['Country2']) ) { $vwplrp9u24['Country2'] = wplr6om::wpljeuy93($vwplrp9u24['Country2']); } if (isset($vwplrp9u24['Country3']) ) { $vwplrp9u24['Country3'] = wplr6om::wpljeuy93($vwplrp9u24['Country3']); } set_time_limit(30); $vwplvtmqd = $this->isdk->addWithDupCheck($vwplrp9u24, 'Email'); $this->isdk->optin($vwplrp9u24['Email'], 'Memberium User Sync'); sleep(1); $this->wplaig81($vwplvtmqd, $vwplgogvie['ID']); } if ($vwplzstb && (count($vwplwcre) == $vwpltidk1) ) { header('Location: ' . $_SERVER['REQUEST_URI']); echo '<meta http-equiv="refresh" content="1;URL=\'"', $_SERVER['REQUEST_URI'], '\'" /> '; exit; } }  function wplun7pt5($vwplvtmqd, $vwplmu62n, $vwplnjhzm = false) { foreach($vwplmu62n as $vwplmoe2 => $vwplb5yh) { $this->wplox2qcd($vwplmoe2, $vwplb5yh, $vwplvtmqd); } if ($vwplnjhzm) { $this->wplklnfb(); if ($vwplvtmqd == $this->wplubo6() ) { $_SESSION = $this->wplyte2(); } } } function wplox2qcd($vwplmoe2, $vwplb5yh, $vwplvtmqd = 0) { global $wpdb; if (! $vwplvtmqd && $this->wplubo6() > 0) { $vwplvtmqd = $this->wplubo6(); } if (! $vwplvtmqd) { return false; } $this->dirty_contacts[$vwplvtmqd][$vwplmoe2] = $vwplb5yh;  $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplb6wpex = array( 'id' => $vwplvtmqd, 'appname' => $vwplw5rgd3, 'fieldname' => $vwplmoe2, 'value' => $vwplb5yh ); $vwplkcuf17 = array( '%d', '%s', '%s', '%s' ); $wpdb->replace(MEMBERIUM_DB_CONTACTS, $vwplb6wpex, $vwplkcuf17);  $vwplq_baoi = strtolower($vwplmoe2); if ($vwplvtmqd == wplsbzgvp::wplfhxj9() ) { wplsbzgvp::wplx9wl8g($vwplq_baoi, $vwplb5yh); } return true; } function wplqrq4d($vwpllzly5b, $vwplz4izhe, $vwplvtmqd = 0, $vwplddvx5 = false) { global $wpdb; $vwplz4izhe = strtolower(trim($vwplz4izhe) ); if ($vwpllzly5b < 1 || empty($vwplz4izhe) ) { return false; } if ($vwplvtmqd) { update_user_meta($vwpllzly5b, 'infusionsoft_user_id', $vwplvtmqd); }  $vwplx1ap5_ = "SELECT COUNT(`ID`) FROM `{$wpdb->users}` WHERE (`user_login` = %s OR `user_email` = %s) AND `ID` <> %d"; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, sanitize_user($vwplz4izhe, true), $vwplz4izhe, $vwpllzly5b); $vwplt_hk1c = $wpdb->get_var($vwplx1ap5_); if ($vwplt_hk1c) { return false; }  $vwplc0g3p = array('Id', 'Email', 'EmailAddress2', 'EmailAddress3'); $vwpl_w3hc2 = $this->isdk->findByEmail($vwplz4izhe, $vwplc0g3p); if (is_array($vwpl_w3hc2) ) { foreach($vwpl_w3hc2 as $vwply17edn => $vwplrp9u24) { if ($vwplrp9u24['Id'] == $vwplvtmqd) { unset($vwpl_w3hc2[$vwply17edn]); } } } if (! empty($vwpl_w3hc2) && is_array($vwpl_w3hc2) ) { return false; } $vwplgogvie = get_user_by('id', $vwpllzly5b); $vwpltm3g_ = strtolower($vwplgogvie->user_email);  if ($vwplddvx5) { $vwplx1ap5_ = "UPDATE `{$wpdb->users}` SET `user_login` = %s , `user_email` = %s WHERE `ID` = %d "; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, sanitize_user($vwplz4izhe, true), $vwplz4izhe, $vwpllzly5b); } else { $vwplx1ap5_ = "UPDATE `{$wpdb->users}` SET `user_email` = %s WHERE `ID` = %d "; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplz4izhe, $vwpllzly5b); } $vwplyio4f = $wpdb->query($vwplx1ap5_);  unset($vwplt_hk1c, $vwplx1ap5_); if (class_exists('WooCommerce') ) { update_user_meta($vwpllzly5b, 'billing_email', $vwplz4izhe); }  $vwplv09c = array( 'Email' => $vwplz4izhe ); if ($vwplvtmqd > 0) { $vwplyio4f = $this->isdk->updateCon( (int) $vwplvtmqd, $vwplv09c);  } else { $vwplc0g3p = array('Id'); $vwplv80sz = array( 'Email' => $vwpltm3g_, ); $vwpl_w3hc2 = $this->isdk->dsQuery('Contact' ,1000, 0, $vwplv80sz, $vwplc0g3p); if (is_array($vwpl_w3hc2) && ! empty($vwpl_w3hc2) ) { foreach($vwpl_w3hc2 as $vwplrp9u24) { if ($vwplrp9u24['Id']) { $vwplyio4f = $this->isdk->updateCon($vwplrp9u24['Id'], $vwplv09c);  } } } } $this->isdk->optIn($vwplz4izhe, 'Memberium Subscriber Email Change'); $vwplgitq = array( 'contact_id' => $vwplvtmqd, 'cache_ttl' => 0, ); $this->wplf68fx($vwplgitq); do_action('memberium_email_change', $vwplvtmqd, $vwpllzly5b, $vwpltm3g_, $vwplz4izhe); return true; } function wplr2rtyo($vwplsjoas, $vwplvtmqd = false) { if (! $this->license_status) { return false; } if (! $vwplvtmqd) { $vwplvtmqd = (int) $this->wplubo6(); if (! $vwplvtmqd) { return false; } } $vwpllzly5b = wpllbej::wplsgpnk($vwplvtmqd); if (! $vwpllzly5b) { return false; } if (strpos($vwplsjoas, '\\') !== false) { return false; } $vwplsjoas = trim($vwplsjoas); if (empty($vwplsjoas) ) { return false; } $vwplt9si2 = true;  $vwplc_uoh4 = $_SESSION['memb_user']['LoginName']; $vwpl_9dt5u = wp_hash_password($vwplsjoas); $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); if ($_SESSION['memb_user']['source'] != 'infusionsoft') { return false; } if (strlen($vwplsjoas) < $this->options['settings']['min_password_length']) { return false; } global $i2sdk, $wpdb;  if (empty($this->options['settings']['local_auth_only']) ) { $vwplv09c = array( $this->options['settings']['password_field'] => $vwplsjoas ); $this->isdk->updateCon($vwplvtmqd, $vwplv09c);   $vwpla54ov0 = MEMBERIUM_DB_CONTACTS; $vwplup7mi = $this->options['settings']['password_field']; $vwplx1ap5_ = "UPDATE {$vwpla54ov0} SET `value` = '%s' WHERE id = %d AND `appname` = '%s' AND `fieldname` = '%s'; "; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplsjoas, $vwplvtmqd, $vwplw5rgd3, $vwplup7mi); $vwplyio4f = $wpdb->query($vwplx1ap5_); $this->wpln6xe($vwplvtmqd); }  $vwplup7mi = wplz8bid::wplvf1d('settings', 'password_field'); wplsbzgvp::wplx9wl8g($vwplup7mi, $vwplsjoas);   $wpdb->query("UPDATE `" . $wpdb->users . "` SET `user_pass` = '{$vwpl_9dt5u}' WHERE `ID` = '{$vwpllzly5b}';"); wp_cache_delete($vwpllzly5b, 'users'); wp_cache_delete($vwplc_uoh4, 'userlogins'); $vwplgogvie = get_user_by('id', $vwpllzly5b); $this->disable_login_redirect = true; if ($vwplgogvie && $vwpllzly5b == get_current_user_id() ) { wp_set_current_user($vwpllzly5b); wp_set_auth_cookie($vwpllzly5b); $this->wplyte2(); } $this->disable_login_redirect = false; return true; }  function wpleh1zcw($vwpldn570 = false, $vwplizr9qa = false) { $vwpldn570 = wplz8bid::wplvf1d('settings', 'min_password_length', 8); $vwplizr9qa = wplz8bid::wplvf1d('settings', 'password_strength', 0); $vwplup7mi = wplz8bid::wplvf1d('settings', 'password_field', 'Password'); if ($vwpldn570 < 4) { $vwpltzif = 8; } if ($vwplup7mi == 'Password' && $vwpldn570 > 20) { $vwpldn570 = 20; } $vwplu7_l5 = 'aeuy'; $vwplb6e4_j = 'bdghjmnpqrstvz'; $vwplbek4l = ''; $vwplc9bs = ''; if ($vwplizr9qa > 0) { $vwplb6e4_j .= 'BDGHJLMNPQRSTVWXZ'; } if ($vwplizr9qa > 1) { $vwplu7_l5 .= "AEUY"; } if ($vwplizr9qa > 2) {  $vwplc9bs = '23456789'; } if ($vwplizr9qa > 3) {  $vwplbek4l = '@#$%'; } $vwplizr9qa = max($vwplizr9qa, 2); $vwplsjoas = ''; $vwpldw1ez6 = time() % $vwplizr9qa; for ($i = 0; $i < $vwpldn570; $i++) { $vwpldw1ez6 = mt_rand(1, 100) % $vwplizr9qa; if ($vwpldw1ez6 == 0) { $vwplsjoas .= $vwplb6e4_j[(rand() % strlen($vwplb6e4_j) )];  } elseif ($vwpldw1ez6 == 1) { $vwplsjoas .= $vwplu7_l5[(rand() % strlen($vwplu7_l5) )];  } elseif ($vwpldw1ez6 == 2 && $vwplizr9qa > 2) { $vwplsjoas .= $vwplc9bs[(rand() % strlen($vwplc9bs) )];  } elseif ($vwpldw1ez6 == 3 && $vwplizr9qa > 3) { $vwplsjoas .= $vwplbek4l[(rand() % strlen($vwplbek4l) )];  } } return $vwplsjoas; } function wplc4zac($vwplgitq) { $vwplsb_pf = array( 'contact_id' => 0, 'user_id' => 0, 'contact' => array(), 'user' => false, ); $vwplgitq = wp_parse_args ($vwplgitq, $vwplsb_pf); if (! empty($vwplgitq['contact_id' ]) ) { $vwplgitq['contact'] = wpllbej::wplrande($contact); } $vwplgitq['contact'] = array_change_key_case($vwplgitq['contact'], CASE_LOWER); if (! empty ($vwplgitq['user_id']) ) { $vwplgitq['user'] = get_user_by('id', $vwplgitq['user_id']); } if ($vwplgitq['user']) { $vwplg9unv = $vwplgitq['user']->display_name; } else { $vwplg9unv = ''; } $vwplzxhjbg = $this->options['settings']['displayname_format']; if (empty($vwplzxhjbg) ) { $vwplzxhjbg = trim($vwplgitq['contact']['firstname'] . ' ' . $vwplgitq['contact']['lastname']); } if (empty($vwplg9unv) || empty($this->options['settings']['disable_displayname_update']) ) { $vwplg9unv = trim(preg_replace_callback('|({{contact\.(.*)}})|U', function($vwplt_hk1c) use ($vwplgitq) { $vwply17edn = strtolower($vwplt_hk1c[2]); if (isset($vwplgitq['contact'][$vwply17edn]) ) { $vwplyio4f = $vwplgitq['contact'][$vwply17edn]; } else { $vwplyio4f = ''; } return htmlspecialchars($vwplyio4f); }, $vwplzxhjbg) ); } return $vwplg9unv; } function wplqd_lae($vwplvtmqd, $vwplsjoas = '') { global $wpdb;  $vwplrp9u24 = wpllbej::wplrande($vwplvtmqd); $vwpl_2cd9 = wplz8bid::wplvf1d('settings', 'username_field', 'Email'); $vwplup7mi = wplz8bid::wplvf1d('settings', 'password_field', 'Password'); $vwplc_uoh4 = isset($vwplrp9u24[$vwpl_2cd9]) ? $vwplrp9u24[$vwpl_2cd9] : ''; $vwplc_uoh4 = apply_filters('memberium_wordpress_username', $vwplc_uoh4, $vwplrp9u24); $vwplh1d50 = wplz8bid::wplvf1d('settings', 'local_auth_only'); $vwplhwubl = wplz8bid::wplvf1d('settings', 'disable_displayname_update'); $vwplh1d50 = wplz8bid::wplvf1d('settings', 'local_auth_only'); if (empty($vwplc_uoh4) ) { return false; } if (empty($vwplrp9u24['Email'])) { return false; } if (empty($vwplsjoas) ) { $vwplsjoas = isset($vwplrp9u24[$vwplup7mi]) ? $vwplrp9u24[$vwplup7mi] : ''; }  if (empty($vwplh1d50) ) { if (empty($vwplsjoas) ) { return false; } }  $vwplerba = (int) wpllbej::wplsgpnk($vwplvtmqd);  if (! $vwplerba) { $vwplerba = (int) $this->wplzwbhyq($vwplc_uoh4); } $this->doing_user_update = true; if ($vwplerba) { $vwpluum02 = get_user_by('id', $vwplerba); if (is_object($vwpluum02) && strtolower($vwpluum02->user_email) == strtolower($vwplrp9u24['Email']) ) { $vwplrp9u24['Email'] = $vwpluum02->user_email; }  $vwpldj4of = array(); $vwpldj4of['ID'] = $vwplerba;  $vwpldj4of['user_url'] = empty($vwplrp9u24['Website']) ? '' : $vwplrp9u24['Website']; $vwpldj4of['user_email'] = strtolower(trim($vwplrp9u24['Email']) ); $vwpldj4of['first_name'] = isset($vwplrp9u24['FirstName']) ? $vwplrp9u24['FirstName'] : ''; $vwpldj4of['last_name'] = isset($vwplrp9u24['LastName']) ? $vwplrp9u24['LastName'] : '';  if (empty($vwplhwubl ) ) { $vwplgitq = array( 'contact' => $vwplrp9u24, 'user_id' => $vwplerba, ); $vwpldj4of['display_name'] = apply_filters('memberium/wpuser/display_name', $this->wplc4zac($vwplgitq), $vwplrp9u24); $vwpldj4of['nickname'] = apply_filters('memberium/wpuser/nickname', $vwpldj4of['display_name'], $vwplrp9u24); $vwpldj4of['user_nicename'] = apply_filters('memberium/wpuser/nicename', sanitize_title($vwpldj4of['nickname'], $vwpldj4of['display_name']), $vwplrp9u24); }  if (! empty($_POST['pwd']) ) { $vwplsjoas = stripslashes($_POST['pwd']); } else { $vwplsjoas = ''; } if (empty($vwplh1d50) && is_a($vwpluum02, 'WP_User') ) { if (! in_array($vwplsjoas, array('', 'PASSWORD_PLACEHOLDER') ) ) { if ( (! @wp_check_password($_POST['pwd'], $vwpluum02->data->user_pass, $vwplgogvie->ID) ) ) { $vwpldj4of['user_pass'] = $vwplrp9u24[$this->options['settings']['password_field']]; } } } add_filter('send_password_change_email', array($this, 'wplj4_rn8'), PHP_INT_MAX, 3); wp_update_user($vwpldj4of); remove_filter('send_password_change_email', array($this, 'wplj4_rn8'), PHP_INT_MAX); } else {  $vwpldj4of = array(); $vwpldj4of['user_pass'] = $vwplsjoas; $vwpldj4of['user_login'] = $vwplc_uoh4; $vwpldj4of['user_email'] = strtolower($vwplrp9u24['Email']); $vwpldj4of['first_name'] = isset($vwplrp9u24['FirstName']) ? $vwplrp9u24['FirstName'] : ''; $vwpldj4of['last_name'] = isset($vwplrp9u24['LastName']) ? $vwplrp9u24['LastName'] : ''; $vwpldj4of['user_url'] = isset($vwplrp9u24['Website']) ? $vwplrp9u24['Website'] : ''; $vwplgitq = array( 'contact' => $vwplrp9u24, ); $vwpldj4of['display_name'] = apply_filters('memberium/wpuser/display_name', $this->wplc4zac($vwplgitq), $vwplrp9u24); $vwpldj4of['nickname'] = apply_filters('memberium/wpuser/nickname', $vwpldj4of['display_name'], $vwplrp9u24); $vwpldj4of['user_nicename'] = apply_filters('memberium/wpuser/nicename', sanitize_title($vwpldj4of['nickname'], $vwpldj4of['display_name']), $vwplrp9u24); $vwplerba = wp_insert_user($vwpldj4of);  do_action('user_register', $vwplerba); if (function_exists('WPCW_actions_users_newUserCreated') ) { WPCW_actions_users_newUserCreated($local_user_id); } } $this->wplaig81($vwplvtmqd, $vwplerba); $this->doing_user_update = false; return $vwplerba; }  function wpllq6u($vwplc_uoh4, $vwplhzv1 = false) { global $wpdb; $vwplc_uoh4 = stripslashes($vwplc_uoh4); if (empty($vwplc_uoh4) ) { return; } if ($this->contact_cache_refreshed == 1) { return; } $vwplgogvie = get_user_by('login', $vwplc_uoh4); if (! $vwplgogvie && ! strpos($vwplc_uoh4, '@') && in_array($this->options['settings']['username_field'], array('Email', 'EmailAddress2', 'EmailAddress3') ) ) { if (is_a($vwplgogvie, 'WP_User') ) { $vwplc_uoh4 = $vwplgogvie->data->user_email; } } if (empty($vwplc_uoh4) ) { return; } if (! $vwplhzv1) { $vwplhzv1 = (int) wplz8bid::wplvf1d('settings', 'max_contact_age'); } $vwplde7m = time() - $vwplhzv1; $vwplsfk1bd = MEMBERIUM_DB_CONTACTS; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplor9h = 0; $vwplc_uoh4 = $this->wplpfyw($vwplc_uoh4); if ($vwplhzv1) { $vwplx1ap5_ = "
			SELECT
			COUNT(`{$vwplsfk1bd}`.`id`)
			FROM
			`{$vwplsfk1bd}`,
			`{$vwplsfk1bd}` as `{$vwplsfk1bd}_1`
			WHERE	`{$vwplsfk1bd}`.`appname`     = %s
			AND 	`{$vwplsfk1bd}`.`fieldname`   = %s
			AND		`{$vwplsfk1bd}`.`value`       = %s
			AND		`{$vwplsfk1bd}_1`.`id`        = `{$vwplsfk1bd}`.`id`
			AND		`{$vwplsfk1bd}_1`.`fieldname` = '!LastUpdated'
			AND		`{$vwplsfk1bd}_1`.`value`     > %d"; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplw5rgd3, $this->options['settings']['username_field'], $vwplc_uoh4, $vwplde7m); $vwplor9h = (int) $wpdb->get_var($vwplx1ap5_); } if ($vwplor9h == 0) { $vwplc0g3p = wpllbej::wplntnyv('Contact', true); $vwplv80sz = array( ( ($this->options['settings']['username_field']) ? $this->options['settings']['username_field'] : 'Email') => $vwplc_uoh4, );  if (is_object($vwplgogvie) && $vwplgogvie->ID > 0) {  } $vwpl_w3hc2 = $this->isdk->dsQueryOrderBy('Contact', 1000, 0, $vwplv80sz, $vwplc0g3p, 'Id', true ); if (is_array($vwpl_w3hc2) && ! empty($vwpl_w3hc2) ) { $vwplj9dl = array(); foreach($vwpl_w3hc2 as $vwplrp9u24) { if (isset($vwplrp9u24['Id']) ) { $vwplj9dl[] = $vwplrp9u24['Id']; } } $vwplj9dl = implode(',', $vwplj9dl); $vwplx1ap5_ = "SELECT `id`
				FROM`{$vwplsfk1bd}`
				WHERE `{$vwplsfk1bd}`.`appname` = %s
				AND   `{$vwplsfk1bd}`.`fieldname` = %s
				AND   `{$vwplsfk1bd}`.`value` = %s
				AND   `{$vwplsfk1bd}`.`id` NOT IN ({$vwplj9dl}) "; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplw5rgd3, $this->options['settings']['username_field'], $vwplc_uoh4); $vwplenvy1x = $wpdb->get_col($vwplx1ap5_); if (is_array($vwplenvy1x) && ! empty($vwplenvy1x) ) { $vwplx1ap5_ = "DELETE FROM `{$vwplsfk1bd}`
					WHERE `{$vwplsfk1bd}`.`appname` = %s
					AND `{$vwplsfk1bd}`.`id` IN (" . implode(',', $vwplenvy1x) . "); "; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplw5rgd3, $this->options['settings']['username_field']); $vwplyio4f = $wpdb->query($vwplx1ap5_); } foreach ($vwpl_w3hc2 as $vwplrp9u24) { $this->wplto2h4($vwplrp9u24); } unset($vwplx1ap5_, $vwplenvy1x, $vwplj9dl); if (count($vwpl_w3hc2) > 0) { $this->contact_cache_refreshed = 1; } } } else {  } }  function wplckwp7($vwplc_uoh4) { $vwplc_uoh4 = strtolower(trim(stripslashes($vwplc_uoh4) ) ); if (empty($vwplc_uoh4) ) { return 0; }  $vwplvtmqd = wplsbzgvp::wplfhxj9(); if ($vwplvtmqd > 0) { if (isset($_SESSION['memb_user']['LoginName']) && $vwplc_uoh4 == $_SESSION['memb_user']['LoginName'] ) { return $vwplvtmqd; } } global $wpdb; $vwpldv1yjr = $this->isdk; $vwplnmgpy1 = $this->options; $vwplsfk1bd = MEMBERIUM_DB_CONTACTS; $vwplde7m = intval(time() - $this->options['settings']['max_contact_age']) - 10; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwpl_2cd9 = $vwplnmgpy1['settings']['username_field']; $vwplup7mi = $vwplnmgpy1['settings']['password_field']; $vwplpqst = get_user_by('email', $vwplc_uoh4); if (! $vwplpqst) { $vwplpqst = get_user_by('login', $vwplc_uoh4); } if (is_object($vwplpqst) && user_can($vwplpqst, 'manage_options') ) { return 0; } $vwplerba = $vwplpqst->ID; $vwplfm0a = wpllbej::wplbmo_1($vwplerba); if ($vwplfm0a) { return $vwplfm0a; }   $vwplc0g3p = array( 'Id', $vwpl_2cd9, $vwplup7mi, );  $vwplv80sz = array( $vwpl_2cd9 => $vwplc_uoh4,  ); $vwpl_w3hc2 = $this->isdk->dsQueryOrderBy('Contact', 1, 0, $vwplv80sz, $vwplc0g3p, 'Id', true ); $vwplz3ld = 0;  if (! is_array($vwpl_w3hc2) ) { return 0; }  if (! empty($this->options['settings']['local_auth_only']) ) { return (int) $vwpl_w3hc2[0]['Id']; }   foreach($vwpl_w3hc2 as $vwplvtmqd => $vwplrp9u24) { if (! empty($vwplrp9u24[$vwplup7mi]) ) { $vwplz3ld = (int) $vwplrp9u24['Id']; break; } } return $vwplz3ld; } function wplpfyw($vwplc_uoh4) {  if (! in_array($this->options['settings']['username_field'], array('Email', 'EmailAddress2', 'EmailAddress3') ) ) { return $vwplc_uoh4; } $vwplgogvie = get_user_by('login', $vwplc_uoh4); if (is_a($vwplgogvie, 'WP_User') ) { $vwplc_uoh4 = $vwplgogvie->data->user_email; } else { $vwplgogvie = get_user_by('email', $vwplc_uoh4); if (is_a($vwplgogvie, 'WP_User') ) { $vwplc_uoh4 = $vwplgogvie->data->user_email; } } return $vwplc_uoh4; } function wplzwbhyq($vwplc_uoh4) { $vwplc_uoh4 = strtolower(trim($vwplc_uoh4)); $vwplyio4f = false; $vwplgogvie = get_user_by('login', $vwplc_uoh4); if (is_a($vwplgogvie, 'WP_User') && $vwplgogvie->ID > 0 ) { $vwplyio4f = $vwplgogvie->ID; } else { $vwplgogvie = get_user_by('email', $vwplc_uoh4); if ( is_a($vwplgogvie, 'WP_User') && $vwplgogvie->ID > 0 ) { $vwplyio4f = $vwplgogvie->ID; } } return $vwplyio4f; } function wpli8mk07($vwplvtmqd) { global $wpdb; $vwplx1ap5_ = "SELECT `user_id` FROM `{$wpdb->usermeta}`, `{$wpdb->users}` WHERE `{$wpdb->usermeta}`.`meta_value` = %s AND `{$wpdb->usermeta}`.`meta_key` = 'infusionsoft_user_id' AND `{$wpdb->users}`.`ID` = `{$wpdb->usermeta}`.`user_id` LIMIT 1;";  $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplvtmqd); $vwpllzly5b = (int) $wpdb->get_var($vwplx1ap5_); if ($vwpllzly5b > 0) { $vwplgogvie = get_user_by('id', $vwpllzly5b); return $vwplgogvie; } else { return false; } } function wplmgxs3($vwplc_uoh4, $vwplsjoas = '', $vwplzwrq = false) {  static $vwplt_hk1c = array(); $vwplc_uoh4 = stripslashes($vwplc_uoh4); $vwplsjoas = stripslashes($vwplsjoas); if (isset($vwplt_hk1c[$vwplc_uoh4]) ) { return $vwplt_hk1c[$vwplc_uoh4]; } global $wpdb; if ($vwplc_uoh4 == '') { return false; } $vwplc_uoh4 = $this->wplpfyw($vwplc_uoh4); $vwpllzly5b = $this->wplzwbhyq($vwplc_uoh4); if ($this->wplubo6() > 0 && $vwpllzly5b == get_current_user_id() ) { return $this->wplubo6(); } if (! $vwpllzly5b && $this->options['settings']['local_auth_only'] == 1) { return false; } else { $vwplggia = wpllbej::wplbmo_1($vwpllzly5b); } $vwpldv1yjr = $this->isdk; $vwplnmgpy1 = $this->options; $vwplvtmqd = 0; $vwplgogvie = get_user_by('id', $vwpllzly5b);  $contacts_table = MEMBERIUM_DB_CONTACTS; $vwplde7m = intval(time() - $this->options['settings']['max_contact_age']); $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); if (! empty($this->options['settings']['local_auth_only']) ) { $vwplx1ap5_ = "
			SELECT
			`c1`.`id`,
			'' as `password`,
			0 as `score`
			FROM
			`{$contacts_table}` as `c1`
			WHERE	`c1`.`appname` = '{$vwplw5rgd3}'
			AND 	`c1`.`fieldname` = '{$this->options['settings']['username_field']}'
			AND		`c1`.`value` = %s
			ORDER BY
			`c1`.`id` ASC"; } else { $vwplx1ap5_ = "
			SELECT
			`c1`.`id`,
			`c2`.`value` as `password`,
			0 as `score`
			FROM
			`{$contacts_table}` as `c1`,
			`{$contacts_table}` as `c2`
			WHERE	`c1`.`appname` = '{$vwplw5rgd3}'
			AND 	`c1`.`fieldname` = '{$this->options['settings']['username_field']}'
			AND		`c1`.`value` = %s
			AND 	`c2`.`id` = `c1`.`id`
			AND 	`c2`.`appname` = '{$vwplw5rgd3}'
			AND 	`c2`.`fieldname` = '{$this->options['settings']['password_field']}'
			ORDER BY
			`c1`.`id` ASC"; } $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, stripslashes($vwplc_uoh4) ); $vwpl_w3hc2 = $wpdb->get_results($vwplx1ap5_, ARRAY_A); if (! empty($this->options['settings']['local_auth_only']) ) {  $vwplvtmqd = isset($vwpl_w3hc2[0]['id']) ? $vwpl_w3hc2[0]['id'] : 0; } else {  if (is_array($vwpl_w3hc2) && ! empty($vwpl_w3hc2) ) { foreach ($vwpl_w3hc2 as $vwply17edn=>$vwplrp9u24) { $vwpl_w3hc2[$vwply17edn]['password'] = stripslashes(html_entity_decode(trim($vwplrp9u24['password']) ) ); } $vwpls1eq = false;  if (false && count($vwpl_w3hc2) == 1) { $vwplvtmqd = (int) $vwpl_w3hc2[0]['id']; $vwpls1eq = 0; $vwplrp9u24[0]['score'] = $vwpl_w3hc2[0]['score'] + 25; } else { $vwpl_w3hc2[0]['score'] = $vwpl_w3hc2[0]['score'] + 2; foreach ($vwpl_w3hc2 as $vwply17edn=>$vwplrp9u24) { if ($vwplsjoas > '' && $vwplrp9u24['password'] == stripslashes(trim($vwplsjoas) ) ) {  $vwpl_w3hc2[$vwply17edn]['score'] = $vwpl_w3hc2[$vwply17edn]['score'] + 10; } elseif ($vwplsjoas > '' && $vwplrp9u24['password'] > '' && $vwplrp9u24['password'] != 'PASSWORD_PLACEHOLDER') { $vwplrp9u24['score'] = $vwplrp9u24['score'] + 5; } elseif ($vwplsjoas > '' && $vwplsjoas != $vwplrp9u24['password'] && $vwplrp9u24['password'] == 'PASSWORD_PLACEHOLDER') { $vwpl_w3hc2[$vwply17edn]['score'] = $vwpl_w3hc2[$vwply17edn]['score'] + 3; } elseif ($vwplsjoas == '' && $vwplrp9u24['password'] == '') { $vwpl_w3hc2[$vwply17edn]['score'] = $vwpl_w3hc2[$vwply17edn]['score'] + 1; } elseif ($vwplrp9u24['id'] == $vwplggia) { $vwpl_w3hc2[$vwply17edn]['score'] + 10; } }  $vwplrcybf5 = 0; foreach ($vwpl_w3hc2 as $vwply17edn=>$vwplrp9u24) { if ($vwplrp9u24['score'] > $vwplrcybf5) { $vwpls1eq = $vwply17edn; } } unset($vwplrcybf5); } if ($vwpls1eq !== FALSE) { if ($vwplsjoas == '' || ($vwplsjoas > '' && $vwpl_w3hc2[$vwpls1eq]['password'] == $vwplsjoas) ) {  $vwplvtmqd = (int) $vwpl_w3hc2[$vwpls1eq]['id']; } elseif ($vwplsjoas > '' && $vwplsjoas <> 'PASSWORD_PLACEHOLDER' && $vwpl_w3hc2[$vwpls1eq]['password'] == 'PASSWORD_PLACEHOLDER') {  if (is_a($vwplgogvie, 'WP_User')) { if ( ($vwplgogvie->ID > 0) && wp_check_password($vwplsjoas, $vwplgogvie->data->user_pass, $vwplgogvie->ID) ) { $vwplvtmqd = (int) $vwpl_w3hc2[$vwpls1eq]['id']; $vwplgvh0x = array( $this->options['settings']['password_field'] => $vwplsjoas ); $this->isdk->updateCon($vwplvtmqd, $vwplgvh0x);  $this->wplj9ye($vwplvtmqd); } } } else { } } if ($vwplvtmqd > 0) { $vwplrp9u24 = $vwpl_w3hc2[$vwpls1eq];  } } } if (! $vwplgogvie) { $vwplgogvie = get_user_by('email', $vwplc_uoh4); } if (is_a($vwplgogvie, 'WP_User') && $vwplvtmqd > 0) { $this->wplaig81($vwplvtmqd, $vwplgogvie->ID); }  if ($vwplc_uoh4 > '' && $vwplsjoas > '' && $vwplvtmqd > 0) { $vwplt_hk1c[$vwplc_uoh4] = $vwplvtmqd; } return $vwplvtmqd; } function wplto2h4($vwplfu1sbe, $vwplgm2dr = false) { global $i2sdk, $wpdb; $vwpldv1yjr = $i2sdk->isdk; $this->doing_user_update = true; $vwplopnf = isset($vwplfu1sbe['Id']) ? (int) $vwplfu1sbe['Id'] : 0; if (! $vwplopnf) { return false; } if (isset($vwplfu1sbe['CompanyID']) && $vwplfu1sbe['CompanyID'] == $vwplopnf) { return false; } $vwplup7mi = wplz8bid::wplvf1d('settings', 'password_field'); $vwplfvwe = wplz8bid::wplvf1d('settings', 'plaintext_db'); $vwplov_i = wplz8bid::wplvf1d('settings', 'ignore_contact_fields'); $vwplnn16 = wplz8bid::wplvf1d('settings', 'sync_tag_details'); $vwplhwubl = wplz8bid::wplvf1d('settings', 'disable_displayname_update');  if (! isset($vwplfu1sbe[$vwplup7mi]) ) { $vwplfu1sbe[$vwplup7mi] = ''; }  foreach($vwplfu1sbe as $vwply17edn => $vwplph268z) { $vwplfu1sbe[$vwply17edn] = ($vwplph268z == 'null') ? '' : $vwplph268z; }  if ($vwplgm2dr) { $vwpldv1yjr->updatecon($vwplopnf, $vwplfu1sbe);  } $vwpla54ov0 = MEMBERIUM_DB_CONTACTS; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplfu1sbe['!LastUpdated'] = time(); $vwplf7eoq = wpllbej::wplrande($vwplopnf); foreach($vwplf7eoq as $vwply17edn => $vwplph268z) { $vwplf7eoq[$vwply17edn] = ($vwplph268z == 'null') ? '' : $vwplph268z; } unset($vwplf7eoq['!LastUpdated']); $vwplw_pth = isset($vwplfu1sbe['Website']); $vwpldyt4 = isset($vwplfu1sbe['FirstName']); $vwplargz3 = isset($vwplfu1sbe['LastName']); $vwplkm5c = wpllbej::wplntnyv('Contact', true); foreach($vwplkm5c as $vwple2yn) { if (! isset($vwplfu1sbe[$vwple2yn]) ) { $vwplfu1sbe[$vwple2yn] = ''; } else { if ($vwplfvwe) { $vwplfu1sbe[$vwple2yn] = iconv('UTF-8', 'ISO-8859-1//IGNORE', remove_accents($vwplfu1sbe[$vwple2yn]) ); $vwplfu1sbe[$vwple2yn] = filter_var($vwplfu1sbe[$vwple2yn], FILTER_SANITIZE_STRING, FILTER_FLAG_STRIP_HIGH); } } if ($vwple2yn == 'Groups') { $vwplfu1sbe[$vwple2yn] = implode(',', array_filter(array_unique(explode(',', $vwplfu1sbe[$vwple2yn]) ) ) ); } if ($vwple2yn != $vwplup7mi) { $vwplfu1sbe[$vwple2yn] = wp_strip_all_tags($vwplfu1sbe[$vwple2yn]); } $vwplfu1sbe[$vwple2yn] = html_entity_decode($vwplfu1sbe[$vwple2yn]); }  $vwplqzdlu3 = array_filter(explode(',', $vwplov_i) ); $vwplvrfw = $vwplqzdlu3; foreach($vwplf7eoq as $vwplyq9i7o => $vwplcjpa) { if ( (! isset($vwplfu1sbe[$vwplyq9i7o]) ) && (! in_array($vwplyq9i7o, $vwplkm5c) ) ) { $vwplqzdlu3[] = $vwplyq9i7o; } } if (! empty($vwplqzdlu3) ) { $vwplx1ap5_ = "DELETE FROM {$vwpla54ov0} WHERE `appname` = %s AND `id` = %d AND `fieldname` IN ('" . implode("','", $vwplqzdlu3) . "');"; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplw5rgd3, $vwplopnf); $vwplyio4f = $wpdb->query($vwplx1ap5_); }  $vwpljz9txv = array(); $vwplqzdlu3 = array(); foreach($vwplfu1sbe as $vwplyq9i7o => $vwplcjpa) { if (! in_array($vwplyq9i7o, $vwplvrfw) ) { if ( (! isset($vwplf7eoq[$vwplyq9i7o]) || ($vwplf7eoq[$vwplyq9i7o] <> $vwplcjpa) ) ) { $vwpljz9txv[] = $wpdb->prepare('(%d, %s, %s, %s)', $vwplopnf, $vwplw5rgd3, $vwplyq9i7o, $vwplcjpa); $vwplqzdlu3[] .= $wpdb->prepare("%s", $vwply17edn); } } } if (! empty($vwpljz9txv) ) { $vwplx1ap5_ = "INSERT INTO {$vwpla54ov0} (id, appname, fieldname, value) VALUES " . implode(',', $vwpljz9txv) . " ON DUPLICATE KEY UPDATE id=VALUES(id), appname=VALUES(appname), fieldname=VALUES(fieldname), value=VALUES(value);"; $vwplyio4f = $wpdb->query($vwplx1ap5_); } unset($vwpljz9txv, $vwplph268z, $vwplqzdlu3, $vwplyq9i7o, $vwplcjpa); if (! empty($vwplnn16) ) { $this->wplt52wpo( (int) $vwplfu1sbe['Id']); } $vwpllzly5b = wpllbej::wplsgpnk($vwplopnf); if ($vwpllzly5b) { $vwplbje3ox = user_can($vwpllzly5b, 'manage_options'); if (! $vwplbje3ox) { $vwplqyb_0t = get_user_by('ID', $vwpllzly5b); $vwplmu62n = array(); $vwplgogvie = get_user_by('id', $vwpllzly5b); $vwplmu62n['ID'] = $vwpllzly5b; $vwplmu62n['user_login'] = $vwplgogvie->user_login; $vwplmu62n['user_email'] = $vwplgogvie->user_email; if ($vwplmu62n['user_login'] == $vwplmu62n['user_email']) { $vwplmu62n['user_login'] = $vwplmu62n['user_email']; } if ($vwpldyt4) { $vwplmu62n['first_name'] = $vwplfu1sbe['FirstName']; } if ($vwplargz3) { $vwplmu62n['last_name'] = $vwplfu1sbe['LastName']; } if ($vwplw_pth) { $vwplmu62n['user_url'] = $vwplfu1sbe['Website']; } if (! empty($vwplmu62n) ) { $vwplmu62n['ID'] = $vwpllzly5b; } if (empty($vwplhwubl) ) { $vwplgitq = array('contact' => $vwplfu1sbe); $vwplmu62n['display_name'] = apply_filters('memberium/wpuser/display_name', $this->wplc4zac($vwplgitq), $vwplfu1sbe); $vwplmu62n['nickname'] = apply_filters('memberium/wpuser/nickname', $vwplmu62n['display_name'], $vwplfu1sbe); $vwplmu62n['user_nicename'] = apply_filters('memberium/wpuser/nicename', sanitize_title($vwplmu62n['nickname'], $vwplmu62n['display_name']), $vwplfu1sbe); }  $vwplh1d50 = wplz8bid::wplvf1d('settings', 'local_auth_only'); if ( ! $vwplh1d50 && $vwplfu1sbe[$vwplup7mi] !== 'PASSWORD_PLACEHOLDER') { if (! wp_check_password($vwplfu1sbe[$vwplup7mi], $vwplgogvie->data->user_pass, $vwpllzly5b ) ) { $this->wplr2rtyo($vwplfu1sbe[$vwplup7mi]); } } $this->wplqd_lae($vwplopnf); if (is_multisite() && ! is_user_member_of_blog($vwpllzly5b) ) { $vwpltycqk9 = get_current_blog_id(); $vwplwpqkj8 = get_blog_option($vwpltycqk9, 'default_role', 'subscriber'); add_user_to_blog($vwpltycqk9, $vwpllzly5b, $vwplwpqkj8); } } } $this->wpln6xe($vwplopnf);  do_action('memberium_save_contact', $vwplfu1sbe['Id'], $vwpllzly5b, $vwplfu1sbe); $this->doing_user_update = false; } function wplj9ye($vwplvtmqd = 0, $vwplfjkyr = false) { $vwple7lbh = 0; if ($vwplvtmqd) { global $wpdb; $vwplnmgpy1 = wplz8bid::wplvf1d(); $vwplfqgl3j = get_option('i2sdk'); $vwpldv1yjr = $this->isdk; $vwplvtmqd = (int) $vwplvtmqd; $vwplc0g3p = wpllbej::wplntnyv('Contact', true); $vwply4j8x = array(); $vwple7lbh = 0; $vwplx1ap5_ = 'SELECT `value` FROM `' . MEMBERIUM_DB_CONTACTS . '` WHERE `id` = %d AND `fieldname` = "!LastUpdated";'; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplvtmqd); $vwplomw_9 = $wpdb->get_var($vwplx1ap5_); $vwplpg5x = time(); if ($vwplomw_9 <= $vwplpg5x) { $vwply4j8x = $this->isdk->loadCon($vwplvtmqd, $vwplc0g3p); } if (is_string($vwply4j8x) && stripos($vwply4j8x, 'RecordNotFound') !== false) { $this->wpld5vqwz($vwplvtmqd); } if (is_array($vwply4j8x) && count($vwply4j8x) > 0) { $this->wplto2h4($vwply4j8x); $vwple7lbh = count($vwply4j8x); if (! empty($this->options['settings']['sync_tag_details']) ) { $this->wplt52wpo( (int) $vwply4j8x['Id']); } $this->wpln6xe($vwplvtmqd); } } return $vwple7lbh; } function wplf68fx($vwplgitq = array() ) { $vwplsb_pf = array( 'contact_id' => 0, 'cascade' => false, 'cache_ttl' => 0, ); $vwplgitq = wp_parse_args($vwplgitq, $vwplsb_pf); $vwplvtmqd = $vwplgitq['contact_id']; $vwplfjkyr = $vwplgitq['cascade']; $vwplm6yt = $vwplgitq['cache_ttl']; $vwple7lbh = 0; if ($vwplvtmqd > 0) { global $wpdb; $vwplnmgpy1 = wplz8bid::wplvf1d(); $vwplfqgl3j = get_option('i2sdk'); $vwpldv1yjr = $this->isdk; $vwplvtmqd = (int) $vwplvtmqd; $vwplc0g3p = wpllbej::wplntnyv('Contact', true); $vwply4j8x = array(); $vwple7lbh = 0; $vwplx1ap5_ = 'SELECT `value` FROM `' . MEMBERIUM_DB_CONTACTS . '` WHERE `id` = %d AND `fieldname` = "!LastUpdated";'; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplvtmqd); $vwplomw_9 = $wpdb->get_var($vwplx1ap5_); $vwplpg5x = time(); if ($vwplomw_9 < ($vwplpg5x - $vwplm6yt) ) { $vwply4j8x = $this->isdk->loadCon($vwplvtmqd, $vwplc0g3p); if (is_string($vwply4j8x) && stripos($vwply4j8x, 'RecordNotFound') !== false) { $this->wpld5vqwz($vwplvtmqd); } if (is_array($vwply4j8x) && count($vwply4j8x) > 0) { $this->wplto2h4($vwply4j8x); $vwple7lbh = count($vwply4j8x); if (! empty($this->options['settings']['sync_tag_details']) ) { $this->wplt52wpo( (int) $vwplheakg['Id']); } $this->wpln6xe($vwplvtmqd); } } } return $vwple7lbh; } function wpld5vqwz($vwplvtmqd, $vwplfjkyr = FALSE) { global $wpdb; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); if (! is_array($vwplvtmqd) ) { $vwplj9dl = array($vwplvtmqd); } foreach ($vwplj9dl as $vwplvtmqd) { $vwplvtmqd = (int) $vwplvtmqd; if ($vwplvtmqd > 0) { $vwplx1ap5_ = 'DELETE FROM `' . MEMBERIUM_DB_CONTACTS . '` WHERE `id` = %d AND `appname` = %s ;'; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, array($vwplvtmqd, $vwplw5rgd3) ); $wpdb->query($vwplx1ap5_); if ($vwplfjkyr) {  $vwplx1ap5_ = 'DELETE FROM `' . MEMBERIUM_DB_CONTACTTAGS . '` WHERE `contactid` = %d AND `appname` = %s ;'; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, array($vwplvtmqd, $vwplw5rgd3) ); $wpdb->query($vwplx1ap5_);  $vwplx1ap5_ = 'DELETE FROM `' . MEMBERIUM_DB_AFFILIATES . '` WHERE `contactid` = %d AND `appname` = %s ;'; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, array($vwplvtmqd, $vwplw5rgd3) ); $wpdb->query($vwplx1ap5_);  } } } }  function wplqvqrie($vwplgitq) { global $wpdb; if (empty($vwplgitq) ) { return false; } $vwplsb_pf = array( 'email' => '', 'return' => 'row_count',  ); if (is_string($vwplgitq) ) { $vwplsb_pf['email'] = strtolower(trim($vwplgitq) ); $vwplgitq = array(); } $vwplgitq = wp_parse_args($vwplgitq, $vwplsb_pf); $vwplz4izhe = $vwplgitq['email']; if (empty($vwplz4izhe) ) { return; } $vwplnmgpy1 = wplz8bid::wplvf1d(); $vwplfqgl3j = get_option('i2sdk'); $vwpldv1yjr = $this->isdk;  $vwplanieul = 1000; $vwplnzlj0t = 'Contact'; $vwplho_n = 0; $vwplnzrsa = 'Email'; $vwpltsj75x = $vwplz4izhe; $vwplc0g3p = wpllbej::wplntnyv('Contact', true); $vwpla54ov0 = MEMBERIUM_DB_CONTACTS; $vwple7lbh = 0; $contact_count = 0; $contact_ids = array(); $contacts = array(); $vwplv80sz = array( $vwplnzrsa => $vwpltsj75x ); do { $vwply4j8x = $vwpldv1yjr->dsQuery($vwplnzlj0t, $vwplanieul, $vwplho_n, $vwplv80sz, $vwplc0g3p); if (is_array($vwply4j8x) && ! empty($vwply4j8x) ) { foreach ($vwply4j8x as $vwplheakg) { if ($vwplgitq['return'] == 'contacts') { $contacts[$vwplheakg['Id']] = $vwplheakg; } $contact_count++; $contact_ids[] = $vwplheakg['Id']; $this->wplto2h4($vwplheakg); if (! empty($this->options['settings']['sync_tag_details']) ) { $this->wplt52wpo( (int) $vwplheakg['Id']); } $this->wpln6xe($vwplheakg['Id']); } } $vwplho_n++; $vwple7lbh = $vwple7lbh + count($vwply4j8x); } while (count($vwply4j8x) == $vwplanieul);  if ($vwplgitq['return'] == 'contact_count') { return $contact_count; } elseif ($vwplgitq['return'] == 'contact_ids') { return $contact_ids; } elseif ($vwplgitq['return'] == 'contacts') { return $contacts; } return $vwple7lbh; } function wplt52wpo($vwplvtmqd) { if ($vwplvtmqd < 1 || (int) $vwplvtmqd !== $vwplvtmqd) { return; } global $wpdb; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplvtmqd = (int) $vwplvtmqd; $vwplanieul = 1000; $vwplnzlj0t = 'ContactGroupAssign'; $vwplho_n = 0; $vwplnzrsa = 'ContactId'; $vwpltsj75x = $vwplvtmqd; $vwplc0g3p = array('GroupId', 'DateCreated'); $vwpla54ov0 = MEMBERIUM_DB_CONTACTTAGS; $vwple7lbh = 0; $wpdb->delete($vwpla54ov0, array('contactid' => $vwplvtmqd, 'appname' => $vwplw5rgd3) ); do { $vwply4j8x = $this->isdk->dsfind($vwplnzlj0t, (int) $vwplanieul, (int) $vwplho_n, $vwplnzrsa, (string) $vwpltsj75x, $vwplc0g3p); if (is_array($vwply4j8x) ) { foreach ($vwply4j8x as $vwplheakg) { $wpdb->insert( MEMBERIUM_DB_CONTACTTAGS, array( 'appname' => $vwplw5rgd3, 'contactid' => $vwplvtmqd, 'tagid' => (int) $vwplheakg['GroupId'], 'created' => date('Y-m-d H:i:s', strtotime($vwplheakg['DateCreated']) ), ), array('%s', '%d', '%d', '%s') ); } } $vwplho_n++; $vwple7lbh = $vwple7lbh + count($vwply4j8x); } while (count($vwply4j8x) == $vwplanieul); $current_contact_id = wplsbzgvp::wplfhxj9(); if ($current_contact_id == $vwplvtmqd) { $_SESSION['memb_user']['tags_synced'] = 1; } } function wplegql($vwplvtmqd, $vwplz4izhe) { global $wpdb; if (empty($vwplz4izhe) ) { return false; } if (empty($vwplvtmqd) ) { return false; } $vwple2yn = $this->options['settings']['username_field']; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplx1ap5_ = "SELECT count(`id`) FROM `" . MEMBERIUM_DB_CONTACTS . "` WHERE `id` = %d AND `fieldname` = %s AND appname = %s AND VALUE = %s ;"; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplvtmqd, $vwple2yn, $vwplw5rgd3, $vwplz4izhe); $vwplcjywg = $wpdb->get_var($vwplx1ap5_); if (! $vwplcjywg) { } else { } return $vwplcjywg; } function wplaig81($vwplvtmqd = 0, $vwpllzly5b = 0) { if (empty($vwplvtmqd) ) { return false; } if (empty($vwpllzly5b) ) { return false; } $vwplgogvie = get_userdata($vwpllzly5b); $vwplz4izhe = $vwplgogvie->user_email; $vwplwatu = $this->wplegql($vwplvtmqd, $vwplz4izhe); if (! $vwplwatu) { return false; } update_user_meta($vwpllzly5b, 'infusionsoft_user_id', $vwplvtmqd);  return true; } function wplhg0eyq($vwplk_sn, $vwplc0nobe = false) { global $wpdb; if (! $vwplc0nobe) {  if (current_user_can('manage_options') ) { return true; } }  if (! wpln9_s::wplq6kurm() ) { return false; } if ($vwplc0nobe === false) { if (wplsbzgvp::wplc4na('groups') == '') { $vwplc0nobe['memb_db_fields']['groups'] = ''; $vwplc0nobe['memb_user']['GroupNames'] = ''; } else { $vwple5y1zo = wplsbzgvp::wplc4na('groups'); $vwplqa3p = $_SESSION['memb_user']['GroupNames']; } } else { $vwple5y1zo = isset($vwplc0nobe['memb_db_fields']['groups']) ? $vwplc0nobe['memb_db_fields']['groups'] : ''; $vwplqa3p = isset($vwplc0nobe['memb_user']['GroupNames']) ? $vwplc0nobe['memb_user']['GroupNames'] : ''; } $vwplnzlj0t = MEMBERIUM_DB_TAGS; $vwplk_sn = (int) $vwplk_sn; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplx1ap5_ = "SELECT count(*) FROM `{$vwplnzlj0t}` WHERE `id` IN (" . $vwple5y1zo . ") AND `appname` = %s AND `category` = %d"; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplw5rgd3, $vwplk_sn); $vwplyio4f = $wpdb->get_var($vwplx1ap5_); return (bool) $vwplyio4f; } static function wpl_z7ir($vwplgtsez7, $vwpleatj) { if (empty($vwplgtsez7) || empty($vwpleatj)) { return false; } $vwplgtsez7 = is_array($vwplgtsez7) ? $vwplgtsez7 : explode(',', $vwplgtsez7); $vwplgtsez7 = array_map('trim', $vwplgtsez7); $vwplu14yc9 = array_filter($vwplgtsez7, function($vwplph268z) { if ($vwplph268z < 0) { return true; } }); $vwplgtsez7 = array_filter($vwplgtsez7, function($vwplph268z) { if ($vwplph268z > 0) { return true; } }); $vwplu14yc9 = array_map('abs', $vwplu14yc9); $vwpleatj = is_array($vwpleatj) ? $vwpleatj : explode(',', $vwpleatj); $vwpleatj = array_map('trim', $vwpleatj); if (! array_intersect($vwpleatj, $vwplu14yc9) ) { if (array_intersect($vwpleatj, $vwplgtsez7) ) { return true; } } return false;  }  static function wpl_n2s9($vwpls0hwb5, $vwplc0nobe = false) {  if (! wpln9_s::wplq6kurm() ) { return false; } $vwpllzly5b = isset($vwplc0nobe['memb_user']['Id']) ? $vwplc0nobe['memb_user']['Id'] : get_current_user_id(); if (user_can($vwpllzly5b, 'manage_options')) { return true; } if ($vwplc0nobe === false) { if (wplsbzgvp::wplc4na('groups') == '') { $vwplc0nobe['memb_db_fields']['groups'] = ''; $vwplc0nobe['memb_user']['GroupNames'] = ''; } else { $vwple5y1zo = wplsbzgvp::wplc4na('groups'); $vwplqa3p = $_SESSION['memb_user']['GroupNames']; } } else { $vwple5y1zo = isset($vwplc0nobe['memb_db_fields']['groups']) ? $vwplc0nobe['memb_db_fields']['groups'] : ''; $vwplqa3p = isset($vwplc0nobe['memb_user']['GroupNames']) ? $vwplc0nobe['memb_user']['GroupNames'] : ''; } if (empty($vwple5y1zo) ) { return false; } if (is_array($vwpls0hwb5) ) { $vwpls0hwb5 = trim(implode(',', $vwpls0hwb5), ','); } if ($vwpls0hwb5 === $vwple5y1zo) { return true; } $vwplcjywg = false; $vwpls0hwb5 = preg_replace(array('/, */', '/ *,/'), ',', $vwpls0hwb5); $vwpls0hwb5 = preg_replace(array('/^,/', '/,$/'), '', $vwpls0hwb5); $vwpls0hwb5 = trim($vwpls0hwb5); $vwplahvu = array_filter(explode(',', strtolower(trim($vwpls0hwb5) ) ) ); $vwplwqkl0o = implode(',', $vwplahvu); $vwple5y1zo = array_filter(explode(',', $vwple5y1zo) ); $vwplqa3p = array_filter(explode(MEMBERIUM_DELIMITER, strtolower($vwplqa3p) ) ); $vwpliy45 = array(); $vwplfk3_9u = array();  foreach($vwplahvu as $vwpltmveju) { if (substr($vwpltmveju, 0, 1) <> '-') { $vwpliy45[] = $vwpltmveju; } else { $vwplfk3_9u[] = substr($vwpltmveju, 1); } }  $vwplkx_7zd = false; $vwplnnyt = 0; if (count($vwpliy45) ) { $vwplnnyt = count(array_intersect($vwpliy45, $vwple5y1zo) ) + count(array_intersect($vwpliy45, $vwplqa3p) ); $vwplkx_7zd = (boolean) $vwplnnyt; } else { $vwplnnyt = 0; $vwplkx_7zd = true; }  $vwplxamfit = false; $vwplvm854 = 0; if (count($vwplfk3_9u) ) { $vwplvm854 = count(array_intersect($vwplfk3_9u, $vwple5y1zo) ) + count(array_intersect($vwplfk3_9u, $vwplqa3p) ); $vwplxamfit = ! (boolean) $vwplvm854; } else { $vwplvm854 = 0; $vwplxamfit = true; }  $vwplcjywg = false; if (count($vwpliy45) ) { $vwplcjywg = $vwplcjywg || $vwplkx_7zd; } if (count($vwplfk3_9u) ) { $vwplcjywg = $vwplcjywg || $vwplxamfit; } return $vwplcjywg; }  static function wplid3nye($vwpls0hwb5, $vwplvtmqd = false) {  if (empty($vwpls0hwb5) ) { return false; } if (! $vwplvtmqd) { $vwplvtmqd = wplsbzgvp::wplfhxj9(); }  if (! $vwplvtmqd) { if (current_user_can('manage_options') ) { return true; } return false; }  if (! wpln9_s::wplq6kurm() ) { return false; } if (! is_array($vwpls0hwb5) ) { $vwpls0hwb5 = explode(',', $vwpls0hwb5); } if ($vwplvtmqd == wplsbzgvp::wplfhxj9() ) { $vwple5y1zo = wplsbzgvp::wplc4na('groups'); $vwplqa3p = $_SESSION['memb_user']['GroupNames']; } else { $vwpllzly5b = wpllbej::wplsgpnk($vwplvtmqd); if ($vwpllzly5b) {  $vwplc0nobe = memberium_app()->wplyte2($vwpllzly5b); $vwple5y1zo = $vwplc0nobe['memb_db_fields']['groups']; $vwplqa3p = $vwplc0nobe['memb_user']['GroupNames']; } } if ($vwplvtmqd > 0) { $vwple5y1zo = explode(',', $vwple5y1zo); $vwplqa3p = explode(MEMBERIUM_DELIMITER, strtolower($vwplqa3p) ); foreach ($vwpls0hwb5 as $vwpltmveju) { if (substr($vwpltmveju, 0, 1) == '-') { $vwpltmveju = strtolower(ltrim($vwpltmveju, '-') ); if (in_array($vwpltmveju, $vwple5y1zo) || in_array($vwpltmveju, $vwplqa3p) ) { return false; } } else { $vwpltmveju = strtolower($vwpltmveju); if (! in_array($vwpltmveju, $vwple5y1zo) && ! in_array($vwpltmveju, $vwplqa3p) ) { return false; } } } return true; } return false; }     function wplmta7($vwplvtmqd) { global $wpdb; static $vwplbk4ir; if ($vwplbk4ir[$vwplvtmqd]) { return $vwplbk4ir[$vwplvtmqd]; } $vwplvtmqd = (int) $vwplvtmqd; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwpla54ov0 = MEMBERIUM_DB_AFFILIATES; $vwplx1ap5_ = "SELECT 'id' FROM `{$vwpla54ov0}` WHERE `appname` = '{$vwplw5rgd3}' AND `fieldname` = 'ContactId' AND `value` = '%d'"; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplvtmqd); $vwplyio4f = $wpdb->get_var($vwplx1ap5_); if (! empty($vwplyio4f) ) { $vwplbk4ir[$vwplvtmqd] = $vwplyio4f; } return $vwplyio4f; } function wpltg3os($vwplg_xkl) { global $wpdb; $vwplg_xkl = (int) $vwplg_xkl; if (empty($vwplg_xkl)) { return; } $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwpla54ov0 = MEMBERIUM_DB_AFFILIATES; $vwplx1ap5_ = "DELETE FROM `{$vwpla54ov0}` WHERE `id` = %d"; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplg_xkl); $wpdb->query($vwplx1ap5_); } function wplre8ug3($vwplopnf) { global $wpdb; $vwplopnf = (int) $vwplopnf; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplzjoacw = MEMBERIUM_DB_AFFILIATES; $vwplun47e = array(); $vwplx1ap5_ = "SELECT `fieldname`, `value` FROM `{$vwplzjoacw}` WHERE `appname` = %s AND `id` = %d "; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplw5rgd3, $vwplopnf); $vwpltsywc = $wpdb->get_results($vwplx1ap5_, ARRAY_A); if (empty($vwpltsywc) ) { $vwpllah926 = $this->wpli_vpm($vwplopnf); $vwpllah926['!source'] = 'Remote'; } else { $vwpllah926 = array(); foreach ($vwpltsywc as $vwplheakg) { $vwpllah926[$vwplheakg['fieldname']] = $vwplheakg['value']; } $vwpllah926['!source'] = 'Local'; } return $vwpllah926; } function wplajl70($vwplvtmqd) { global $wpdb; static $cached_affiliate_id = array(); if (isset($cached_affiliate_id[$vwplvtmqd]) ) { return $cached_affiliate_id[$vwplvtmqd]; } if (empty($vwplvtmqd) ) { $vwplvtmqd = (int) wplsbzgvp::wplfhxj9(); } if ($vwplvtmqd < 1) { return 0; }  $vwplvtmqd = (int) $vwplvtmqd; $vwpliaje = array(); $vwplanieul = 1000; $vwplho_n = 0; $vwplnzlj0t = 'Referral'; $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t, false); $vwple7lbh = 0;; $vwplv80sz = array( 'ContactId' => $vwplvtmqd, ); $vwplh6te = ($this->options['settings']['referral_partner_order'] == 1); do { $vwply4j8x = $this->isdk->dsQueryOrderBy($vwplnzlj0t, (int) $vwplanieul, (int) $vwplho_n, $vwplv80sz, $vwplc0g3p, 'Id', true); if (is_array($vwply4j8x) ) { foreach ($vwply4j8x as $vwplheakg) { if (! isset($vwplheakg['DateExpires']) || $vwplheakg['DateExpires'] >= date('Ymd\T00:00:00') ) { $vwpliaje[$vwplheakg['Id']] = $vwplheakg; } } $vwplho_n++; $vwple7lbh = $vwple7lbh + count($vwply4j8x); } } while (count($vwply4j8x) == $vwplanieul); if ($vwplh6te) { $vwpltwmlqb = array_shift($vwpliaje); } else { $vwpltwmlqb = array_pop($vwpliaje); } unset($vwpliaje, $vwply4j8x); $cached_affiliate_id[$vwplvtmqd] = isset($vwpltwmlqb['AffiliateId']) ? $vwpltwmlqb['AffiliateId'] : 0; return $cached_affiliate_id[$vwplvtmqd]; } function wplei4rgx($vwplvtmqd = 0, $vwplyclph = false) { $vwplvtmqd = (int) $vwplvtmqd; $vwplyclph = (bool) $vwplyclph; global $wpdb; static $vwplxw2m; if (empty($vwplvtmqd)) { return false; } if (wp_doing_ajax()) { return; } $vwplnu14gq = wplz8bid::wplvf1d('settings', 'max_affiliate_age', 0); $vwpllzly5b = wpllbej::wplsgpnk($vwplvtmqd); $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplmr5_ = "memberium/{$vwplw5rgd3}/affiliate/updated"; $vwplgjp7v = time(); $vwplomw_9 = 0;  if ($vwplnu14gq && ($vwplyclph == false) ) { $vwpls04fl7 = $vwplgjp7v - (int) get_user_meta($vwpllzly5b, $vwplmr5_, true); if ($vwpls04fl7 < $vwplnu14gq) { return true; } } $vwpldv1yjr = $this->i2sdk->isdk; $vwplanieul = 1; $vwplnzlj0t = 'Affiliate'; $vwplho_n = 0; $vwplnzrsa = 'ContactId'; $vwpltsj75x = $vwplvtmqd; $vwpla54ov0 = MEMBERIUM_DB_AFFILIATES; $vwple7lbh = 0; $vwplv80sz = array('ContactId' => $vwplvtmqd); $vwpljz9txv = array(); $vwplmu62n = array(); $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t, true); $vwplfvwe = wplz8bid::wplvf1d('settings', 'plaintext_db', 0); $vwplheakg = $vwpldv1yjr->dsQueryOrderBy($vwplnzlj0t, $vwplanieul, $vwplho_n, $vwplv80sz, $vwplc0g3p, 'Id', true); if (! is_array($vwplheakg)) { return false; } if (empty($vwplheakg)) { $vwplg_xkl = $this->wplmta7($vwplvtmqd); if ($vwplg_xkl) { $this->wpltg3os($vwplg_xkl); } update_user_meta($vwpllzly5b, $vwplmr5_, $vwplgjp7v); } else { $vwplheakg = array_shift($vwplheakg); $vwplheakg['!LastUpdated'] = $vwplgjp7v; $vwplg_xkl = isset($vwplheakg['Id']) ? $vwplheakg['Id'] : 0; if ($vwplg_xkl) { foreach ($vwplheakg as $vwply17edn => $vwplph268z) { if ($vwplfvwe) { $vwplph268z = iconv('UTF-8', 'ISO-8859-1//IGNORE', remove_accents($vwplph268z) ); } $vwpljz9txv[] = $wpdb->prepare('(%d, %s, %s, %s)', $vwplg_xkl, $vwplw5rgd3, $vwply17edn, $vwplph268z); $vwplmu62n[$vwply17edn] = $vwplph268z; if ($vwply17edn != $this->options['settings']['password_field']) { $vwplph268z = wp_strip_all_tags($vwplph268z); } $vwplph268z = ($vwplph268z <> 'null') ? $vwplph268z : ''; } if (! empty($vwpljz9txv)) { $vwplx1ap5_ = "INSERT INTO {$vwpla54ov0} (id, appname, fieldname, value) VALUES " . implode(',', $vwpljz9txv) . " ON DUPLICATE KEY UPDATE id=VALUES(id), appname=VALUES(appname), fieldname=VALUES(fieldname), value=VALUES(value);"; $wpdb->query($vwplx1ap5_); update_user_meta($vwpllzly5b, $vwplmr5_, $vwplgjp7v); } } } return true; } function wpldzr6x1($vwplvtmqd = 0) { global $wpdb; static $vwplxw2m; if (! empty($vwplvtmqd) && isset($vwplxw2m[$vwplvtmqd]) ) { return $vwplxw2m[$vwplvtmqd]; } $vwplnmgpy1 = $this->options; $vwplfqgl3j = $this->i2sdk_options; $vwplrkn_ = $this->i2sdk; $vwpldv1yjr = $vwplrkn_->isdk; $vwplvtmqd = (int) $vwplvtmqd; $vwplanieul = 1000; $vwplnzlj0t = 'Affiliate'; $vwplho_n = 0; $vwplnzrsa = 'ContactId'; $vwpltsj75x = ($vwplvtmqd > 0) ? (int) $vwplvtmqd : '%'; $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t, true); $vwpla54ov0 = MEMBERIUM_DB_AFFILIATES; $vwple7lbh = 0; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); if ($vwplvtmqd == 0) { $vwplv80sz = array( 'ContactId' => '%' ); } else { $vwplv80sz = array( 'ContactId' => $vwplvtmqd ); } $vwplu8vy = array(); do { $vwply4j8x = $vwpldv1yjr->dsQueryOrderBy($vwplnzlj0t, $vwplanieul, $vwplho_n, $vwplv80sz, $vwplc0g3p, 'Id', true); if (is_array($vwply4j8x) && ! empty($vwply4j8x) ) { $vwplqzdlu3 = array(); $vwpljz9txv = array(); foreach ($vwply4j8x as $vwplheakg) { $vwplheakg['!LastUpdated'] = time(); $vwplopnf = (int) $vwplheakg['Id']; $vwplu8vy[] = $vwplopnf; $vwplmu62n[] = array(); foreach ($vwplheakg as $vwply17edn=>$vwplph268z) { if ($this->options['settings']['plaintext_db']) { $vwplph268z = iconv("UTF-8", "ISO-8859-1//IGNORE", remove_accents($vwplph268z) ); } $vwpljz9txv[] = $wpdb->prepare('(%d, %s, %s, %s)', $vwplopnf, $vwplw5rgd3, $vwply17edn, $vwplph268z); $vwplmu62n[] = $vwply17edn; if ($vwply17edn != $this->options['settings']['password_field']) { $vwplph268z = wp_strip_all_tags($vwplph268z); } $vwplph268z = ($vwplph268z <> 'null') ? $vwplph268z : ''; } } $vwplx1ap5_ = "INSERT INTO {$vwpla54ov0} (id, appname, fieldname, value) VALUES " . implode(',', $vwpljz9txv) . " ON DUPLICATE KEY UPDATE id=VALUES(id), appname=VALUES(appname), fieldname=VALUES(fieldname), value=VALUES(value);"; $wpdb->query($vwplx1ap5_); } $vwplho_n++; $vwple7lbh = $vwple7lbh + count($vwply4j8x); } while (count($vwply4j8x) == $vwplanieul); if (! empty($vwplu8vy) ) { $vwplx1ap5_ = "DELETE FROM {$vwpla54ov0} WHERE `appname` = '{$vwplw5rgd3}' AND `id` NOT IN (" . implode(',', $vwplu8vy) . ");"; $wpdb->query($vwplx1ap5_); } if ($vwplvtmqd == 0) {   set_transient('memberium_affiliates_updated', time() ); } $vwplxw2m[$vwplvtmqd] = $vwple7lbh; return $vwple7lbh; } function wpli_vpm($vwplopnf) { global $wpdb; $vwplnmgpy1 = $this->options; $vwplfqgl3j = $this->i2sdk_options; $vwplrkn_ = $this->i2sdk; $vwpldv1yjr = $vwplrkn_->isdk; $vwplopnf = (int) $vwplopnf; $vwplnzlj0t = 'Affiliate'; $vwplzjoacw = MEMBERIUM_DB_AFFILIATES; $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t, true); $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplheakg = $vwpldv1yjr->dsLoad($vwplnzlj0t, $vwplopnf, $vwplc0g3p); $vwplx1ap5_ = "DELETE FROM `{$vwplzjoacw}` WHERE `appname` = %s AND `id` = %d "; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplw5rgd3, $vwplopnf); $wpdb->query($vwplx1ap5_); if (count($vwplheakg) > 1) { $vwplheakg['!lastupdated'] = time(); foreach ($vwplheakg as $vwple2yn=>$vwplph268z) { if ($vwple2yn != $this->options['settings']['password_field']) { $vwplph268z = wp_strip_all_tags($vwplph268z); } $vwplx1ap5_ = "INSERT INTO `{$vwplzjoacw}` (`id`, `appname`, `fieldname`, `value`) VALUES (%d, %s, %s, %s)"; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplopnf, $vwplw5rgd3, $vwple2yn, $vwplph268z); $vwplyio4f = $wpdb->query($vwplx1ap5_); } return $vwplheakg; } else { return array(); } } function wplsxk3m() { global $wpdb; } function wplcc08p($vwplg_xkl, $vwpl_a8f2 = '', $vwplga5e = '') { $vwplg_xkl = (int) $vwplg_xkl; $vwplx1ap5_ = prepare('SELECT count(id) FROM `' . MEMBERIUM_DB_INVOICES . '` WHERE affiliateid = %d ', $vwplg_xkl); if ($vwpl_a8f2) { $vwplx1ap5_ .= $wpdb->prepare('AND datecreated >= %s ', date('Y-m-d h:i:s', strtotime($vwpl_a8f2) ) ); } if ($vwplga5e) { $vwplx1ap5_ .= $wpdb->prepare('AND datecreated <= %s ', date('Y-m-d h:i:s', strtotime($vwplga5e) ) ); } }    function wplxjyl9($vwplgitq) { $vwplsb_pf = array( 'format' => 'serial', 'invoice_id' => 0, 'contact_id' => $this->wplubo6(), ); $vwplgitq = wp_parse_args($vwplgitq, $vwplsb_pf); $vwplvrne94 = (int) $vwplgitq['invoice_id']; $vwplvtmqd = (int) $vwplgitq['contact_id']; $vwply9silk = strtolower(trim($vwplgitq['format']) ); $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplsekv = 'Memberium:' . $vwplw5rgd3 . '::Receipt:' . $vwplvrne94 . '::Contact:' . $vwplvtmqd; $vwplu9qk02 = array( 'invoice' => array(), 'job' => array(), 'invoiceitems' => array(), 'payments' => array(), 'paymentplan' => array(), 'paymentplanitems' => array(), 'contact' => array(), ); $vwplu9qk02 = get_transient($vwplsekv); if ($vwplu9qk02 === false) { if ($vwplvrne94) {  $vwplnzlj0t = 'Invoice'; $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t, false); $vwpl_z_dl = $this->isdk->dsLoad($vwplnzlj0t, (int) $vwplvrne94, $vwplc0g3p); if (! is_super_admin() ) { if (isset($vwpl_z_dl['ContactId']) && $vwpl_z_dl['ContactId'] == $vwplvtmqd) { $vwplvrne94 = empty($vwpl_z_dl['Id']) ? 0 : (int) $vwpl_z_dl['Id']; $vwplvzgui = empty($vwpl_z_dl['JobId']) ? 0 : (int) $vwpl_z_dl['JobId']; } else { $vwplvrne94 = 0; } } if ($vwplvrne94) { $vwplu9qk02['invoice'] = array_change_key_case($vwpl_z_dl, CASE_LOWER); $vwplu9qk02['invoice']['totaldue'] = $vwplu9qk02['invoice']['totaldue']; $vwplu9qk02['invoice']['invoicetotal'] = $vwplu9qk02['invoice']['invoicetotal']; $vwplu9qk02['invoice']['totalpaid'] = $vwplu9qk02['invoice']['totalpaid'];  $vwplu9qk02['contact'] = wpllbej::wplrande($vwplvtmqd, true);  if ($vwplvzgui) { $vwplnzlj0t = 'Job'; $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t, false); $vwplu1i6 = $this->isdk->dsLoad($vwplnzlj0t, (int) $vwplvzgui, $vwplc0g3p); if (is_array($vwplu1i6) ) { $vwplu9qk02['job'] = array_change_key_case($vwplu1i6, CASE_LOWER); }  $vwplnzlj0t = 'OrderItem'; $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t, false); $vwplanieul = 1000; $vwplho_n = 0; $vwplv80sz = array('OrderId' => $vwplvzgui); $vwplnczg = 'Id'; $vwplh6te = true; $vwplntrx = $this->isdk->dsQueryOrderBy($vwplnzlj0t, $vwplanieul, $vwplho_n, $vwplv80sz, $vwplc0g3p, $vwplnczg, $vwplh6te); if (is_array($vwplntrx) ) { foreach($vwplntrx as $vwply17edn => $vwplph268z) { $vwplntrx[$vwply17edn] = array_change_key_case($vwplph268z, CASE_LOWER); $vwplntrx[$vwply17edn]['ppu'] = $vwplntrx[$vwply17edn]['ppu']; $vwplntrx[$vwply17edn]['cpu'] = $vwplntrx[$vwply17edn]['cpu']; } $vwplu9qk02['orderitems'] = $vwplntrx; } }  $vwplnzlj0t = 'InvoiceItem'; $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t, false); $vwplanieul = 1000; $vwplho_n = 0; $vwplv80sz = array('InvoiceId' => $vwplvrne94); $vwplnczg = 'Id'; $vwplh6te = true; $vwplntrx = $this->isdk->dsQueryOrderBy($vwplnzlj0t, $vwplanieul, $vwplho_n, $vwplv80sz, $vwplc0g3p, $vwplnczg, $vwplh6te); if (is_array($vwplntrx) ) { foreach($vwplntrx as $vwply17edn => $vwplph268z) { $vwplntrx[$vwply17edn] = array_change_key_case($vwplph268z, CASE_LOWER); $vwplntrx[$vwply17edn]['ppu'] = $vwplntrx[$vwply17edn]['ppu']; $vwplntrx[$vwply17edn]['cpu'] = $vwplntrx[$vwply17edn]['cpu']; $vwplntrx[$vwply17edn]['invoiceamt'] = $vwplntrx[$vwply17edn]['invoiceamt']; } $vwplu9qk02['invoiceitems'] = $vwplntrx; }  $vwplnzlj0t = 'Payment'; $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t, false); $vwplanieul = 1000; $vwplho_n = 0; $vwplv80sz = array('InvoiceId' => $vwplvrne94); $vwplnczg = 'Id'; $vwplh6te = true; $vwplw0anz = $this->isdk->dsQueryOrderBy($vwplnzlj0t, $vwplanieul, $vwplho_n, $vwplv80sz, $vwplc0g3p, $vwplnczg, $vwplh6te); $vwplim7z = 0; if (is_array($vwplw0anz) ) { foreach($vwplw0anz as $vwply17edn => $vwplph268z) { $vwplw0anz[$vwply17edn] = array_change_key_case($vwplph268z, CASE_LOWER); $vwplw0anz[$vwply17edn]['payamt'] = $vwplw0anz[$vwply17edn]['payamt']; } $vwplu9qk02['payments'] = $vwplw0anz; } if ($vwpl_z_dl['TotalPaid'] < $vwpl_z_dl['InvoiceTotal']) {  $vwplnzlj0t = 'PayPlan'; $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t, false); $vwplanieul = 1000; $vwplho_n = 0; $vwplv80sz = array('InvoiceId' => $vwplvrne94); $vwplnczg = 'Id'; $vwplh6te = true; $vwplewga = $this->isdk->dsQueryOrderBy($vwplnzlj0t, $vwplanieul, $vwplho_n, $vwplv80sz, $vwplc0g3p, $vwplnczg, $vwplh6te); if (is_array($vwplewga) ) { foreach($vwplewga as $vwply17edn => $vwplph268z) { $vwplewga[$vwply17edn] = array_change_key_case($vwplph268z, CASE_LOWER); $vwplewga[$vwply17edn]['amtdue'] = $vwplewga[$vwply17edn]['amtdue']; $vwplewga[$vwply17edn]['firstpayamt'] = $vwplewga[$vwply17edn]['firstpayamt']; } $vwplu9qk02['paymentplan'] = $vwplewga[0]; }  $vwplnzlj0t = 'PayPlanItem'; $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t, false); $vwplanieul = 1000; $vwplho_n = 0; $vwplv80sz = array('PayPlanId' => $vwplewga[0]['id']); $vwplnczg = 'Id'; $vwplh6te = true; $vwplh1i4 = $this->isdk->dsQueryOrderBy($vwplnzlj0t, $vwplanieul, $vwplho_n, $vwplv80sz, $vwplc0g3p, $vwplnczg, $vwplh6te); if (is_array($vwplh1i4) ) { foreach($vwplh1i4 as $vwply17edn => $vwplph268z) { $vwplh1i4[$vwply17edn] = array_change_key_case($vwplph268z, CASE_LOWER); } $vwplu9qk02['paymentplanitems'] = $vwplh1i4; } } } } } set_transient($vwplsekv, $vwplu9qk02, HOUR_IN_SECONDS * 3); if ($vwply9silk == 'json') { $vwplu9qk02 = json_encode($vwplu9qk02); } return $vwplu9qk02; } function wplde7m6($vwplvtmqd, $vwplyl3_ = true, $vwpllu1rg = true, $vwplth5iy_ = false) { $vwplvtmqd = (int) $vwplvtmqd; if ($vwplvtmqd < 1) { return array(); } $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplsekv = 'Memberium::' . $vwplw5rgd3 . '::Invoices::' . $vwplvtmqd; $vwplu2wa = array(); if (! $vwplth5iy_) { $vwply4j8x = get_transient($vwplsekv); } if (empty($vwplu2wa) ) { $vwplh6te = true; $vwplnczg = 'DateCreated'; $vwplv80sz = array( 'ContactId' => (int) $vwplvtmqd ); $vwplc0g3p = array( 'Id', 'CreditStatus', 'DateCreated', 'Description', 'InvoiceTotal', 'InvoiceType', 'JobId', 'PayPlanStatus', 'PayStatus', 'ProductSold', 'RefundStatus', 'TotalDue', 'TotalPaid', ); $vwply4j8x = $this->isdk->dsQueryOrderBy('Invoice', 1000, 0, $vwplv80sz, $vwplc0g3p, $vwplnczg, $vwplh6te); set_transient($vwplsekv, $vwply4j8x, 1800); } foreach($vwply4j8x as $vwplheakg) { $vwplopnf = $vwplheakg['Id']; $vwplheakg['!payment_due'] = ($vwplheakg['TotalDue'] - $vwplheakg['TotalPaid']); if ($vwplyl3_ && empty($vwplheakg['!payment_due']) ) { $vwplu2wa[$vwplopnf] = $vwplheakg;  } if ($vwpllu1rg && (! empty($vwplheakg['!payment_due']) ) ) { $vwplu2wa[$vwplopnf] = $vwplheakg;      } } return $vwplu2wa; } function wplg3umnq($vwplvrne94 = 0) { $vwplvrne94 = (int) $vwplvrne94; if ($vwplvrne94 < 1) { return array(); } $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplsekv = "Memberium::{$vwplw5rgd3}::Invoice::{$vwplvrne94}"; $vwplu2wa = array(); $vwply4j8x = get_transient($vwplsekv); if (empty($vwply4j8x) ) { $vwplu2wa = $this->wplde7m6($vwplvtmqd, true, true); } if (empty($vwply4j8x) ) { $vwplh6te = true; $vwplnczg = 'DateCreated'; $vwplv80sz = array( 'ContactId' => (int) $vwplvtmqd ); $return_fields = array( 'Id', 'CreditStatus', 'DateCreated', 'Description', 'InvoiceTotal', 'InvoiceType', 'PayPlanStatus', 'PayStatus', 'ProductSold', 'RefundStatus', 'TotalDue', 'TotalPaid', ); $vwply4j8x = $this->isdk->dsQueryOrderBy('Invoice', 1000, 0, $vwplv80sz, $return_fields, $vwplnczg, $vwplh6te); set_transient($vwplsekv, $vwply4j8x, 1800); } foreach ($vwply4j8x as $vwplheakg) { if ($vwplyl3_ && $vwplheakg['PayStatus'] == 1) { $vwplu2wa[$vwplheakg['Id']] = $vwplheakg; $vwplu2wa[$vwplheakg['Id']]['!amountdue'] = 0; $vwplu2wa[$vwplheakg['Id']]['!amountpaid'] = $vwplheakg['TotalPaid']; } if ($unpaid && $vwplheakg['InvoiceTotal'] > $vwplheakg['TotalPaid']) { $vwplu2wa[$vwplheakg['Id']] = $vwplheakg; $vwplu2wa[$vwplheakg['Id']]['!payplan'] = $this->wplq5zf( (int) $vwplheakg['Id']); $vwplu2wa[$vwplheakg['Id']]['!payplanitems'] = $this->wplnz1pv( (int) $vwplu2wa[$vwplheakg['Id']]['!payplan']['Id']); foreach ($vwplu2wa[$vwplheakg['Id']]['!payplanitems'] as $payplanitem) { if (isset($payplanitem['AmtDue']) && $payplanitem['AmtDue'] > 0) { $vwplu2wa[$vwplheakg['Id']]['!amountdue'] = $payplanitem['AmtDue']; $vwplu2wa[$vwplheakg['Id']]['!amountpaid'] = $payplanitem['AmtPaid']; break; } else { } } } } return $vwplu2wa; } function wplbzli($vwplvzgui = 0) { $vwplvzgui = (int) $vwplvzgui; if ($vwplvzgui < 1) { return array(); } $vwplv80sz = array( 'JobId' => $vwplvzgui ); $vwplnzlj0t = 'Invoice'; $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t); $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplu2wa = $this->isdk->dsQueryOrderBy($vwplnzlj0t, 1, 0, $vwplv80sz, $vwplc0g3p); $vwpl_z_dl = array(); if (is_array($vwplu2wa) && isset($vwplu2wa[0]) ) { $vwpl_z_dl = (is_array($vwplu2wa) && isset($vwplu2wa[0]) ) ? $vwplu2wa[0] : array(); $vwplsekv = "Memberium::{$vwplw5rgd3}::Invoice::{$vwpl_z_dl['Id']}"; set_transient($vwplsekv, $vwpl_z_dl, 1800); } return $vwpl_z_dl; } function wplq5zf($vwplvrne94 = 0) { if ($vwplvrne94 == 0) { return FALSE; } $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplsekv = "Memberium::{$vwplw5rgd3}::PayPlans::{$vwplvrne94}"; $vwpleivdm = get_transient($vwplsekv); if (! empty($vwpleivdm) ) { return $vwpleivdm; } $vwplvrne94 = (int) $vwplvrne94; $vwplnzlj0t = 'PayPlan'; $vwplv80sz = array('InvoiceId' => $vwplvrne94); $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t); $vwpleivdm = $this->isdk->dsQuery($vwplnzlj0t, 1, 0, $vwplv80sz, $vwplc0g3p); if (is_array($vwpleivdm) && count($vwpleivdm) > 0) { set_transient($vwplsekv, $vwpleivdm[0], 1800); return $vwpleivdm[0]; } else { return FALSE; } } function wplnz1pv($vwplezsi = 0) { if ($vwplezsi == 0) { return FALSE; } $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplsekv = 'Memberium::' . $vwplw5rgd3 . '::PayPlanItems::' . $vwplezsi; $vwplv2rt6j = get_transient($vwplsekv); if (is_array($vwplv2rt6j) ) {  } $vwplnzlj0t = 'PayPlanItem'; $vwplv80sz = array('PayPlanId' => (int) $vwplezsi); $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t); $vwplv2rt6j = $this->isdk->dsQueryOrderBy($vwplnzlj0t, 1000, 0, $vwplv80sz, $vwplc0g3p, 'DateDue', 1 ); if (count($vwplv2rt6j) > 0) { set_transient($vwplsekv, $vwplv2rt6j, 1800); return $vwplv2rt6j; } else { return FALSE; } } function wplrtxvdy() { $vwplanieul = 1000; $vwplnzlj0t = 'SubscriptionPlan'; $vwplho_n = 0; $vwplnzrsa = 'Id'; $vwpltsj75x = '%'; $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t, false); $vwple7lbh = 0; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplsekv = 'Memberium::' . $vwplw5rgd3 . '::SubscriptionPlans'; $vwplv80sz = array( 'Id' => $vwpltsj75x ); $vwplyoqc = array(); do { $vwply4j8x = $this->isdk->dsQuery($vwplnzlj0t, $vwplanieul, $vwplho_n, $vwplv80sz, $vwplc0g3p); if (is_array($vwply4j8x) ) { foreach ($vwply4j8x as $vwplheakg) { $vwplyoqc[$vwplheakg['Id']] = $vwplheakg; } $vwplho_n++; $vwple7lbh = $vwple7lbh + count($vwply4j8x); } } while (count($vwply4j8x) == $vwplanieul); unset($vwply4j8x, $vwplheakg); foreach($vwplyoqc as $vwplopnf => $vwplheakg) { switch ( (int) $vwplheakg['Cycle']) { case 6: $vwplyoqc[$vwplopnf]['FrequencyWord'] = ($vwplheakg['Frequency'] == 1) ? 'Day' : $vwplheakg['Frequency'] . ' Days'; break; case 3: $vwplyoqc[$vwplopnf]['FrequencyWord'] = ($vwplheakg['Frequency'] == 1) ? 'Week' : $vwplheakg['Frequency'] . ' Weeks'; break; case 2: $vwplyoqc[$vwplopnf]['FrequencyWord'] = ($vwplheakg['Frequency'] == 1) ? 'Month' : $vwplheakg['Frequency'] . ' Months'; break; case 1: $vwplyoqc[$vwplopnf]['FrequencyWord'] = ($vwplheakg['Frequency'] == 1) ? 'Year' : $vwplheakg['Frequency'] . ' Yearly'; break; } } if (! empty($vwplyoqc) && is_array($vwplyoqc) ) { set_transient($vwplsekv, $vwplyoqc, (3 * HOUR_IN_SECONDS) ); } else { $vwplyoqc = false; } return $vwplyoqc; } function wplvkevh() { $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplsekv = 'Memberium::' . $vwplw5rgd3 . '::SubscriptionPlans'; $vwplqkp4 = get_transient($vwplsekv); if (empty($vwplqkp4) ) { $vwplqkp4 = $this->wplrtxvdy(); } return $vwplqkp4; } function wplz8c3mi($vwplvzgui = 0) { if ($vwplvzgui == 0) { return FALSE; } $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplvzgui = (int) $vwplvzgui; $vwplsekv = "Memberium::{$vwplw5rgd3}::OrderItems::{$vwplvzgui}"; $vwplascr = get_transient($vwplsekv); if (! empty($vwplascr) ) { return $vwplascr; } unset($vwplascr); $vwplnzlj0t = 'OrderItem'; $vwplv80sz = array('OrderId' => $vwplvzgui); $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t); $vwplascr = $this->isdk->dsQuery($vwplnzlj0t, 1000, 0, $vwplv80sz, $vwplc0g3p); if (! empty($vwplascr) ) { if (is_array($vwplascr) ) { set_transient($vwplsekv, $vwplascr, 1800); return $vwplascr; } } return FALSE; } function wpljkrho($vwplvtmqd = 0, $vwplth5iy_ = false) { if ($vwplvtmqd == 0) { $vwplvtmqd = $this->wplubo6(); } $vwplsekv = 'memberium_subscriptions::' . $vwplvtmqd; $vwplurqb3 = get_transient($vwplsekv); if ($vwplurqb3 === false || $vwplth5iy_) { $vwplv80sz = array( 'ContactId' => $vwplvtmqd ); $vwplc0g3p = wpllbej::wplntnyv('RecurringOrder'); $vwplnczg = 'Id'; $vwplh6te = false; $vwply4j8x = $this->isdk->dsQueryOrderBy('RecurringOrder', 999, 0, $vwplv80sz, $vwplc0g3p, $vwplnczg, $vwplh6te); if (is_array($vwply4j8x) && ! empty($vwply4j8x) ) { foreach ($vwply4j8x as $vwplheakg) { $vwplurqb3[$vwplheakg['Id']] = $vwplheakg; } } set_transient($vwplsekv, $vwplurqb3, HOUR_IN_SECONDS / 12); unset($vwply4j8x, $vwplheakg, $vwplc0g3p, $vwplv80sz); } if (is_array($vwplurqb3) ) { foreach($vwplurqb3 as $vwplyq9i7o => $vwplcjpa) { if (! empty($vwplcjpa['EndDate']) && $vwplcjpa['Status'] == 'Active' && $vwplcjpa['EndDate'] < date('Ymd') ) { $vwplcjpa['Status'] = 'Inactive'; } if ($vwplcjpa['Status'] <> 'Active') { $vwplcjpa['NextBillDate'] = ''; } $vwplurqb3[$vwplyq9i7o] = $vwplcjpa; } } return $vwplurqb3; } function wplapzv($vwplvtmqd = 0) { global $wpdb; $vwpla54ov0 = MEMBERIUM_DB_INVOICES; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplx1ap5_ = "SELECT MAX(`jobid`) FROM `{$vwpla54ov0}` WHERE `appname` = '{$vwplw5rgd3}' AND `contactid` = {$vwplvtmqd};"; return (int) $wpdb->get_var($vwplx1ap5_); } function wplfq39() { global $wpdb; $vwpla54ov0 = MEMBERIUM_DB_INVOICES; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplx1ap5_ = "SELECT MAX(`jobid`) FROM `{$vwpla54ov0}` WHERE `appname` = '{$vwplw5rgd3}';"; return (int) $wpdb->get_var($vwplx1ap5_); } function wplngcp6() { global $wpdb; $vwpla54ov0 = MEMBERIUM_DB_INVOICES; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplx1ap5_ = "SELECT MAX(`datecreateed`) FROM `{$vwpla54ov0}` WHERE `appname` = '{$vwplw5rgd3}';"; return strtotime($wpdb->get_var($vwplx1ap5_) ); } function wplblz7($vwplvrne94 = 0) { global $wpdb; $vwplktq3k = get_option('memberium_tables_updated', array() ); $vwplnmgpy1 = $this->options; $vwplfqgl3j = $this->i2sdk_options; $vwplrkn_ = $this->i2sdk; $vwpldv1yjr = $vwplrkn_->isdk; $vwpla54ov0 = MEMBERIUM_DB_INVOICES; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplktq3k['invoices'] = isset($vwplktq3k['invoices']) ? $vwplktq3k['invoices'] : 0;  $vwplx1ap5_ = "SELECT MAX(`lastupdated`) FROM `{$vwpla54ov0}` WHERE `appname` = '{$vwplw5rgd3}';"; $vwplomw_9 = $wpdb->get_var($vwplx1ap5_); if (! $vwplomw_9) { $vwplomw_9 = '1969-01-20T00:00:00'; }  $vwplnzlj0t = 'Invoice'; $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t, false); $vwplanieul = 1000; $vwplho_n = 0; $vwple7lbh = 0; $vwplv80sz = array( 'LastUpdated' => '~>=~ ' . $vwplomw_9, ); $template_row = array( 'CreditStatus' => 0, 'Description' => '', 'InvoiceTotal' => 0, 'InvoiceType' => '', 'JobId' => 0, 'LeadAffiliateId' => 0, 'PayPlanStatus' => 0, 'PayStatus' => 0, 'ProductSold' => '', 'PromoCode' => '', 'RefundStatus' => 0, 'Synced' => 0, 'TotalDue' => 0, 'TotalPaid' => 0, ); do { $vwply4j8x = $vwpldv1yjr->dsQueryOrderBy($vwplnzlj0t, $vwplanieul, $vwplho_n, $vwplv80sz, $vwplc0g3p, 'LastUpdated', true); set_time_limit(30); if (is_array($vwply4j8x) && count($vwply4j8x) > 0) { foreach ($vwply4j8x as $vwplheakg) { $vwplheakg = array_merge($template_row, $vwplheakg); $vwplheakg['LastUpdated'] = (isset($vwplheakg['LastUpdated']) ) ? $vwplheakg['LastUpdated'] : $vwplheakg['DateCreated']; $vwplopnf = (int) $vwplheakg['Id']; $wpdb->query("DELETE FROM `{$vwpla54ov0}` WHERE `appname` = '{$vwplw5rgd3}' AND `id` = {$vwplopnf};"); $vwplx1ap5_ = "INSERT INTO `{$vwpla54ov0}` " . "(`id`, `appname`, `contactid`, `creditstatus`, `datecreated`, `description`, `invoicetotal`, `invoicetype`, `jobid`, `lastupdated`, `leadaffiliateid`, `payplanstatus`, `paystatus`, `productsold`, `promocode`, `refundstatus`, `totaldue`, `totalpaid`) " . "VALUES " . "(%d, %s, %d, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)"; $vwplx1ap5_ = $wpdb->prepare( $vwplx1ap5_, $vwplheakg['Id'], $vwplw5rgd3, $vwplheakg['ContactId'], $vwplheakg['CreditStatus'], date('Y-m-d h:i:s', strtotime($vwplheakg['DateCreated']) ), $vwplheakg['Description'], $vwplheakg['InvoiceTotal'], $vwplheakg['InvoiceType'], $vwplheakg['JobId'], date('Y-m-d h:i:s', strtotime($vwplheakg['LastUpdated']) ), $vwplheakg['LeadAffiliateId'], $vwplheakg['PayPlanStatus'], $vwplheakg['PayStatus'], ',' . $vwplheakg['ProductSold'] . ',', isset($vwplheakg['PromoCode']) ? $vwplheakg['PromoCode'] : '', $vwplheakg['RefundStatus'], $vwplheakg['Synced'], $vwplheakg['TotalDue'], $vwplheakg['TotalPaid'] ); $wpdb->query($vwplx1ap5_); } } $vwplho_n++; $vwple7lbh = $vwple7lbh + count($vwply4j8x); if ($vwple7lbh > 100) { break; } set_time_limit(30); } while (count($vwply4j8x) == $vwplanieul); $vwplktq3k['invoices'] = time(); update_option('memberium_tables_updated', $vwplktq3k, false); return $vwple7lbh; } function wplened8($vwplvtmqd = false) { global $wpdb; if (! $vwplvtmqd) { $vwplvtmqd = $this->wplubo6(); } $vwplsekv = "memberium_jobs::{$vwplvtmqd}"; $vwplc69y = get_transient($vwplsekv); $vwplc69y = false; if ($vwplc69y === false) { $vwplnmgpy1 = $this->options; $vwplfqgl3j = $this->i2sdk_options; $vwplrkn_ = $this->i2sdk; $vwpldv1yjr = $vwplrkn_->isdk; $vwpla54ov0 = MEMBERIUM_DB_JOBS; $vwplnzlj0t = 'Job'; $vwplc0g3p = wpllbej::wplntnyv($vwplnzlj0t, false); $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplanieul = 1000; $vwplho_n = 0; $vwple7lbh = 0; $vwplc69y = array(); $vwplv80sz = array( 'ContactId' => (int) $vwplvtmqd, ); do { set_time_limit(30); $vwply4j8x = $vwpldv1yjr->dsQueryOrderBy($vwplnzlj0t, $vwplanieul, $vwplho_n, $vwplv80sz, $vwplc0g3p, 'Id', true); if (is_array($vwply4j8x) ) { foreach($vwply4j8x as $vwplheakg) { $vwplc69y[$vwplheakg['Id']] = $vwplheakg; } } $vwplho_n++; } while (count($vwply4j8x) == $vwplanieul); $vwple7lbh = count($vwplc69y); if ($vwple7lbh) { set_transient($vwplsekv, $vwplc69y, HOUR_IN_SECONDS); } else { set_transient($vwplsekv, $vwplc69y, 300); } } $vwple7lbh = count($vwplc69y); return $vwplc69y; } function wplkxy8hg() { $vwplanieul = 999; $vwplnzlj0t = 'RecurringOrder'; $vwplho_n = 0; $vwplnzrsa = 'Id'; $vwpltsj75x = '%'; $vwple7lbh = 0; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplyoqc = array(); $vwplc0g3p = array( 'Id', 'Status', 'ContactId', 'EndDate', 'ReasonStopped', ); $vwplv80sz = array( 'Status' => 'Active', 'EndDate' => '~<=~' . date('Y-m-d'), ); do { $vwply4j8x = $this->isdk->dsQuery($vwplnzlj0t, $vwplanieul, $vwplho_n, $vwplv80sz, $vwplc0g3p); if (! empty($vwply4j8x) ) { foreach ($vwply4j8x as $vwplheakg) { $vwplheakg['EndDate'] = (isset($vwplheakg['EndDate']) ) ? $vwplheakg['EndDate'] : ''; $vwplheakg['ReasonStopped'] = (isset($vwplheakg['ReasonStopped']) ) ? trim($vwplheakg['ReasonStopped']) : ''; if ($vwplheakg['EndDate'] > '' && $vwplheakg['EndDate'] < date('Ymd\T00:00:00') ) { $vwploar5s = array(); if ($vwplheakg['ReasonStopped'] == '') { $vwploar5s['ReasonStopped'] = "End Date Passed.\nAutoEnded by Memberium"; } $vwploar5s['EndDate'] = date('Ymd\Th:i:s'); $vwploar5s['Status'] = 'Inactive'; $this->isdk->dsUpdate('RecurringOrder', (int) $vwplheakg['Id'], $vwploar5s); } } } $vwplho_n++; } while (count($vwply4j8x) == $vwplanieul); unset($vwply4j8x, $vwplheakg); return $vwplyoqc; }  function wplwqy2z($vwplg6lz4) { $vwplr23fm = strtolower(substr($vwplg6lz4['bypass_commissions'], 0, 1) ); $vwplr23fm = ($vwplr23fm == 'y' || $vwplr23fm == 1) ? TRUE : FALSE; $vwplr23fm = (bool) $vwplg6lz4['bypass_commissions']; $vwplf_a9g = strtolower(substr($vwplg6lz4['delete_failed'], 0, 1) ); $vwplf_a9g = ($vwplf_a9g == 'y' || $vwplf_a9g == 1) ? TRUE : FALSE; $vwplqi9hx = (int) $vwplg6lz4['product_type']; $vwplqi9hx = ($vwplg6lz4['product_type'] > 0 && $vwplg6lz4['product_type'] < 15) ? $vwplg6lz4['product_type'] : 4; $vwplec_2x = (bool) $vwplg6lz4['autorun']; $vwpln2bu = (int) $vwplg6lz4['creditcard_id']; $vwplf_a9g = (bool) $vwplg6lz4['delete_failed']; $vwplqi9hx = (int) $vwplg6lz4['item_type']; $vwplouh_ = (int) $vwplg6lz4['lead_affiliate_id']; $vwplhg9w3d = (int) $vwplg6lz4['merchant_id']; $vwplnv2y1m = (int) $vwplg6lz4['product_id']; $vwplcygwx6 = trim($vwplg6lz4['product_description']); $vwplcc9s1g = (float) $vwplg6lz4['product_price']; $vwplcqo4 = (int) $vwplg6lz4['quantity']; $vwplq9rame = (int) $vwplg6lz4['sales_affiliate_id']; $vwplkyevs = (int) $vwplg6lz4['has_payment_plan']; $vwplpkx1rz = $vwplg6lz4['order_date']; $vwpll7blz = (bool) $vwplg6lz4['taxable']; $vwplg541 = trim($vwplg6lz4['success_action']); $vwplh4lzmh = trim($vwplg6lz4['success_goals']); $vwplrbw6a = trim($vwplg6lz4['success_tags']); $vwplkv39 = trim($vwplg6lz4['fail_action']); $vwplv7i3oh = trim($vwplg6lz4['fail_goals']); $vwplnjfnaw = trim($vwplg6lz4['fail_tags']); if ($vwplkyevs) { $vwplpg1q = (bool) $vwplg6lz4['payplan_autocharge']; $vwpljulo = (int) $vwplg6lz4['payplan_max_retries']; $vwplhc_p = (int) $vwplg6lz4['payplan_retry_days']; $vwplxh_lv = (float) $vwplg6lz4['payplan_initial_amount']; $vwplam_8 = (int) $vwplg6lz4['payplan_payment_count']; $vwplj8n92v = (int) $vwplg6lz4['payplan_days_between']; }  $vwplpkx1rz = date('Y-m-d\TH:i:s'); $vwplvrne94 = $this->isdk->blankOrder($vwplvtmqd, $vwplcygwx6, $vwplpkx1rz, $vwplouh_, $vwplq9rame); $this->isdk->addOrderItem($vwplvrne94, $vwplnv2y1m, $vwplqi9hx, $vwplcc9s1g, $vwplcqo4, $product_name, $vwplcygwx6); if ($vwplkyevs) { $vwplk9axk = $app->infuDate("10-11-2008"); $vwplpq_r = $app->infuDate("10-25-2008"); $vwplyio4f = $app->payPlan($vwplvrne94, $vwplpg1q, $vwpln2bu, $vwplhg9w3d, $vwplhc_p, $vwpljulo, $vwplxh_lv, $payplan_initial_date, $payplan_startdate, $vwplam_8, $vwplj8n92v); } if ($vwpll7blz) { $ret = $this->isdk->recalculateTax($vwplvrne94); } $vwplyio4f = $this->isdk->chargeInvoice($vwplvrne94, 'Memberium API Order', $vwpln2bu, $vwplhg9w3d, FALSE); if (in_array(strtolower($vwplyio4f['Code']), array('approved', 'skipped') ) ) {  $vwplyio4f = $vwplvrne94; if ($success_action > '') { $this->wplmupt($vwplg541, $vwplvtmqd); } if ($success_goals > '') { $this->wplge1yc6($vwplh4lzmh, $vwplvtmqd); } if ($success_tags > '') { $this->wplt263_($vwplrbw6a, $vwplvtmqd); } } else { if ($vwplf_a9g && $vwplvrne94 > 0) { $this->isdk->deleteInvoice($vwplvrne94); }  if ($vwplkv39 > '') { $this->wplmupt($fail_action, $vwplvtmqd); } if ($vwplv7i3oh > '') { $this->wplge1yc6($fail_goals, $vwplvtmqd); } if ($vwplnjfnaw > '') { $this->wplt263_($fail_tags, $vwplvtmqd); } $vwplyio4f = false; } $this->wplj9ye($vwplvtmqd); } function wplh543d2($vwplvzgui = false) { if (empty($vwplvzgui) ) { return false; }  $vwplvzgui = (int) $vwplvzgui; $vwplv80sz = array('OriginatingOrderId' => $vwplvzgui); $vwplmu62n = array('Id'); $vwplurqb3 = $this->isdk->dsQuery('RecurringOrder', 998, 0, $vwplv80sz, $vwplmu62n);  if (is_array($vwplurqb3) ) { foreach($vwplurqb3 as $vwplm_r03) { if (! empty($vwplm_r03['Id']) ) { $vwplyio4f = $app->dsDelete('RecurringOrder', (int) $vwplm_r03['Id']); } } } } function wplbg4u1($vwplelob86) { $vwpltalx = false; $vwplg_xkl = (int) $vwplelob86['affiliate_id']; $vwplvtmqd = (int) $vwplelob86['contact_id']; $vwpln2bu = (int) $vwplelob86['creditcard_id']; $vwplj_c70 = (boolean) $vwplelob86['delete_failures']; $vwplhg9w3d = (int) $vwplelob86['merchant_id']; $vwplpqxz = (int) $vwplelob86['plan_id']; $vwplo60kf = (double) $vwplelob86['price']; $vwplcqo4 = (int) $vwplelob86['quantity']; $vwpll7blz = (boolean) $vwplelob86['taxable']; $vwplucm2rl = (int) $vwplelob86['trial_days']; if ($vwplvtmqd < 1 || $vwplpqxz < 1 || $vwplcqo4 < 1 || $vwplhg9w3d < 1 || $vwpln2bu < 1 || $vwplo60kf < 0 || $vwply475p_ < 0 || $vwpllmf0o < 0) { $vwplt9si2 = false; } else { $vwplt9si2 = true; } if ($vwplt9si2) { $vwplkc7_ = (int) $this->isdk->addRecurringAdv($vwplvtmqd, $vwplpqxz, $vwplcqo4, $vwplo60kf, $vwpll7blz, $vwplhg9w3d, $vwpln2bu, $vwplg_xkl, $vwplucm2rl); if ($vwplkc7_ > 0) { if ($vwplucm2rl == 0) { $vwplvrne94 = $this->isdk->recurringInvoice($vwplkc7_); $vwplyio4f = $this->isdk->chargeInvoice($vwplvrne94, 'Memberium Subscription Payment', $vwpln2bu, $vwplhg9w3d, false); if (in_array(strtolower($vwplyio4f['Code']), array('approved', 'skipped') ) ) { $vwpltalx = true; } else { if ($vwplj_c70) { $this->isdk->deleteSubscription($vwplkc7_); } } } else { $vwpltalx = true; } } } else { } if (! $vwpltalx) { return false; } else { return $vwplkc7_; } }     function wplwuo3z8($vwpleh9l = '', $vwpllzly5b = false, $vwplwwytci = false) { if (! $this->license_status) { return; } if (! is_array($vwpleh9l) ) { $vwpleh9l = explode(',', trim($vwpleh9l) ); } $vwpleh9l = array_filter(array_map('strtolower', $vwpleh9l) ); if (empty($vwpleh9l) ) { return; } if (! $vwpllzly5b) { $vwpllzly5b = get_current_user_id(); } if ($vwpllzly5b < 1) { return; } $vwpl_vbqi4 = get_user_meta($vwpllzly5b, 'memberium_tokens', true); if (! $vwpl_vbqi4) { $vwpl_vbqi4 = array(); } $vwpl_vbqi4 = array_filter(array_map('strtolower', $vwpl_vbqi4) ); foreach ($vwpleh9l as $vwpli70d) { if (substr($vwpli70d, 0, 1) === '-') { $vwpli70d = substr($vwpli70d, 1); $vwply17edn = array_search($vwpli70d, $vwpl_vbqi4); unset($vwpl_vbqi4[$vwply17edn]); do_action('memb_remove_token', $vwpllzly5b, $vwpli70d); } else { $vwpl_vbqi4[] = $vwpli70d; do_action('memb_add_token', $vwpllzly5b, $vwpli70d); } } $vwpl_vbqi4 = array_unique($vwpl_vbqi4); update_user_meta($vwpllzly5b, 'memberium_tokens', $vwpl_vbqi4); } function wplcw8ap($vwpleh9l, $vwpllzly5b = false) { if (current_user_can('manage_options') ) { return true; }  if (! $this->license_status) { return false; } if (! $vwpllzly5b) { $vwpllzly5b = get_current_user_id(); } if ($vwpllzly5b < 1) { return; } $vwpleh9l = array_filter(array_map('strtolower', explode(',', trim($vwpleh9l) ) ) ); $vwpl_vbqi4 = get_user_meta($vwpllzly5b, 'memberium_tokens', true); if (! $vwpl_vbqi4) { $vwpl_vbqi4 = array(); } $vwpl_vbqi4 = array_filter(array_map('strtolower', $vwpl_vbqi4) ); if (count(array_intersect($vwpleh9l, $vwpl_vbqi4) ) ) { return true; } return false; }    function wplstw20($vwpljy5dw3, $vwplk_sn = 0, $vwplwi6t5n = '') { $vwpljy5dw3 = trim($vwpljy5dw3); if ($vwpljy5dw3 == '') { return FALSE; } $vwplcjoexv = array( 'GroupDescription' => $vwplwi6t5n, 'GroupCategoryId' => $vwplk_sn, 'GroupName' => $vwpljy5dw3 ); $vwplqxosl = $this->isdk->dsAdd('ContactGroup', $vwplcjoexv); if ($vwplqxosl > 0) {  global $wpdb; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplx1ap5_ = 'INSERT INTO `' . MEMBERIUM_DB_TAGS . '` (`id`, `appname`, `name`, `category`) VALUES (%d, %s, %s, %s);'; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplqxosl, $vwplw5rgd3, $vwpljy5dw3, $vwplk_sn); $wpdb->query($vwplx1ap5_); return $vwplqxosl; } return FALSE; } function wplbonu7($vwplus94 = false) { global $wpdb;  $vwplx1ap5_ = 'SELECT `name`, `id` FROM `' . MEMBERIUM_DB_TAGS . '` WHERE `appname` = %s ORDER BY `name`;'; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, wplz8bid::wplm3z9k('appname') ); $vwpls0hwb5 = $wpdb->get_results($vwplx1ap5_, ARRAY_N); $vwplmy5mc = array(); if (is_array($vwpls0hwb5) ) { foreach($vwpls0hwb5 as $vwpltmveju) { $vwplmy5mc[] = trim($vwpltmveju[0]) . ' (' . $vwpltmveju[1] . ')'; if ($vwplus94) { $vwplmy5mc[] = '-' . trim($vwpltmveju[0]) . ' (' . $vwpltmveju[1] . ')'; } } } return $vwplmy5mc; } function wpljfe4jd($vwpljy5dw3) { $vwpljy5dw3 = trim($vwpljy5dw3); if ( (int) $vwpljy5dw3 > 0) { return $vwpljy5dw3; } if ($vwpljy5dw3 == '') { return false; } global $wpdb;  $vwplx1ap5_ = 'SELECT `id` FROM `' . MEMBERIUM_DB_TAGS . '` WHERE `id` > 0 AND `appname` = %s AND `name` = %s ORDER BY `id` LIMIT 1;'; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, wplz8bid::wplm3z9k('appname'), $vwpljy5dw3); $vwplqxosl = (int) $wpdb->get_var($vwplx1ap5_); if ($vwplqxosl > 0) { return $vwplqxosl; } else { return false; } }  function wpl_q6ra($vwplmkypa, $vwplnpwi5){ $vwplnkj9d_ = $this->options; $vwplgxrbm = isset($vwplnkj9d_['memberships']) && is_array($vwplnkj9d_['memberships']) ? $vwplnkj9d_['memberships'] : array(); return $vwplgxrbm; }  function wplxc94($vwplmkypa, $vwplnpwi5){ $vwplu9w10 = array(); $vwpls0hwb5 = wplj_l2t::wplaajf(true, true); $vwpls0hwb5 = (isset($vwpls0hwb5['hn']) ) ? $vwpls0hwb5['hn'] : false; if ($vwpls0hwb5){ foreach ($vwpls0hwb5 as $vwplopnf => $vwpltmveju) { $vwplu9w10[$vwplopnf] = $vwpltmveju . ' (' . str_replace('-', '', $vwplopnf) . ')'; } } return $vwplu9w10; }  static function wplaajf($vwplxej35 = false, $vwplri1h = false) { global $wpdb; static $vwplbl1pma; $vwplq_baoi = (int) $vwplxej35; $vwplnkj9d_ = wplz8bid::wplvf1d('settings'); if (! isset($vwplbl1pma[$vwplq_baoi]) ) {  $vwple_k7yr = ''; if ($vwplxej35 == true && $vwplnkj9d_['ignore_tag_categories'] > '') { $vwple_k7yr = ' AND category NOT IN (' . $vwplnkj9d_['ignore_tag_categories'] . ') '; } $vwplze93 = array(); $vwpla54ov0 = MEMBERIUM_DB_TAGS; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplx1ap5_ = "SELECT id, name FROM {$vwpla54ov0} WHERE `appname` = '{$vwplw5rgd3}' {$vwple_k7yr} ORDER BY category, name "; $vwpls0hwb5 = $wpdb->get_results($vwplx1ap5_, ARRAY_A); foreach ($vwpls0hwb5 as $vwpltmveju) { $vwplze93['mc'][$vwpltmveju['id']] = $vwpltmveju['name']; $vwplze93['lc'][$vwpltmveju['id']] = strtolower($vwpltmveju['name']); } $vwplyio4f = $vwplze93; $vwplbl1pma[$vwplq_baoi] = $vwplyio4f; } else { $vwplyio4f = $vwplbl1pma[$vwplq_baoi]; }  if ($vwplri1h) { if (! empty($vwplyio4f['mc']) && is_array($vwplyio4f['mc']) ){ $vwplyio4f['hn'] = array(); $vwplyqj4 = __('Does Not Have', 'memberium'); foreach ($vwplyio4f['mc'] as $vwplopnf => $vwpltmveju) { $vwplyio4f['hn'][$vwplopnf] = $vwpltmveju; $vwplyio4f['hn'][ '-' . $vwplopnf] = $vwplyqj4 . ' ' . $vwpltmveju; } } } return $vwplyio4f; }  function wpl_4nhxw($vwpls0hwb5) { global $wpdb;  if (is_array($vwpls0hwb5) ) { $vwpls0hwb5 = implode(',', $vwpls0hwb5); } $vwpls0hwb5 = trim($vwpls0hwb5, ','); if (trim($vwpls0hwb5) == '') { return; } $vwplx1ap5_ = "SELECT `name` FROM `". MEMBERIUM_DB_TAGS . "` WHERE `id` in ({$vwpls0hwb5}) ORDER BY `name` ASC;"; $vwply4j8x = $wpdb->get_results($vwplx1ap5_, ARRAY_A); foreach ($vwply4j8x as $vwplheakg) { $vwplpr27[] = $vwplheakg['name']; } if (count($vwplpr27) > 0) { $vwpld4rum = implode(', ', $vwplpr27); } return $vwpld4rum; } function wpljd8cu($vwplso5idp) { if (! is_array($vwplso5idp) ) { $vwpls0hwb5 = preg_replace(array('/, */', '/ *,/'), ',', trim($vwplso5idp) ); $vwpls0hwb5 = explode(',', $vwpls0hwb5); } else { if (is_array($vwplso5idp) ) { $vwpls0hwb5 = $vwplso5idp; } else { return FALSE; } } global $wpdb; static $vwplpr27 = array(); if (count($vwplpr27) == 0) { $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplx1ap5_ = "SELECT name, id FROM `" . MEMBERIUM_DB_TAGS . "` WHERE `appname` = '{$vwplw5rgd3}' "; $vwplib1rf = $wpdb->get_results($vwplx1ap5_, ARRAY_A); foreach ($vwplib1rf as $vwpltmveju) { $vwplioic84 = strtolower($vwpltmveju['name']); $vwplpr27[$vwplioic84] = $vwpltmveju['id']; } } $vwpltohq4 = array(); foreach ($vwpls0hwb5 as $vwpltmveju) { if (is_numeric($vwpltmveju) ) { $vwpltohq4[] = $vwpltmveju; } else { if (substr($vwpltmveju, 0, 1) == '-') { $vwplioic84 = strtolower(substr($vwpltmveju, 1) ); $vwplyct0 = '-'; } else { $vwplioic84 = strtolower($vwpltmveju); $vwplyct0 = ''; } if (isset($vwplpr27[$vwplioic84]) ) { $vwpltohq4[] = intval($vwplyct0 . $vwplpr27[$vwplioic84]); } } } return $vwpltohq4; } function wplaw3p() { $vwplktq3k = get_option('memberium_tables_updated', array() ); $vwplktq3k['tagcategories'] = isset($vwplktq3k['tagcategories']) ? $vwplktq3k['tagcategories'] : 0; global $wpdb; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplzicr5 = ''; $vwplanieul = 999; $vwplho_n = 0; $vwplv80sz = array('CategoryName' => '%'); $vwplc0g3p = array('Id', 'CategoryName'); $vwple7lbh = 0; $vwplnzlj0t = 'ContactGroupCategory'; $vwpla54ov0 = MEMBERIUM_DB_CONTACTGROUPCATEGORIES; $vwply4j8x = $this->isdk->dsQueryOrderBy($vwplnzlj0t, $vwplanieul, $vwplho_n, $vwplv80sz, $vwplc0g3p, 'Id', TRUE); if (is_array($vwply4j8x) && ! empty($vwply4j8x) ) { $vwpljz9txv = array(); if (is_array($vwply4j8x) && ! empty($vwply4j8x) ) { foreach ($vwply4j8x as $vwplheakg) { $vwpljz9txv[] = $wpdb->prepare("(%d, %s, %s)", intval($vwplheakg['Id']), $vwplw5rgd3, $vwplheakg['CategoryName']); $vwplzicr5 .= $vwplheakg['Id'] . ','; } } $vwplx1ap5_ = "INSERT INTO {$vwpla54ov0} (id, appname, name) VALUES " . implode(', ', $vwpljz9txv) . " ON DUPLICATE KEY UPDATE id=VALUES(id), appname=VALUES(appname), name=VALUES(name);"; $wpdb->query($vwplx1ap5_); if (! empty($vwplzicr5) ) { $vwplzicr5 = trim($vwplzicr5, ','); $vwplx1ap5_ = "DELETE FROM {$vwpla54ov0} WHERE `appname` = %s AND `id` NOT IN ({$vwplzicr5}) "; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplw5rgd3); $wpdb->query($vwplx1ap5_); } set_transient('memberium_tagcategories_updated', time() ); } $vwplktq3k['tagcategories'] = time(); update_option('memberium_tables_updated', $vwplktq3k, false); return $vwple7lbh; }  function wplad_mvo($vwplvtmqd, $vwpls0hwb5) { global $wpdb; $vwplvtmqd = (int) $vwplvtmqd; if (is_int($vwpls0hwb5) || is_string($vwpls0hwb5) ) { $vwpls0hwb5 = explode(',', $vwpls0hwb5); }  foreach ($vwpls0hwb5 as $vwpltmveju) { if ( (int) $vwpltmveju > 0) { $this->i2sdk->isdk->grpAssign($vwplvtmqd, (int) $vwpltmveju); $this->wpln6xe($vwplvtmqd); } else { $this->i2sdk->isdk->grpRemove($vwplvtmqd, (int) abs($vwpltmveju) ); $this->wpln6xe($vwplvtmqd); } } if (isset($_SESSION['memb_user']['Id']) && $_SESSION['memb_user']['Id'] == $vwplvtmqd) { $vwpllpv3k = explode(',', $_SESSION['memb_user']['Groups']); foreach ($vwpls0hwb5 as $vwpltmveju) { if ($vwpltmveju > 0) { $vwpllpv3k[] = $vwpltmveju; } else { $vwpltmveju = (int) abs($vwpltmveju); unset($vwpllpv3k[$vwpltmveju]); } } $_SESSION['memb_user']['Groups'] = implode(',', $vwpllpv3k); $wpdb->query("REPLACE INTO `" . MEMBERIUM_DB_CONTACTS ."` SET `value`='' WHERE `id` = {$vwplvtmqd} AND `appname` = `{$this->i2sdk_options['app_name']}` "); $this->wpln6xe($vwplvtmqd); $this->disable_login_redirect = TRUE; if (wplsbzgvp::wplfhxj9() == $vwplvtmqd) { $_SESSION = $this->wplyte2(); } else { $this->wplyte2(); } } }   function wplpg5eox($vwplopnf = false, $vwplq3wd4o = false) { $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplsekv = "Memberium_{$vwplw5rgd3}_Product"; $vwplvwi2o = get_transient($vwplsekv); if (empty($vwplvwi2o) || ! is_array($vwplvwi2o) ) { wpllbej::wplctzj(); $vwplvwi2o = get_transient($vwplsekv); } else { } if ($vwplq3wd4o && $vwplopnf > 0 && isset($vwplvwi2o[$vwplopnf]) && is_array($vwplvwi2o[$vwplopnf]) ) { $vwplvwi2o = wplj_l2t::wplr7fh($vwplvwi2o); } if ($vwplopnf) { $vwplvwi2o = isset($vwplvwi2o[$vwplopnf]) ? $vwplvwi2o[$vwplopnf] : array(); } return $vwplvwi2o; }    function wpla41nh2($vwplvbw_6i) { $vwplvbw_6i = (int) $vwplvbw_6i; $vwpli16d9_ = 'memberium::email_template::' . $vwplvbw_6i;  $vwplzxhjbg = get_transient($vwpli16d9_); if ($vwplzxhjbg === false) { $vwplzxhjbg = $this->isdk->getEmailTemplate($vwplvbw_6i); if (is_array($vwplzxhjbg) ) { set_transient($vwpli16d9_, $vwplzxhjbg, DAY_IN_SECONDS); } else { $vwplzxhjbg = false; } } return $vwplzxhjbg; } function wplgc73p($vwplzxhjbg) { }      function wplatalz() { } function wplnrutgy($vwplvtmqd, $vwplq3wd4o = false) { $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplsekv = 'Memberium::Filebox::' . $vwplw5rgd3 . '::' . $vwplvtmqd; $vwplyca8 = get_transient($vwplsekv); if (empty($vwplyca8) || ! is_array($vwplyca8) ) { $vwplyca8 = wpllbej::wplqf18n($vwplvtmqd); } if ($vwplq3wd4o) { $vwplyca8 = wplj_l2t::wplr7fh($vwplyca8); } return $vwplyca8; }    function wplovpy($vwplvtmqd, $vwpls0hwb5 = '', $vwplewhxt_ = '', $vwplyf615d = '', $vwplw5rgd3 = false, $vwplhw6dxa = false, $vwplwwytci = false) { if (! empty($vwplyf615d) ) { $this->wplge1yc6($vwplyf615d, $vwplvtmqd, $vwplw5rgd3); } if (! empty($vwplewhxt_) ) { $this->wplmupt($vwplewhxt_, $vwplvtmqd); } if (! empty($vwpls0hwb5) ) { $this->wplt263_($vwpls0hwb5, $vwplvtmqd, $vwplhw6dxa, $vwplwwytci); } } function wplefk9c5($vwplvtmqd = 0, $vwplz1bp7) { $vwplsb_pf = array( 'actionsets' => '', 'api_goals' => '', 'tags' => '', 'full_update' => false, 'debug' => false, 'appname' => false, ); $vwplz1bp7 = wp_parse_args($vwplz1bp7, $vwplsb_pf); do_action('memberium/do_actions_before', $vwplvtmqd, $vwplz1bp7); if ($vwplvtmqd) { if (! empty($vwplz1bp7['tags']) ) { $this->wplt263_($vwplz1bp7['tags'], $vwplvtmqd, $vwplhw6dxa, $vwplwwytci); } if (! empty($vwplz1bp7['actionsets']) ) { $this->wplmupt($vwplz1bp7['actionsets'], $vwplvtmqd); } if (! empty($vwplz1bp7['api_goals']) ) { $this->wplge1yc6($vwplz1bp7['api_goals'], $vwplvtmqd, $vwplw5rgd3); } } do_action('memberium/do_actions_after', $vwplvtmqd, $vwplz1bp7); } function wpletmsz() { global $wpdb;  $vwplx1ap5_ = 'SELECT `id`, `name` FROM `' . MEMBERIUM_DB_ACTIONSETS . '` WHERE `appname` = %s ORDER BY `name`;'; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, wplz8bid::wplm3z9k('appname') ); $vwplewhxt_ = $wpdb->get_results($vwplx1ap5_, ARRAY_A); $vwpli1ik9 = array(); foreach($vwplewhxt_ as &$vwplvobnm0) { $vwpli1ik9[$vwplvobnm0['id']] = $vwplvobnm0['name']; unset($vwplvobnm0); } return $vwpli1ik9; } function wplgfugwo() { $vwplktq3k = get_option('memberium_tables_updated', array() ); $vwplktq3k['actionsets'] = isset($vwplktq3k['actionsets']) ? $vwplktq3k['actionsets'] : 0; global $wpdb; $vwplnzlj0t = 'ActionSequence'; $vwplanieul = 999; $vwplho_n = 0; $vwplnzrsa = 'Id'; $vwpltsj75x = '%'; $vwplv80sz = array('Id' => '%'); $vwplc0g3p = array('Id', 'TemplateName', 'VisibleToTheseUsers'); $vwpla54ov0 = MEMBERIUM_DB_ACTIONSETS; $vwple7lbh = 0; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname');  do { $vwply4j8x = $this->isdk->dsQuery($vwplnzlj0t, $vwplanieul, $vwplho_n, $vwplv80sz, $vwplc0g3p, 'Id', true); $vwplblb1m = count($vwply4j8x); if (is_array($vwply4j8x) ) { $vwply6knx = (int) $vwply4j8x[0]['Id']; $vwpllypwk = (int) $vwply4j8x[(count($vwply4j8x) - 1)]['Id']; $vwpljz9txv = array(); $vwplqzdlu3 = array(); foreach ($vwply4j8x as $k => $vwplheakg) { $vwplheakg['VisibleToTheseUsers'] = empty($vwplheakg['VisibleToTheseUsers']) ? '' : $vwplheakg['VisibleToTheseUsers']; if ( ($vwplheakg['VisibleToTheseUsers'] == '-1') || empty($vwplheakg['TemplateName']) ) { unset($vwply4j8x[$k]); } else {  foreach ($vwplc0g3p as $vwply17edn) { if (empty($vwplheakg[$vwply17edn]) ) $vwplheakg[$vwply17edn] = ''; } if (empty($vwplheakg['TemplateName']) ) { $vwplheakg['TemplateName'] = 'Unnamed Action Set #' . $vwplheakg['Id']; } $vwpljz9txv[] = $wpdb->prepare("(%d, %s, %s)", intval($vwplheakg['Id']), $vwplw5rgd3, $vwplheakg['TemplateName']); $vwplqzdlu3[] = $vwplheakg['Id']; } } $vwplx1ap5_ = "INSERT INTO {$vwpla54ov0} (id, appname, name) VALUES " . implode(', ', $vwpljz9txv) . " ON DUPLICATE KEY UPDATE id=VALUES(id), appname=VALUES(appname), name=VALUES(name);"; $wpdb->query($vwplx1ap5_); if ($vwply6knx && $vwpllypwk && is_array($vwplqzdlu3) && count($vwplqzdlu3) ) { $vwplx1ap5_ = "DELETE FROM {$vwpla54ov0} WHERE `appname` = %s AND `id` > %d AND `id` < %d AND `id` NOT IN (" . implode(',', $vwplqzdlu3) . ");"; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplw5rgd3, $vwply6knx, $vwpllypwk); $wpdb->query($vwplx1ap5_); } } $vwplho_n++; $vwple7lbh = $vwple7lbh + $vwplblb1m; usleep(500000); } while ($vwplblb1m == $vwplanieul); $vwplx1ap5_ = "DELETE FROM {$vwpla54ov0} WHERE `appname` = %s AND `id` > %d"; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplw5rgd3, $vwpllypwk); $wpdb->query($vwplx1ap5_); set_transient('memberium_actionsets_updated', time() ); $vwplktq3k['actionsets'] = time(); update_option('memberium_tables_updated', $vwplktq3k, false); return $vwple7lbh; } function wplge1yc6($vwplyf615d = '', $vwplvtmqd = false, $vwplw5rgd3 = false) { if (empty($vwplyf615d) ) { return; } if (! $this->license_status) { return; } if (! $vwplvtmqd) { $vwplvtmqd = wplsbzgvp::wplfhxj9(); } $vwplvtmqd = (int) $vwplvtmqd; if ($vwplvtmqd < 1) { return; } if (! $vwplw5rgd3) { $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); } if (! is_array($vwplyf615d) ) { $vwplyf615d = array_filter(explode(',', $vwplyf615d) ); } $this->wplklnfb(); $vwplcmgi = false; foreach ($vwplyf615d as $vwplhlbt) { if ($vwplhlbt > '') { $vwplyio4f = $this->isdk->achieveGoal($vwplw5rgd3, $vwplhlbt, $vwplvtmqd); $vwplcmgi = (boolean) ($vwplyio4f[0]['success'] == 1); } } if ($vwplcmgi) { $this->wpln6xe($vwplvtmqd); } } function wplz3_a($vwplmuc1x, $vwplvtmqd = false) { if (! $this->license_status) { return; } if (! $vwplvtmqd) { $vwplvtmqd = wplsbzgvp::wplfhxj9(); } $vwplvtmqd = (int) $vwplvtmqd; if ($vwplvtmqd < 1) { return; } if (! is_array($vwplmuc1x) ) { $vwplmuc1x = array_filter(explode(',', $vwplmuc1x) ); } foreach ($vwplmuc1x as $fus_id) { if ($fus_id > 0) { $this->isdk->campAssign($vwplvtmqd, $fus_id); } } } function wpli5nd($fus_ids, $vwplvtmqd = false) { if (! $this->license_status) { return; } if (! $vwplvtmqd) { $vwplvtmqd = wplsbzgvp::wplfhxj9(); } $vwplvtmqd = (int) $vwplvtmqd; if ($vwplvtmqd < 1) { return; } if (! is_array($vwplmuc1x) ) { $vwplmuc1x = array_filter(explode(',', $vwplmuc1x) ); } foreach ($vwplmuc1x as $vwplglv57) { if ($vwplglv57 > 0) { $this->isdk->campPause($vwplvtmqd, $vwplglv57); } } } function wplmupt($vwplewhxt_, $vwplvtmqd = false) { if (empty($vwplewhxt_) ) { return; } if (! $this->license_status) { return; } if (! $vwplvtmqd) { $vwplvtmqd = wplsbzgvp::wplfhxj9(); } $vwplvtmqd = (int) $vwplvtmqd; if ($vwplvtmqd < 1) { return; } if (! is_array($vwplewhxt_) ) { $vwplewhxt_ = array_filter(explode(',', $vwplewhxt_) ); }   $this->wplklnfb(); $vwplcmgi = false; foreach ($vwplewhxt_ as $vwpleklnhm) { $vwpleklnhm = (int) $vwpleklnhm; if ($vwpleklnhm > 0) { $vwplyg7o = $this->isdk->runAS($vwplvtmqd, $vwpleklnhm); if (is_array($vwplyg7o) ) { foreach ($vwplyg7o as $vwplyio4f) { if (strtolower($vwplyio4f['Message']) <> 'nothing to do') { $vwplcmgi = true; } } unset($vwplyio4f); } } }  if ($vwplcmgi) { $this->wplj9ye($this->wpldti9() ); $this->wpln6xe($this->wpldti9() ); if (wplsbzgvp::wplfhxj9() == $vwplvtmqd) { $_SESSION = $this->wplyte2(); } else { $this->wplyte2(); } } return $vwplyg7o; } function wplkm9bv($vwplmuc1x, $vwplvtmqd = false) { if (! $this->license_status) { return; } if (! $vwplvtmqd) { $vwplvtmqd = wplsbzgvp::wplfhxj9(); } $vwplvtmqd = (int) $vwplvtmqd; if ($vwplvtmqd < 1) { return; } if (! is_array($vwplmuc1x) ) { $vwplmuc1x = array_filter(explode(',', $vwplmuc1x) ); } foreach ($vwplmuc1x as $vwplglv57) { if ($vwplglv57 > 0) { $this->isdk->campRemove($vwplvtmqd, $vwplglv57); } } } function wplt263_($vwpls0hwb5 = '', $vwplvtmqd = false, $vwplhw6dxa = false, $vwplwwytci = false) { if (empty($vwpls0hwb5) ) { return; } if (! $this->license_status) { return; } if (! $vwplvtmqd) { $vwplvtmqd = wplsbzgvp::wplfhxj9(); } if ($vwplvtmqd < 1) { return; } if (! is_array($vwpls0hwb5) ) { $vwpls0hwb5 = explode(',', $vwpls0hwb5); } $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwpls0hwb5 = array_unique($this->wpljd8cu($vwpls0hwb5) ); $vwplcmgi = false; $vwplrudn1 = array(); $vwplcqlhk = ($vwplvtmqd == wplsbzgvp::wplfhxj9() ); global $wpdb; $this->wplklnfb();  if ($vwplcqlhk && (wplsbzgvp::wplc4na('groups') > '') ) { $vwplrudn1 = array_flip(array_filter(explode(',', wplsbzgvp::wplc4na('groups') ) ) ); } else { $vwplrp9u24 = wpllbej::wplrande($vwplvtmqd, true); $vwplrudn1 = array_flip(array_filter(explode(',', $vwplrp9u24['groups']) ) ); } foreach ($vwpls0hwb5 as $vwpltmveju) { $vwpltmveju = (int) $vwpltmveju; if ($vwpltmveju < 0) { $vwplqxosl = abs($vwpltmveju); $vwplyio4f = $this->isdk->grpRemove($vwplvtmqd, $vwplqxosl); if ($vwplyio4f) { $vwplcmgi = true; unset($vwplrudn1[$vwplqxosl]); } if ($this->options['settings']['sync_tag_details'] == 1) { $vwplx1ap5_ = 'DELETE FROM `' . MEMBERIUM_DB_CONTACTTAGS . '` WHERE `contactid` = %d AND `tagid` = %d AND `appname` = %s ;'; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplvtmqd, abs($vwpltmveju), $vwplw5rgd3); $wpdb->query($vwplx1ap5_); }; do_action('memb_remove_tag', $vwplvtmqd, abs($vwpltmveju) ); } elseif ($vwpltmveju > 0) { $vwplyio4f = $this->isdk->grpAssign($vwplvtmqd, $vwpltmveju); if ($vwplyio4f) { $vwplrudn1[ $vwpltmveju ] = ! empty($vwplrudn1) ? max($vwplrudn1) + 1 : 1; $vwplcmgi = true; } if ($this->options['settings']['sync_tag_details'] == 1) { $vwplx1ap5_ = 'INSERT IGNORE INTO `' . MEMBERIUM_DB_CONTACTTAGS . '` (`appname`, `contactid`, `tagid`) VALUES (%s, %d, %d);'; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplw5rgd3, $vwplvtmqd, abs($vwpltmveju) ); $wpdb->query($vwplx1ap5_); }; do_action('memb_add_tag', $vwplvtmqd, $vwpltmveju); } } $vwplrudn1 = array_flip($vwplrudn1); sort($vwplrudn1); $vwplrudn1 = implode(',', $vwplrudn1);  $vwplx1ap5_ = 'UPDATE `' . MEMBERIUM_DB_CONTACTS . '` SET `value` = %s WHERE `id` = %d AND `appname` = %s AND `fieldname` = "Groups";'; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplrudn1, $vwplvtmqd, $vwplw5rgd3); $wpdb->query($vwplx1ap5_); $this->wpln6xe($vwplvtmqd); if ($vwplcqlhk) { $_SESSION = $this->wplyte2(); } else { $this->wplyte2(); }  }     function wplgtes() { $vwplc69y = $this->wplks1ypq(); foreach ($vwplc69y as $vwplu1i6) { $vwplvtmqd = 0; if (! empty($vwplu1i6['data']['contact_id']) ) { $vwplvtmqd = (int) $vwplu1i6['data']['contact_id']; } else { $vwplopnf = (int) $vwplu1i6['data']['recurringorder_id']; if ($vwplopnf > 0) { $vwplmu62n = array('ContactId'); $vwplheakg = $this->isdk->dsLoad('RecurringOrder', $vwplopnf, $vwplmu62n); if (is_array($vwplheakg) ) { $vwplvtmqd = (int) $vwplheakg['ContactId']; } } } if ($vwplvtmqd > 0) { if ($vwplu1i6['actiontype'] == 'achievegoal') { $vwplhlbt = $vwplu1i6['data']['end_goal']; $this->isdk->achievegoal($vwplu1i6['appname'], $vwplhlbt, $vwplvtmqd); $this->wplwnax43($vwplu1i6); } elseif ($vwplu1i6['actiontype'] == 'actionset') { $vwpleklnhm = (int) $vwplu1i6['data']['end_action']; $this->isdk->runAs($vwplvtmqd, $vwpleklnhm); $this->wplwnax43($vwplu1i6); } elseif ($vwplu1i6['actiontype'] == 'settags') { } elseif ($vwplu1i6['actiontype'] == 'sendemail') { } } } } function wplbehq($vwplxwmli, $vwploq8a, $vwplz4g7n) { global $wpdb; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname'); $vwplxwmli = strtolower(trim($vwplxwmli) ); $vwplgjp7v = strtotime($vwploq8a); $vwplx1ap5_ = 'INSERT INTO `' . MEMBERIUM_DB_QUEUE . '` (`pidlock`, `appname`, `actiontype`, `scheduled`, `data`) VALUES (-1, %s, %s, %s, %s);'; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplw5rgd3, $vwplxwmli, $vwploq8a, json_encode($vwplz4g7n) ); $wpdb->query($vwplx1ap5_); $vwplopnf = $wpdb->insert_id; return $vwplopnf; } function wplks1ypq() { global $wpdb; $vwplw5rgd3 = wplz8bid::wplm3z9k('appname');  $vwplcm9i8y = $_SERVER['REMOTE_PORT']; $vwplx1ap5_ = 'UPDATE `' . MEMBERIUM_DB_QUEUE . '` SET `pidlock` = %d WHERE `appname`= %s AND `scheduled` <= NOW() AND `pidlock` < 1 ;'; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplcm9i8y, $vwplw5rgd3); $wpdb->query($vwplx1ap5_); $vwplx1ap5_ = 'SELECT * FROM `' . MEMBERIUM_DB_QUEUE . '` WHERE `pidlock` = %d AND `appname`= %s ;'; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplcm9i8y, $vwplw5rgd3); $vwplrc0wy = $wpdb->get_results($vwplx1ap5_, ARRAY_A); foreach ($vwplrc0wy as $vwply17edn => $vwplph268z) { $vwplz4g7n = json_decode($vwplph268z['data'], true); if ($vwplz4g7n) { $vwplrc0wy[$vwply17edn]['data'] = $vwplz4g7n; } } return $vwplrc0wy; } function wplwnax43($vwplu1i6) { $vwplopnf = (int) $vwplu1i6['id']; if ($vwplopnf) { global $wpdb; $vwplx1ap5_ = 'DELETE FROM `' . MEMBERIUM_DB_QUEUE . '` WHERE `id` = %d and `appname` = %s;'; $vwplx1ap5_ = $wpdb->prepare($vwplx1ap5_, $vwplu1i6['id'], $vwplu1i6['appname']); $wpdb->query($vwplx1ap5_); } }    function wplas0qx($vwplso1pw, $vwplph268z = 1) { $vwplso1pw = trim($vwplso1pw); if (empty($vwplso1pw) ) { return false; } global $wpdb; $vwplx1ap5_ = ''; return false; }    function wplnt3c4r() { $vwplz1bp7 = unserialize(base64_decode($_POST['payload']) ); $vwplvtmqd = (int) $vwplz1bp7['contact_id']; $vwpls0hwb5 = $vwplz1bp7['tag_id']; $vwplyf615d = $vwplz1bp7['goals']; $vwplewhxt_ = $vwplz1bp7['action_id']; $vwpltmfi = '';  if ($vwpls0hwb5 > '') { $this->wplad_mvo($vwplvtmqd, $vwpls0hwb5); } if ($vwplewhxt_ > '') { $this->wplmupt($vwplvtmqd, $vwplewhxt_); } if ($vwplyf615d > '') { $this->wplge1yc6($vwplyf615d, $vwplvtmqd); } $this->wplj9ye($vwplvtmqd); die(); }    function wpldh_n($vwply17edn, $vwplz4g7n, $vwplcj8tb = 64) { if (strlen($vwply17edn) > $vwplcj8tb) { $vwply17edn = pack('H*', sha1($vwply17edn) ); } $vwply17edn = str_pad($vwply17edn, $vwplcj8tb, chr(0x00) ); $vwplun5t = str_repeat(chr(0x36), $vwplcj8tb); $vwplzy9_51 = str_repeat(chr(0x5c), $vwplcj8tb); $vwpla28xv1 = pack('H*', sha1( ($vwply17edn ^ $vwplzy9_51) . pack('H*', sha1( ($vwply17edn ^ $vwplun5t) . $vwplz4g7n) ) ) ); return base64_encode($vwpla28xv1); } function wplm2h6 ($vwpld8kxn, $precision = 2) { $vwplc5h2 = array('B', 'KB', 'MB', 'GB', 'TB'); $vwpld8kxn = max($vwpld8kxn, 0); $vwplw0b65k = floor( ($vwpld8kxn ? log($vwpld8kxn) : 0) / log(1024) ); $vwplw0b65k = min($vwplw0b65k, count($vwplc5h2) - 1);   $vwpld8kxn /= (1 << (10 * $vwplw0b65k) ); return round($vwpld8kxn, $precision) . ' ' . $vwplc5h2[$vwplw0b65k]; } static function wplixuai($vwplso1pw = '') { $vwplso1pw = strtolower(trim($vwplso1pw) ); $vwplvkv3 = false; $vwplv0vzua = wplz8bid::wplvf1d('remote_files'); if ($vwplso1pw) { if (array_key_exists($vwplso1pw, $vwplv0vzua) ) { $vwplvkv3 = $vwplv0vzua[$vwplso1pw]; $vwplsb_pf = array( 'region' => 'us-east-1', ); $vwplvkv3 = wp_parse_args($vwplvkv3, $vwplsb_pf); } } return $vwplvkv3; } function wpls6uf1($vwplbu4on, $vwplbu82r, $vwplx9rsp, $vwplff5g, $vwplkaroyi, $vwplg38x51, $vwplxp50 = 30) { $vwplj_8n = time() + (int) $vwplxp50; $vwplg38x51 = str_replace('%2F', '/', rawurlencode($vwplg38x51 = ltrim($vwplg38x51, '/') ) ); $vwplsvznw4 = '/'. $vwplkaroyi .'/'. $vwplg38x51; $vwplh2zvuw = implode("\n", $pieces = array('GET', null, null, $vwplj_8n, $vwplsvznw4) ); $vwpltmfi = $this->wpldh_n($vwplbu82r, $vwplh2zvuw);  $url = sprintf('%s://%s.%s/%s', $vwplx9rsp, $vwplkaroyi, $vwplff5g, $vwplg38x51); $qs = http_build_query($pieces = array('AWSAccessKeyId' => $vwplbu4on, 'Expires' => $vwplj_8n, 'Signature' => $vwpltmfi,) ); return $url . '?' . $qs; }  function wplcr6e($vwplbu4on, $vwplbu82r, $vwplkaroyi, $vwpljktqp, $vwplj_8n = 0, $vwplv1usb = 'us-east-1', $vwplk31ar = array() ) { $vwpld_6st1 = str_replace('%2F', '/', rawurlencode($vwpljktqp) ); $vwplioat9 = array(); foreach ($vwplk31ar as $vwply17edn => $vwplph268z) { $vwplioat9[strtolower($vwply17edn)] = $vwplph268z; } if (! array_key_exists('host', $vwplioat9) ) { $vwplioat9['host'] = ($vwplv1usb == 'us-east-1') ? "{$vwplkaroyi}.s3.amazonaws.com" : "{$vwplkaroyi}.s3-{$vwplv1usb}.amazonaws.com"; } ksort($vwplioat9); $vwpll0ys = ''; foreach ($vwplioat9 as $vwply17edn => $vwplph268z) { $vwpll0ys .= $vwply17edn . ':' . trim($vwplph268z) . "\n"; } $vwplm0ca = implode(';', array_keys($vwplioat9) ); $vwplgjp7v = time(); $vwplycnpv4 = gmdate('Ymd', $vwplgjp7v); $vwplzx947m = $vwplycnpv4 . 'T000000Z'; $vwplzx947m = $vwplycnpv4 . 'T' . gmdate('His', $vwplgjp7v) . 'Z'; $vwpln_wtl = 'AWS4-HMAC-SHA256'; $vwplsq9ief = "$vwplycnpv4/$vwplv1usb/s3/aws4_request"; $vwplqmja = array( 'X-Amz-Algorithm' => $vwpln_wtl, 'X-Amz-Credential' => $vwplbu4on . '/' . $vwplsq9ief, 'X-Amz-Date' => $vwplzx947m, 'X-Amz-SignedHeaders' => $vwplm0ca ); if ($vwplj_8n > 0) { $vwplqmja['X-Amz-Expires'] = $vwplj_8n; } ksort($vwplqmja); $vwplmh7v = array(); foreach ($vwplqmja as $vwply17edn => $vwplph268z) { $vwplmh7v[] = rawurlencode($vwply17edn) . '=' . rawurlencode($vwplph268z); } $vwplmzn25 = implode('&', $vwplmh7v); $vwplpzx7tr = "GET\n$vwpld_6st1\n$vwplmzn25\n$vwpll0ys\n$vwplm0ca\nUNSIGNED-PAYLOAD"; $vwplg82ay1 = "$vwpln_wtl\n$vwplzx947m\n$vwplsq9ief\n" . hash('sha256', $vwplpzx7tr, false); $vwplwbki = hash_hmac('sha256', 'aws4_request', hash_hmac('sha256', 's3', hash_hmac('sha256', $vwplv1usb, hash_hmac('sha256', $vwplycnpv4, 'AWS4' . $vwplbu82r, true), true), true), true); $vwpltmfi = hash_hmac('sha256', $vwplg82ay1, $vwplwbki); $vwplfkojlf = 'https://' . $vwplioat9['host'] . $vwpld_6st1 . '?' . $vwplmzn25 . '&X-Amz-Signature=' . $vwpltmfi; return $vwplfkojlf; } function wpla2myl() { if (! function_exists('badgeos_get_achievements') ) { return array(); } $vwplgitq = array( 'posts_per_page' => -1, 'orderby' => 'title', 'order' => 'ASC', ); $vwpln5nhr = badgeos_get_achievements($vwplgitq); $vwplggu9p = array(); foreach($vwpln5nhr as $vwpl_r0vf) { $vwplggu9p[$vwpl_r0vf->ID] = $vwpl_r0vf->post_title; } return $vwplggu9p; }    function wplrghfe($vwplocprw, $vwplyqfz) { static $seen = array(); if (! empty($seen[$vwplyqfz][$vwplocprw])) { return; } if ($vwplocprw == 50) { $vwplmu62n = wpllbej::wplntnyv('Contact'); $vwpllc8tz = array(  $this->options['settings']['password_field'] ); foreach($vwplmu62n as $vwply17edn => $vwple2yn) { if (in_array($vwple2yn, $vwpllc8tz) ) { unset($vwplmu62n[$vwply17edn]); } } unset($vwply17edn, $vwpllc8tz); ?>
			<!-- li class="default_value_setting admin_label_setting field_setting" -->
			<li class="admin_label_setting field_setting">
			<label for="field_admin_label" class="section_label">
			Memberium Sync
			<?php ?>

			</label>
			<select id="memberiumfieldsync" onchange="SetFieldProperty('memberiumfieldsync', this.value);" >
			<option value="">(None)</option>
			<?php
 if (is_array($vwplmu62n) ) { foreach($vwplmu62n as $vwpl_s6l) { echo '<option value="', $vwpl_s6l, '">' . $vwpl_s6l . '</option>'; } } ?>
			</select>
			</li>
			<?php
 } $seen[$vwplyqfz][$vwplocprw] = 1; } function wplk3_076() { ?>
		<script type='text/javascript'>
		//adding setting to fields of type "text"
		fieldSettings.text += ", .memberiumfieldsync";

		//binding to the load field settings event to initialize the checkbox
		jQuery(document).bind("gform_load_field_settings", function(event, field, form){
			jQuery("#memberiumfieldsync").val(field["memberiumfieldsync"]);
		});
		</script>
		<?php
 }  function wplqr36g($vwplelob86, $vwplt73pl) { $vwpls0hwb5 = wplj_l2t::wplaajf(); $vwplph268z = rgar($vwplt73pl, 'memberiumformtag'); $vwploh26c = '<option value="">(None)</option>'; foreach($vwpls0hwb5['mc'] as $k => $v) { $vwploh26c .= '<option value="' . $k . '" ' . ($vwplph268z== $k ? ' selected=selected ' : '') . '>' . $v . '</option>'; } unset($vwpls0hwb5, $vwplph268z); $vwplelob86['Form Options']['memberiumformtag'] = '
		<tr>
		<th><label for="memberiumformtag">Memberium Form Tag</label></th>
		<td><select name="memberiumformtag">' . $vwploh26c . '</select></td>
		</tr>'; return $vwplelob86; } function wplu5du6j($vwplt73pl) { $vwplt73pl['memberiumformtag'] = rgpost('memberiumformtag'); return $vwplt73pl; }  function wplc0vje($entry, $action) { }    function wpledu_le() {  } function wpldqdn() { $vwplnzlj0t = 'SavedFilter'; $vwplwtw3 = array(); $vwplanieul = 1000; $vwplho_n = 0; $vwplc0g3p = wpllbej::wplntnyv('SavedFilter'); $vwplv80sz = array( 'ReportStoredName' => 'AffiliateActivitySummary', ); do { $vwply4j8x = $this->isdk->dsQuery($vwplnzlj0t, $vwplanieul, $vwplho_n, $vwplv80sz, $vwplc0g3p); foreach($vwply4j8x as $vwplheakg) { $vwplwtw3[$vwplheakg['Id']] = array( 'UserId' => (int) $vwplheakg['UserId'], 'FilterName' => $vwplheakg['FilterName'], ); } $vwplho_n++; } while (count($vwply4j8x) >= $vwplanieul); unset($vwply4j8x, $vwplheakg, $vwplho_n, $vwplanieul, $vwplnzlj0t, $vwplc0g3p, $vwplv80sz); if (count($vwplwtw3) == 1) { } return $vwplwtw3; } function wplcup985($vwplvtmqd = 0, $vwplf4y5 = 'first') { } function wplvyjh($vwplvtmqd, $vwple2yn) { if (! $vwplvtmqd || empty($vwple2yn) ) { return; } $vwple2yn = strtolower($vwple2yn); $session_contact_id = wplsbzgvp::wplfhxj9(); $vwplyio4f = ''; if ($vwplvtmqd == $session_contact_id) { $vwplyio4f = wplsbzgvp::wplc4na($vwple2yn); } else { $vwpllzly5b = wpllbej::wplsgpnk($vwplvtmqd); $vwplc0nobe = $this->wplyte2($vwpllzly5b); $vwplyio4f = isset($vwplc0nobe['memb_db_fields'][$vwple2yn]) ? $vwplc0nobe['memb_db_fields'][$vwple2yn] : ''; } return $vwplyio4f; } function wpl_91fox($vwpli0g4, $vwpldn570, $vwpllzly5b) { if (user_can($vwpllzly5b, 'manage_options') ) { $vwpli0g4 = YEAR_IN_SECONDS; } else { return $vwpli0g4 > DAY_IN_SECONDS ? DAY_IN_SECONDS : $vwpli0g4; } } function __construct() { static $vwplkp4j = false; if ($vwplkp4j) { return; } $vwplkp4j = true; global $i2sdk, $wpdb; $vwplnkj9d_ = wplz8bid::wplvf1d(); $this->license_status = wpln9_s::wplio5sck(); $this->options = $vwplnkj9d_; $this->servername = preg_replace('/^www\./', '', strtolower(parse_url(get_bloginfo('url'), PHP_URL_HOST) ) ); $this->i2sdk = $i2sdk; $this->isdk = $this->i2sdk->isdk; if (is_object($this->i2sdk) ) { $this->isdk = $this->i2sdk->isdk; } $this->wplmk6pf(); $this->wplhcs40();  $this->license_key_name = wpln9_s::wplfdzy(); wpln9_s::wplio5sck(); $this->wplicnz();  if (is_object($i2sdk) ) { $this->isdk = $this->i2sdk->isdk; $this->i2sdk_options = get_option('i2sdk'); } if (isset($_COOKIE['login_error']) ) { $this->login_error = esc_html(__($_COOKIE['login_error']) ); setcookie ('login_error', '', (time() - 86400) ); } $this->dirty_contacts = array(); } function wplicnz() { add_filter('auth_cookie_expiration', array($this, 'wpl_91fox'), 999, 3); add_filter('bbp_get_topic_subscribers', array($this, 'wpl_sw4') );  add_filter('cron_schedules', array($this, 'wplr5ah'), 1); add_filter('login_url', array($this, 'wpld0z1'), 999999, 3); add_filter('updater_plugins_api_result', array('wplhodw', 'wpll6pvi'), 10, 3); add_filter('updater_plugins_api', array('wplhodw', 'wplbxtwd6'), 10, 3); add_filter('updater_pre_set_site_transient_update_plugins', array('wplhodw', 'wpllaybf'), 10, 1); add_filter('wp_nav_menu_args', array($this, 'wplxc63') ); add_filter('wp_privacy_personal_data_erasers', array('wpls_n0', 'wpljsileq'), 11); add_filter('wp_privacy_personal_data_exporters', array('wpls_n0', 'wplmlkn'), 10);     add_action('after_password_reset', array($this, 'wpljwg6'), 10, 2); add_action('i2sdk_custom_fields_sync', array($this, 'wplkly4q'), 10, 2); add_action('init', array('wplgghs1', 'wpl_cs7'), 1); add_action('init', array($this, 'wplf5yc6') ); add_action('memberium_license_check', array('wpln9_s', 'wplzjhtq') ); add_action('memberium_maintenance', 'memberium_cron_class::install_cron_jobs', 1); add_action('memberium_maintenance', array('wpldk1bw', 'wplpen2') ); add_action('memberium_maintenance', array('wpldk1bw', 'wplan6_u') ); add_action('memberium_maintenance', array('wpldk1bw', 'wplme0cfq') ); add_action('memberium_maintenance12', array('wplycjh', 'wplt_pchy') ); add_action('memberium_maintenance12', array('wpldk1bw', 'wpli8x_6') ); add_action('memberium_scanmakepass', array('wpldk1bw', 'wplgg2tyv') ); add_action('plugins_loaded', 'wplu_9s', 1, 0); add_action('plugins_loaded', 'wplcqoi', 2, 0); add_action('plugins_loaded', array($this, 'wplwr8umh'), 1); add_action('set_current_user', array($this, 'wplftqail'), 1); add_action('shutdown', array($this, 'wplqr1_k'), 100, 0); add_action('user_register', array($this, 'wplspf_zg'), 10); add_action('woocommerce_customer_reset_password', array($this, 'after_password_reset'), 10, 1); add_action('wp_ajax_memb_ajax_actions', array($this, 'wplnt3c4r'), 99); add_action('wp_ajax_nopriv_memb_ajax_actions', array($this, 'wplnt3c4r'), 99);  if (wplz8bid::wplvf1d('settings', 'attachment_pages', 0) ) { add_filter('attachment_link', function($link) { return; }); add_filter('rewrite_rules_array', function($vwplypc8) { foreach ($vwplypc8 as $vwplxqibg => $vwplv80sz) { if (strpos($vwplxqibg, 'attachment') || strpos($vwplv80sz, 'attachment') ) { unset($vwplypc8[ $vwplxqibg ]); } } return $vwplypc8; }); }  if (wplz8bid::wplvf1d('settings', 'multi_language', 0) ) { add_filter('gettext', array('wplixy6zk', 'wplo8wzao'), PHP_INT_MAX, 3); add_filter('gettext_with_context', array('wplixy6zk', 'wplra2l'), PHP_INT_MAX, 4); } if (wplz8bid::wplvf1d('settings', 'dynamic_menus') ) { add_action('init', array($this, 'wplei1pk'), 99); } if (wplz8bid::wplvf1d('settings', 'sync_meta_updates') ) { add_action('updated_user_metadata', array($this, 'wplvmehf6'), 10, 4); add_filter('update_user_metadata', array($this, 'wplaxba98'), 10, 5); add_action('update_user_meta', array($this, 'wplmhgwq'), 10, 5); }      if (wplz8bid::wplvf1d('settings', 'wplogin_redirect_to') ) { add_filter('login_redirect', array($this, 'wpli0kwi'), 1000000, 3); }  add_filter('wpal/blocks/access_levels', array($this, 'wpl_q6ra'), 10, 2); add_filter('wpal/blocks/get_key_map', array($this, 'wplxc94'), 10, 2); } function wplhcs40() { if ( (defined('DOING_AJAX') && DOING_AJAX) || (! is_admin() ) ) { $this->wplbg3oj(); $this->wplbdsm(); } if (is_admin() ) { $this->wplk1zp_v(); } } private $doing_http_post = false; private $contact_id = 0; private $admin_class = false; protected $contact_cache_refreshed = 0; protected $debugfile; protected $dirty_contacts = array(); protected $i2sdk; protected $i2sdk_options; protected $license_status = false; protected $options; protected $sso_mode = 0; protected $trial_mode = 0; protected $version; public $license_key_name = ''; public $doing_user_update = false; public $login_error = ''; public $isdk = NULL; public $servername = ''; public $user_count = 0; public $frontend_class = false; public $shortcodes = false;  const MEMBERIUM = true; const MEMBERIUM_INSTALLED = 1; const DELIMITER = '|'; const DEBUGLOG = '/tmp/debuglog.txt'; const DB_DATAFORMFIELDS = 'i2sdk_dataformfields'; const PLUGIN_UPDATE_URL = 'https://licenseserver.webpowerandlight.com/memberium-is/current-version.php'; }
