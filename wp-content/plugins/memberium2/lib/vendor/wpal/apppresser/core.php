<?php
 if (! defined('ABSPATH') ) { die(); } final class wplodpi4 { function wplicnz() { add_action('rest_api_init', array($this, 'wplgk52v') ); add_action('rest_api_init', array($this, 'wplpj4r') );  add_action('rest_api_init', array($this, 'wpl_d1iw') ); add_filter('wp_authenticate_user', array($this, 'wplkcz_'), 10, 2);  } function wplgk52v() {  register_rest_field('post', 'featured_image_urls', array( 'get_callback' => array($this, 'wpluvgh'), 'update_callback' => null, 'schema' => null, ) );  $vwploi5790 = appp_get_setting('media_post_types'); if (!empty($vwploi5790) ) { foreach ($vwploi5790 as $vwplgm_9s) { register_rest_field($vwplgm_9s, 'appp_media', array( 'get_callback' => array($this, 'wplvcpugw'), 'update_callback' => null, 'schema' => null, ) ); } } }  function wplbbf29k($vwplukr7m) { $vwplm7q58['user_login'] = ($_POST['username'] ? $_POST['username'] : $_SERVER['PHP_AUTH_USER']); $vwplm7q58['user_password'] = ($_POST['password'] ? $_POST['password'] : $_SERVER['PHP_AUTH_PW']); $vwplm7q58['remember'] = true; if (empty($vwplm7q58['user_login']) || empty($vwplm7q58['user_password']) ) { $vwplaocx0b = array( 'success' => false, 'data' => array( 'message' => apply_filters('appp_login_error', __('Login missing required fields.', 'apppresser'), ''), 'success' => false ) ); return rest_ensure_response($vwplaocx0b); } do_action('appp_before_signon', $vwplm7q58); $vwpluscu3 = wp_signon($vwplm7q58, false); do_action('appp_login_header'); if (is_wp_error($vwpluscu3) ) { $vwplaocx0b = array( 'success' => false, 'data' => array( 'message' => apply_filters('appp_login_error', __('The login you have entered is not valid.', 'apppresser'), $vwplm7q58['user_login']), 'success' => false ) ); return rest_ensure_response($vwplaocx0b); } else {  $vwpll6m0_n = $this->wplvf8d7g($vwpluscu3->ID); $vwplaocx0b = array( 'message' => apply_filters('appp_login_success', sprintf(__('Welcome back %s!', 'apppresser'), $vwpluscu3->display_name), $vwpluscu3->ID), 'username' => $vwplm7q58['user_login'], 'avatar' => get_avatar_url($vwpluscu3->ID), 'cookie_auth' => $vwpll6m0_n, 'login_redirect' => AppPresser_Ajax_Extras::get_login_redirect(),  'success' => true, 'user_id' => $vwpluscu3->ID ); } $vwplaocx0b = apply_filters('appp_login_data', $vwplaocx0b, $vwpluscu3->ID); $retval = rest_ensure_response($vwplaocx0b); return $retval; }  function wplij1ry($vwplukr7m) { do_action('appp_logout_header'); if (! defined('DOING_AJAX') ) { define('DOING_AJAX', true); } wp_logout(); $vwplu_gxri = array( 'message' => __('Logout success.', 'apppresser'), 'success' => true ); $vwpltancmh = $this->wplu13ot(); if ($vwpltancmh) { $vwplu_gxri['logout_redirect'] = $vwpltancmh; } $vwplq1gxeu = rest_ensure_response($vwplu_gxri); return $vwplq1gxeu; }  function wplpj4r() {  if (appp_get_setting('ap3_enable_cors', false) ) { add_filter('appp_allow_api_origin', function() { return '*'; }); $this->wplon7_gb(); } else { add_filter('appp_allow_api_origin', function() { return false; }); } }  function wplon7_gb() { $vwplj97i = apply_filters('appp_allow_api_origin', '*'); $vwpllb_ry = apply_filters('appp_allow_api_methods', 'GET,PUT,POST,DELETE,PATCH,OPTIONS'); if ($appp_allow_origin) { header("Access-Control-Allow-Origin: {$vwplj97i}"); header("Access-Control-Allow-Methods: {$vwpllb_ry}"); } }  function wplkcz_($vwplgogvie, $vwplsjoas) { if (get_user_meta($vwplgogvie->ID, 'app_unverified', true) ) { return new WP_Error('app_unverified_login', __('You have not verified your account by email, please contact support.', 'apppresser'), array( 'status' => 404, ) ); } return $vwplgogvie; }  function wplvf8d7g($vwpllzly5b) { if (function_exists('openssl_encrypt') ) { $vwply17edn = substr(AUTH_KEY, 2, 5); $vwplohk4 = substr(AUTH_KEY, 0, 16); $vwplwb3fre = "AES-128-CBC"; $vwplh1jkpg = openssl_encrypt($vwpllzly5b, $vwplwb3fre, $vwply17edn, null, $vwplohk4); } else {  $vwplh1jkpg = $vwpllzly5b; } update_user_meta($vwpllzly5b, 'app_cookie_auth', $vwplh1jkpg); return $vwplh1jkpg; }  function wplu13ot() { if (has_filter('appp_logout_redirect') ) { $vwplwpg_6 = apply_filters('appp_logout_redirect', ''); return AppPresser_Ajax_Extras::add_redirect_title($vwplwpg_6); } else { return ''; } } function wplvcpugw($vwplzzlf5b) { $vwplph268z = get_post_meta($vwplzzlf5b['id'], 'appp_media_url', true); $vwplz4g7n = array(); if (empty($vwplph268z)) { return; } $vwplz4g7n['media_url'] = $vwplph268z; $vwplzbehq_ = get_post_meta($vwplzzlf5b['id'], 'appp_media_image', true); if (! empty($vwplzbehq_) ) { $vwplz4g7n['media_image'] = $vwplzbehq_; } return $vwplz4g7n; }  function wplkg48($vwplukr7m) { $vwplz4izhe = $vwplukr7m['email']; $vwplgogvie = get_user_by('email', $vwplz4izhe); if ($vwplgogvie) { $vwplin_i8 = current_time('mysql'); $vwplm49zh = $this->wpluvndj0();  update_user_meta($vwplgogvie->ID, 'app_hash', $vwplm49zh); $vwplja03u = __('App Password Reset', 'apppresser'); $vwplja03u = apply_filters('appp_pw_reset_email_subject', $vwplja03u); $vwplygr2 = __('Enter the code into the app to reset your password. Code: ', 'apppresser') . $vwplm49zh; $vwplygr2 = apply_filters('appp_pw_reset_email', $vwplygr2, $vwplm49zh); $mail = wp_mail($vwplgogvie->user_email, $vwplja03u, $vwplygr2); $return = array( 'success' => true, 'got_code' => true, 'message' => __('Please check your email for your verification code.', 'apppresser') ); } else { $return = array( 'success' => false, 'message' => __('The email you have entered is not valid.', 'apppresser') ); } return $return; } function wpluvndj0() { $vwplc9bs = str_split('1234567890'); $vwplvc1p = str_split('abcdefghijklmnopqrstuvwxyz'); shuffle($vwplc9bs); shuffle($vwplvc1p); $vwpluvdiz = $vwplc9bs[1] . $vwplvc1p[1] . $vwplvc1p[2] . $vwplc9bs[3]; return $vwpluvdiz; } function wpluvgh($vwplzzlf5b) { $vwple7as = get_post_thumbnail_id($vwplzzlf5b['id']); $vwpld8dvt = wp_get_attachment_metadata($vwple7as); $vwplzn68 = new stdClass(); if (! empty($vwpld8dvt['sizes']) ) { foreach ($vwpld8dvt['sizes'] as $key => $size) {  $image_src = wp_get_attachment_image_src($vwple7as, $key); if (! $image_src) { continue; } $vwplzn68->$key = $image_src[0]; } } return $vwplzn68; }  function wpl_d1iw() {  if (! class_exists('WP_REST_Controller') ) { return; } $vwplsa6j3 = 'appp/v1'; $vwplyay7p = 'methods'; $vwplebf6v = 'callback'; $vwpls9qlg = WP_REST_Server::CREATABLE; $vwplt51rdx = WP_REST_Server::READABLE; register_rest_route($vwplsa6j3, '/login', array( array( $vwplyay7p => $vwpls9qlg, $vwplebf6v => array($this, 'wplbbf29k') ), ) ); register_rest_route($vwplsa6j3, '/logout', array( array( $vwplyay7p => $vwplt51rdx, $vwplebf6v => array($this, 'wplij1ry') ), ) ); register_rest_route($vwplsa6j3, '/register', array( array( $vwplyay7p => $vwpls9qlg, $vwplebf6v => array($this, 'wpl_3ejox') ), ) ); register_rest_route($vwplsa6j3, '/verify', array( array( $vwplyay7p => $vwpls9qlg, $vwplebf6v => array($this, 'wplo17bhi') ), ) ); register_rest_route($vwplsa6j3, '/verify-resend', array( array( $vwplyay7p => $vwpls9qlg, $vwplebf6v => array($this, 'wplv809') ), ) ); register_rest_route($vwplsa6j3, '/reset-password', array( array( $vwplyay7p => $vwpls9qlg, $vwplebf6v => array($this, 'wplr9fzs') ), ) ); }  function wpl_3ejox($vwplukr7m) { if (empty($vwplukr7m['username']) || empty($vwplukr7m['email']) ) { return new WP_Error('rest_invalid_registration', __('Missing required fields.', 'apppresser'), array( 'status' => 404, ) ); } if (email_exists($vwplukr7m['email']) || username_exists($vwplukr7m['username']) ) { return new WP_Error('rest_invalid_registration', __('Email or username already exists.', 'apppresser'), array( 'status' => 404, ) ); } if (empty($vwplukr7m['password']) ) { $vwplsjoas = wp_generate_password(8);  } else { $vwplsjoas = $vwplukr7m['password']; } $vwpldiz8 = array( 'user_login' => $vwplukr7m['username'], 'user_pass' => $vwplsjoas, 'user_email' => $vwplukr7m['email'], 'first_name' => $vwplukr7m['first_name'], 'last_name' => $vwplukr7m['last_name'] ); $vwpllzly5b = wp_insert_user($vwpldiz8); if (is_wp_error($vwpllzly5b) ) { return new WP_Error('rest_invalid_registration', __('Something went wrong with registration.', 'apppresser'), array( 'status' => 404, ) ); } update_user_meta($vwpllzly5b, 'app_unverified', true); $vwplnlndz = $this->wplv809($vwplukr7m);  if (! $vwplnlndz) { return new WP_Error('rest_invalid_registration', __('We could not send your verification code by email, please contact support.', 'apppresser'), array( 'status' => 404, ) ); } do_action('appp_register_unverified', $vwpllzly5b); $vwpltalx = __("Your verification code has been sent, please check your email.", "apppresser"); $vwplq1gxeu = rest_ensure_response($vwpltalx); return $vwplq1gxeu; }  function wplr9fzs($vwplukr7m) { $vwplu9w10 = array( 'success' => false, 'message' => 'Missing required fields.' ); if (isset($vwplukr7m['code']) && isset($vwplukr7m['password']) ) { $vwplu9w10 = $this->wplk_6ji($vwplukr7m); } elseif (isset($vwplukr7m['email']) ) { $vwplu9w10 = $this->wplkg48($vwplukr7m); } return $vwplu9w10; }  function wplv809($vwplukr7m) { if (empty($vwplukr7m['email']) || empty($vwplukr7m['username']) ) { return new WP_Error('rest_invalid_verification', __('Missing required field.', 'apppresser'), array( 'status' => 404, ) ); } if (! email_exists($vwplukr7m['email']) || ! username_exists($vwplukr7m['username']) ) { return new WP_Error('rest_invalid_verification', __('Invalid username or email.', 'apppresser'), array( 'status' => 404, ) ); } $vwplqj3kv8 = hash('md5', $vwplukr7m['username'] . $vwplukr7m['email']);  $vwplqj3kv8 = substr($vwplqj3kv8, 1, 4);  $vwplja03u = __('Your Verification Code', 'apppresser'); $vwplja03u = apply_filters('appp_verification_email_subject', $vwplja03u); $vwplckl3 = sprintf(__("Hi, thanks for registering! Here is your verification code: %s \n\nPlease enter this code in the app. \n\nThanks!", "apppresser"), $vwplqj3kv8); $vwplckl3 = apply_filters('appp_verification_email', $vwplckl3, $vwplqj3kv8); $vwplnlndz = wp_mail($vwplukr7m["email"], $vwplja03u, $vwplckl3); return $vwplnlndz; }  function wplk_6ji($vwplukr7m) { global $wpdb; $vwpluvdiz = $vwplukr7m['code']; $vwplsjoas = $vwplukr7m['password']; $vwplgitq = array( 'meta_key' => 'app_hash', 'meta_value' => $vwpluvdiz ); $vwplgogvie = get_users($vwplgitq); if ($vwplgogvie) { $vwplgitq = array( 'ID' => $vwplgogvie[0]->data->ID, 'user_pass' => $vwplsjoas ); wp_update_user($vwplgitq) ; delete_user_meta($vwplgogvie[0]->data->ID, 'app_hash');  $vwplu9w10 = array( 'message' => __('Your password has been changed, please login.', 'apppresser'), 'pw_changed' => true, 'success' => true ); } else { $vwplu9w10 = array( 'success' => false, 'message' => __('The code you have entered is not valid.', 'apppresser') ); } return $vwplu9w10; }  function wplo17bhi($vwplukr7m) { if (empty($vwplukr7m['email']) || empty($vwplukr7m['verification']) ) { return new WP_Error('rest_invalid_verification', __('Missing required field.', 'apppresser'), array( 'status' => 404, ) ); } $vwplqj3kv8 = hash('md5', $vwplukr7m['username'] . $vwplukr7m['email']); $vwplqj3kv8 = substr($vwplqj3kv8, 1, 4); if ($vwplukr7m['verification'] != strval($vwplqj3kv8) ) {  return new WP_Error('rest_invalid_verification', __('The verification code does not match.', 'apppresser'), array( 'status' => 404, ) ); } $vwplgogvie = get_user_by('email', $vwplukr7m['email']); delete_user_meta($vwplgogvie->ID, 'app_unverified');  $info = array(); $info['user_login'] = $vwplukr7m['username']; $info['user_password'] = $vwplukr7m['password']; $info['remember'] = true; $user_signon = wp_signon($info, false); if (is_wp_error($user_signon) || !$vwplgogvie) { return new WP_Error('rest_invalid_verification', __('Verification succeeded, please login.', 'apppresser'), array( 'status' => 200, ) ); } $vwplygr2 = array( 'message' => apply_filters('appp_login_success', sprintf(__('Welcome back %s!', 'apppresser'), $user_signon->display_name), $user_signon->ID), 'username' => $info['user_login'], 'avatar' => get_avatar_url($user_signon->ID),  'success' => true, 'user_id' => $user_signon->ID );  $vwplygr2 = apply_filters('appp_login_data', $vwplygr2, $user_signon->ID); do_action('appp_register_verified', $user_signon->ID); $vwplq1gxeu = rest_ensure_response($vwplygr2); return $vwplq1gxeu; }  function __construct() { $this->wplicnz(); } }
