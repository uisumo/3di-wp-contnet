<?php  if(!defined('ABSPATH')){exit;}class IW_SetInfReferralPartner_Action extends IW_Automation_Action{function get_title(){return "Set Session Referral Partner (Infusionsoft)";}function allowed_triggers(){return array('IW_Checkout_Trigger','IW_AddToCart_Trigger','IW_PageVisit_Trigger','IW_UserAction_Trigger','IW_OrderCreation_Trigger','IW_HttpPost_Trigger','IW_UserConsent_Trigger','IW_WooSubEvent_Trigger','IW_ProductReview_Trigger');}function display_html($config=array()){$type=isset($config['type'])?$config['type']:'';$value=isset($config['value'])?$config['value']:'';$html='<select type="text" class="browser-default" name="type">';$html .='<option value="affid" '.($type =='affid'?'selected':'').'>Enter Referral Partner ID</option>';$html .='<option value="affcode" '.($type =='affcode'?'selected':'').'>Enter Referral Partner Code</option></select>';$html .='&nbsp;&nbsp;<input type="text" name="value" value="'.$value.'" placeholder="" class="iwar-mergeable" style="width: 150px;"  />';$html .='<i class="fa fa-compress merge-button merge-overlap" aria-hidden="true" title="Insert Merge Field"></i>';return $html;}function validate_entry($config){if(empty($config['value'])){return 'Please enter a value';}}function process($config,$trigger){global $iwpro;$siteurl=isset($_SERVER['HTTP_HOST'])?$_SERVER['HTTP_HOST']:'';$siteurl=str_replace("http://","",$siteurl);$siteurl=str_replace("https://","",$siteurl);$siteurl=str_replace("www.","",$siteurl);$aff_data=$trigger->merger->merge_text($config['value']);$is_aff="";if($config['type']=='affid'){setcookie("is_aff",$aff_data,(time()+365*24*3600),"/",$siteurl,0);setcookie("is_affcode","",-1,"/",$siteurl,0);if(WC()->session){WC()->session->set('iw_is_aff',$aff_data);WC()->session->set('iw_is_affcode',false);}$is_aff=$aff_data;}else{setcookie("is_affcode",$aff_data,(time()+365*24*3600),"/",$siteurl,0);setcookie("is_aff","",-1,"/",$siteurl,0);if(WC()->session){WC()->session->set('iw_is_affcode',$aff_data);WC()->session->set('iw_is_aff',false);}}$contact_id=$trigger->search_infusion_contact_id();if($contact_id &&!is_admin()){if(empty($is_aff)){$returnFields=array('Id');$affiliate=$iwpro->app->dsFind('Affiliate',1,0,'AffCode',$aff_data,$returnFields);$affiliate=$affiliate[0];$is_aff=(int) $affiliate['Id'];}if($is_aff){$iwpro->app->dsAdd('Referral',array('ContactId' =>$contact_id,'AffiliateId' =>$is_aff,'IPAddress' =>$_SERVER['REMOTE_ADDR'],'Type' =>0,'DateSet' =>date("Y-m-d")));}}}}iw_add_action_class('IW_SetInfReferralPartner_Action');