<?php  if(!defined('ABSPATH')){exit;}add_action('template_redirect','iw_typagecontrol');function iw_typagecontrol(){global $iwpro;if(is_order_received_page()){$overrides=get_option('iw_ty_ovs');if(function_exists('WC'))WC()->cart->empty_cart();if(!is_array($overrides)||count($overrides)==0)return false;$sorted_overrides=array();foreach($overrides as $k =>$v){$sorted_overrides[$overrides[$k]['order']]=$v;}ksort($sorted_overrides);if(isset($_GET['view-order'])){$orderid=$_GET['view-order'];}else if(isset($_GET['order-received'])){$orderid=$_GET['order-received'];}else{$url=$_SERVER['SERVER_NAME'].$_SERVER['REQUEST_URI'];$template_name=strpos($url,'/order-received/')===false?'/view-order/':'/order-received/';if(strpos($url,$template_name)!==false){$start=strpos($url,$template_name);$first_part=substr($url,$start+strlen($template_name));if(strpos($first_part,'/')!==false){$orderid=substr($first_part,0,strpos($first_part,'/'));}else{$orderid=substr($first_part,0,strpos($first_part,'?'));}}}if($orderid){$order=new WC_Order($orderid);if(!$order->key_is_valid($_GET['key'])){return false;}}else{return false;}$passvars=array('FirstName' =>stripslashes($order->get_billing_first_name()),'LastName' =>stripslashes($order->get_billing_last_name()),'Email' =>stripslashes($order->get_billing_email()),'StreetAddress1' =>stripslashes($order->get_billing_address_1()),'StreetAddress2' =>stripslashes($order->get_billing_address_2()),'City' =>stripslashes($order->get_billing_city()),'State' =>stripslashes($order->get_billing_state()),'Country' =>stripslashes(iw_to_country($order->get_billing_country())),'PostalCode' =>stripslashes($order->get_billing_postcode()),'Address2Street1' =>stripslashes($order->get_shipping_address_1()),'Address2Street2' =>stripslashes($order->get_shipping_address_2()),'City2' =>stripslashes($order->get_shipping_city()),'State2' =>stripslashes($order->get_shipping_state()),'Country2' =>stripslashes(iw_to_country($order->get_shipping_country())),'WooOrderId' =>$orderid,'PostalCode2' =>stripslashes($order->get_shipping_postcode()));foreach($passvars as $k =>$v){$new_key=apply_filters('iw_ty_variable_key',$k);if($new_key !=$k){$passvars[$new_key]=$v;unset($passvars[$k]);}}$is_order_id=get_post_meta($orderid,'infusionsoft_order_id',true);if($is_order_id){$passvars['InfusionOrderId']=$is_order_id;if($iwpro->ia_app_connect()){$job=$iwpro->app->dsLoad('Job',$is_order_id,array('ContactId'));if(isset($job['ContactId']))$passvars['contactId']=$job['ContactId'];}}$getvars=array();foreach($_GET as $k =>$v){if($k !='page_id'){$passvars[$k]=$v;$getvars[$k]=$v;}}$items=$order->get_items();$totals=$order->get_total();$count=$order->get_item_count();$usedcoups=$order->get_coupon_codes();foreach($sorted_overrides as $o){$redir=false;$redir=iw_check_ov_conds($o,$items,$totals,$count,$usedcoups,$order);if($redir){$ty_uri=$o['url'];if($o['passvars']=='true'){if(strpos($ty_uri,"?")!==false)$ty_uri .="&".http_build_query($passvars);else $ty_uri .="?".http_build_query($passvars);}else if(count($getvars)>0){if(strpos($ty_uri,"?")!==false)$ty_uri .="&".http_build_query($getvars);else $ty_uri .="?".http_build_query($getvars);}header("Location: $ty_uri");exit();break;}}}}function iw_check_ov_conds($ov,$items,$totals,$count,$usedcoups,$order){if(isset($ov['cond'])){$conds=array(array('type' =>$ov['cond'],'further' =>$ov['further']));}else{$conds=$ov['conds'];}foreach($conds as $c){$sub_check=false;$type=$c['type'];$checks=$c['further'];if($type =='always'){return true;}else if($type =='product'){foreach($items as $item){if(in_array($item['product_id'],$checks)){$sub_check=true;}if(in_array($item['variation_id'],$checks)){$sub_check=true;}if($sub_check)break;}}else if($type =='categ'){foreach($items as $item){$cats=get_the_terms($item['product_id'],'product_cat');if(is_array($cats)){foreach($cats as $cat){if(in_array($cat->term_id,$checks)){$sub_check=true;}}}if($sub_check)break;}}else if($type =='morevalue'){$sub_check=($totals>$checks);}else if($type =='lessvalue'){$sub_check=($totals<$checks);}else if($type =='moreitem'){$sub_check=($count>$checks);}else if($type =='lessitem'){$sub_check=($count<$checks);}else if($type =='coupon'){if(empty($checks)){$sub_check=count($usedcoups)>0;}else{foreach($usedcoups as $coupon){if(strpos($checks,$coupon)!==false){$sub_check=true;}}}}else if($type =='pg'){$sub_check=($order->get_payment_method()==$checks);}if(!$sub_check){return false;}}return true;} ?>