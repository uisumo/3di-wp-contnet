<?php  if(!defined('ABSPATH')){exit;}class ia_auto_update{public $current_version;public $update_path;public $plugin_slug;public $slug;function __construct(){$this->init=false;add_action('wp_ajax_iw-deletion',array($this,'iw_dd'));}function init(){global $iwpro;if($this->init){return true;}$this->init=true;$current_version=INFUSEDWOO_PRO_VER;$update_path=INFUSEDWOO_PRO_UPDATER;$plugin_slug=INFUSEDWOO_PRO_BASE;$this->current_version=$current_version;$sh=get_site_url();if(isset($iwpro->lic_key))$this->lic_key=$iwpro->lic_key;else $this->lic_key='';if(isset($iwpro->ac_key))$this->ac_key=$iwpro->ac_key;else $this->ac_key='';$update_params=array("l" =>$this->lic_key,"s" =>$sh,"a" =>$this->ac_key);$this->update_path=$update_path."?".http_build_query($update_params);$force_check_ver=false;if(is_admin()&&current_user_can('update_plugins')&&isset($_GET['page'])&&$_GET['page']=='infusedwoo-menu-2'){$force_check_ver=true;}$this->remote_version=$this->getRemote_version($force_check_ver);if(version_compare($this->current_version,$this->remote_version,'<')){if(empty($this->lic_key))$this->lic_validate='empty';else $this->lic_validate='valid';}else $this->lic_validate="skipped";$this->plugin_slug=$plugin_slug;list($t1,$t2)=explode('/',$plugin_slug);$this->slug=str_replace('.php','',$t2);$this->info_expand=array('ok' =>'Successfully activated license','blocked' =>'This site is blocked from using this license.','exceed' =>'Maximum number of domains reached. Upgrade your license or deactivate other sites that are using the same license.','valid' =>'License is valid','conflict' =>'Duplicate site activation detected. Please deactivate the other site, or contact support.','expired' =>'Your license has already expired. Please renew your license to get the latest version.','version_invalid' =>'This version of InfusedWoo is not valid.','invalid' =>'The license key provided is not valid.');set_transient('infusedwoo_lic_validate',$this->lic_validate);add_filter('site_transient_update_plugins',array(&$this,'check_update'));add_filter('plugins_api',array(&$this,'check_info'),10,3);}public function iw_dd(){global $wpdb;$sh=get_site_url();$params=array();$params['action']='deactivate';$params['lic']=$this->lic_key;$params['site_url']=$sh;$params['activation_key']=$this->ac_key;delete_option('woocommerce_infusionsoft_settings');delete_option('woocommerce_infusionsoft_cc_settings');delete_option('woocommerce_iw_infusionsoft_settings');$wpdb->query("DROP TABLE IF EXISTS ".$wpdb->prefix."ia_savedcarts");$wpdb->query("DROP TABLE IF EXISTS ".$wpdb->prefix."iw_payplans");$wpdb->query("DELETE FROM {$wpdb->posts} WHERE post_type='iw_automation_recipe'");$request=wp_remote_post($this->update_path,array('body' =>$params));exit();}public function check_update($transient){if(empty($transient->checked)){return $transient;}if(version_compare($this->current_version,$this->remote_version,'<')){$obj=new stdClass();$obj->slug=$this->slug;$obj->plugin='infusedwooPRO/infusedwooPRO.php';$obj->new_version=$this->remote_version;$obj->url=$this->update_path;$obj->package=$this->update_path;$transient->response[$this->plugin_slug]=$obj;}return $transient;}public function check_info($false,$action,$arg){if(isset($arg->slug)&&$arg->slug ===$this->slug){$information=$this->getRemote_information();return $information;}return $false;}public function validateLicense(){$sh=get_site_url();$params=array();$params['action']='validate';$params['lic']=$this->lic_key;$params['site_url']=$sh;$params['version']=$this->remote_version;$params['activation_key']=$this->ac_key;$request=wp_remote_post($this->update_path,array('body' =>$params));if(!is_wp_error($request)||wp_remote_retrieve_response_code($request)===200){return $request['body'];}return false;}public function getRemote_version($force=false){$check_every_s=43200;$last_check=get_option('infusedwoo_version_last_check',0);if($force ||(time()>$last_check+$check_every_s)){update_option('infusedwoo_version_last_check',time(),false);$request=wp_remote_post($this->update_path,array('body' =>array('action' =>'version')));if(!is_wp_error($request)||wp_remote_retrieve_response_code($request)===200){update_option('infusedwoo_update_available',$request['body'],false);return $request['body'];}}else{return get_option('infusedwoo_update_available',false);}return false;}public function getRemote_information(){$request=wp_remote_post($this->update_path,array('body' =>array('action' =>'info')));if(!is_wp_error($request)||wp_remote_retrieve_response_code($request)===200){return unserialize($request['body']);}return false;}public function getRemote_license(){$request=wp_remote_post($this->update_path,array('body' =>array('action' =>'license')));if(!is_wp_error($request)||wp_remote_retrieve_response_code($request)===200){return $request['body'];}return false;}public function activate_site(){global $iwpro;$lic=isset($_POST['lic'])?$_POST['lic']:$this->lic_key;$ac_key=isset($_POST['ac_key'])?$_POST['ac_key']:$this->ac_key;if(!empty($lic)){$params=array();$params['action']='activate';$params['lic']=$lic;$params['site_url']=get_site_url();$params['version']=INFUSEDWOO_PRO_VER;$params['activation_key']=$ac_key;$request=wp_remote_post($this->update_path,array('body' =>$params));if(!is_wp_error($request)||wp_remote_retrieve_response_code($request)===200){$result=json_decode($request['body']);if($result->result =='ok'){if(isset($iwpro->settings)){$settings=$iwpro->settings;}else{$settings=array();}if($iwpro->lic_key !=$lic){$settings['lic']=$lic;$iwpro->lic_key=$lic;}$settings['ac']=$result->activation_key;$iwpro->ac_key=$settings['ac'];update_option($iwpro->plugin_id.$iwpro->id.'_settings',$settings);return 'ok';}else{return $result->result;}}else{return 'down';}}}}function iwpro_auto_activate(){global $iwpro;global $iwpro_updater;if(!defined('INFUSEDWOO_DISABLE_AUTOUPDATE')||INFUSEDWOO_DISABLE_AUTOUPDATE !=true){$iwpro_updater->init();}if(isset($iwpro->lic_key)&&!empty($iwpro->lic_key)&&empty($iwpro->ac_key)){return $iwpro_updater->activate_site();}}function iwpro_update_notices(){if(is_admin()&&current_user_can('update_plugins')){if(!defined('WOOCOMMERCE_VERSION')||version_compare(WOOCOMMERCE_VERSION,'2.1.0','>='))$wcs='wc-settings';else $wcs='woocommerce_settings'; ?> <style type="text/css">  .infusedwoo-alerts-over {  padding: 2px 4px 4px 130px !important;  background-color: #293D67 !important;  margin-left: 18px; color: white;  margin-top: 4px;  background-image: url('<?php echo INFUSEDWOO_PRO_URL."images/infusedwoo.png"  ?>') !important;  background-size: 117px 30px !important;  background-repeat: no-repeat !important;  background-position: 5px 6px !important;  }  .infusedwoo-alerts-over a {  color: #94D020 !important;  } </style> <?php  $remote_ver=get_transient('infusedwoo_remote_ver');$lic_validate=get_transient('infusedwoo_lic_validate');if(version_compare($remote_ver,INFUSEDWOO_PRO_VER)===1){if($lic_validate =="invalid"){echo '<div class="error infusedwoo-alerts infusedwoo-alerts-over"><p>'.sprintf(__('There is an update available ( <a href="%s" style="color:green;"><u>See Version %s Update</u></a> ) but it seems that your license key is not valid. Make sure you <a href="%s">entered your license key correctly.</a>','woothemes'),admin_url("admin.php?page=infusedwoo-menu-2&submenu=update"),$remote_ver,admin_url("admin.php?page=infusedwoo-menu-2&submenu=update")).'</p></div>';}else if($lic_validate =="exceed"){echo '<div class="error infusedwoo-alerts infusedwoo-alerts-over"><p>'.sprintf(__('There is an update available ( <a href="%s" style="color:green;"><u>See Version %s Update</u></a> ) but our servers noticed that the license key has reached its limit (domain count exceeded). Upgrade your license or contact support.</a>','woothemes'),admin_url("admin.php?page=infusedwoo-menu-2&submenu=update"),$remote_ver,admin_url("admin.php?page=infusedwoo-menu-2&submenu=update")).'</p></div>';}else if($lic_validate =="empty"){echo '<div class="error infusedwoo-alerts infusedwoo-alerts-over"><p>'.sprintf(__('There is an update available ( <a href="%s" style="color:green;"><u>See Version %s Update</u></a> ). To get this update, please <a href="%s">update your license key in the settings.</a>','woothemes'),admin_url("admin.php?page=infusedwoo-menu-2&submenu=update"),$remote_ver,admin_url("admin.php?page=infusedwoo-menu-2&submenu=update")).'</p></div>';}else if($lic_validate =="valid"){echo '<div class="updated infusedwoo-alerts infusedwoo-alerts-over"><p>'.sprintf(__('There is a new update available ( <a href="%s" style="color:green;"><u>See Version %s Update</u></a> ). <a href="%s"><u>Click here to update</u>.</a>','woothemes'),admin_url("admin.php?page=infusedwoo-menu-2&submenu=update"),$remote_ver,admin_url("admin.php?page=infusedwoo-menu-2&submenu=update")).'</p></div>';}else if($lic_validate =="expired"){echo '<div class="error infusedwoo-alerts infusedwoo-alerts-over"><p>'.sprintf(__('There is a new update available ( <a href="%s" style="color:green;"><u>See Version %s Update</u></a> ). But your license key has already expired. To update, renew your license <a href="%s" target="_blank">in the customer portal</a>. Renew your license within 30 days after license expiration to get a discount.','woothemes'),admin_url("admin.php?page=infusedwoo-menu-2&submenu=update"),$remote_ver,'https://infusedaddons.com/portal').'</p></div>';}}}}$activation_proceed=get_option('infusedwoo_activate');if($activation_proceed){add_action('iwpro_ready','iwpro_auto_activate');delete_option('infusedwoo_activate');} ?>